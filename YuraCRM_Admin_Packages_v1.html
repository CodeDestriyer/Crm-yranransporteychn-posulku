<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>YuraCRM Посилки v1</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1a3a5e;
            --primary-dark: #0d1f3c;
            --accent: #d90d0d;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --purple: #8b5cf6;
            --orange: #f97316;
            --pink: #ec4899;
            --teal: #14b8a6;
            --bg-main: #f5f7fa;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border: #e2e8f0;
            --shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Montserrat', sans-serif; background: var(--bg-main); color: var(--text-primary); min-height: 100vh; }

        /* HEADER */
        .header { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); padding: 10px 12px; position: sticky; top: 0; z-index: 100; }
        .header-top { display: flex; align-items: center; gap: 10px; }
        .burger-btn { display: none; width: 32px; height: 32px; background: rgba(255,255,255,0.15); border: none; border-radius: 6px; color: white; font-size: 18px; cursor: pointer; align-items: center; justify-content: center; }
        .logo { font-size: 13px; font-weight: 800; color: white; white-space: nowrap; }
        .logo span { color: var(--accent); }
        .search-box { flex: 1; position: relative; }
        .search-input { width: 100%; padding: 8px 12px 8px 32px; border: none; border-radius: 6px; background: rgba(255,255,255,0.15); color: white; font-family: inherit; font-size: 12px; outline: none; }
        .search-input::placeholder { color: rgba(255,255,255,0.6); }
        .search-input:focus { background: rgba(255,255,255,0.25); }
        .search-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); font-size: 12px; opacity: 0.7; }
        .header-right { display: flex; align-items: center; gap: 10px; margin-left: auto; }
        .role-badge { background: rgba(255,255,255,0.2); color: white; padding: 4px 10px; border-radius: 12px; font-size: 10px; font-weight: 600; display: none; }
        .user-avatar { width: 30px; height: 30px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 11px; flex-shrink: 0; cursor: pointer; }

        /* MAIN LAYOUT with PC SIDEBAR */
        .main-layout { display: flex; min-height: calc(100vh - 52px); }
        
        /* PC SIDEBAR - STICKY */
        .pc-sidebar { 
            width: 300px; 
            background: linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%); 
            border-right: none; 
            flex-shrink: 0; 
            overflow-y: auto; 
            display: block;
            position: sticky;
            top: 52px;
            height: calc(100vh - 52px);
            box-shadow: 4px 0 20px rgba(0,0,0,0.08);
        }
        .pc-sidebar-section { margin: 0; border-bottom: 1px solid var(--border); }
        .pc-sidebar-header { 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            padding: 14px 16px; 
            cursor: pointer; 
            background: white;
            transition: all 0.3s ease;
        }
        .pc-sidebar-header:hover { background: #f0f4f8; }
        .pc-sidebar-title { 
            font-size: 13px; 
            font-weight: 800; 
            color: var(--primary); 
            text-transform: uppercase; 
            letter-spacing: 0.8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .pc-sidebar-toggle { 
            font-size: 12px; 
            color: var(--text-secondary); 
            transition: transform 0.3s ease;
        }
        .pc-sidebar-header.collapsed .pc-sidebar-toggle { transform: rotate(-90deg); }
        .pc-sidebar-content { 
            padding: 10px 14px 14px; 
            background: #fafbfc;
            max-height: 500px;
            overflow: hidden;
            transition: max-height 0.4s ease, padding 0.3s ease, opacity 0.3s ease;
            opacity: 1;
        }
        .pc-sidebar-content.collapsed { 
            max-height: 0; 
            padding-top: 0;
            padding-bottom: 0;
            opacity: 0;
        }
        
        .pc-sidebar-item { 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            padding: 11px 14px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 13px; 
            font-weight: 600; 
            font-family: 'Montserrat', sans-serif;
            letter-spacing: 0.2px;
            color: var(--text-primary); 
            margin-bottom: 5px; 
            background: white;
            border: 1px solid transparent;
            transition: all 0.2s ease;
            box-shadow: 0 1px 2px rgba(0,0,0,0.04);
        }
        .pc-sidebar-item:hover { 
            border-color: var(--primary); 
            background: white;
            box-shadow: 0 3px 10px rgba(26, 58, 94, 0.12);
            transform: translateX(3px);
        }
        .pc-sidebar-item.active { 
            background: var(--primary); 
            color: white; 
            border-color: var(--primary);
            box-shadow: 0 3px 12px rgba(26, 58, 94, 0.3);
        }
        .pc-sidebar-item .item-icon { margin-right: 10px; font-size: 15px; }
        .pc-sidebar-item .item-text { 
            font-weight: 600;
            letter-spacing: 0.3px;
        }
        .pc-sidebar-item .item-count { 
            background: var(--bg-main); 
            color: var(--primary); 
            padding: 4px 12px; 
            border-radius: 12px; 
            font-size: 11px; 
            font-weight: 700;
            min-width: 32px;
            text-align: center;
        }
        .pc-sidebar-item.active .item-count { background: rgba(255,255,255,0.25); color: white; }
        .pc-sidebar-item.route { color: var(--success); font-weight: 600; }
        .pc-sidebar-item.route:hover { border-color: var(--success); }
        .pc-sidebar-item.route.active { background: var(--success); color: white; border-color: var(--success); }
        .pc-sidebar-item.optimize { color: var(--purple); font-weight: 600; }
        .pc-sidebar-item.optimize:hover { border-color: var(--purple); }
        .pc-sidebar-item.optimize.active { background: var(--purple); color: white; border-color: var(--purple); }
        .pc-sidebar-item.archive { color: #6b7280; font-weight: 600; }
        .pc-sidebar-item.archive:hover { border-color: #6b7280; }
        .pc-sidebar-item.archive.active { background: #6b7280; color: white; border-color: #6b7280; }
        .pc-sidebar-item.warning { color: var(--warning); font-weight: 600; }
        .pc-sidebar-item.warning:hover { border-color: var(--warning); }
        .pc-sidebar-item.warning .item-count { background: #fef3c7; color: var(--warning); }
        
        .pc-sidebar-calendar { background: white; border-radius: 8px; padding: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .pc-sidebar-add { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            padding: 11px; 
            border: 2px dashed var(--border); 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 12px; 
            font-weight: 700; 
            letter-spacing: 0.3px;
            color: var(--info); 
            margin-top: 8px;
            background: white;
            transition: all 0.2s ease;
        }
        .pc-sidebar-add:hover { border-color: var(--info); background: #eff6ff; }
        
        /* Main content area */
        .main-content-area { flex: 1; padding: 12px; overflow-y: auto; }

        /* DASHBOARD - Owner Only */
        .dashboard-panel {
            background: white;
            border-radius: 12px;
            margin-bottom: 16px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        .dashboard-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 18px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            cursor: pointer;
        }
        .dashboard-header:hover { opacity: 0.95; }
        .dashboard-title {
            font-size: 14px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .dashboard-toggle {
            font-size: 12px;
            transition: transform 0.3s;
        }
        .dashboard-header.collapsed .dashboard-toggle { transform: rotate(-90deg); }
        .dashboard-content {
            padding: 16px;
            max-height: 2000px;
            overflow: hidden;
            transition: max-height 0.4s ease, padding 0.3s ease, opacity 0.3s ease;
            opacity: 1;
        }
        .dashboard-content.collapsed {
            max-height: 0;
            padding: 0 16px;
            opacity: 0;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
        }
        .dashboard-card {
            background: var(--bg-main);
            border-radius: 10px;
            padding: 16px;
            border: 1px solid var(--border);
        }
        .dashboard-card-title {
            font-size: 12px;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        .dashboard-stat {
            text-align: center;
            padding: 12px 8px;
            background: white;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        .dashboard-stat-value {
            font-size: 24px;
            font-weight: 800;
            color: var(--primary);
        }
        .dashboard-stat-value.success { color: var(--success); }
        .dashboard-stat-value.warning { color: var(--warning); }
        .dashboard-stat-value.danger { color: var(--danger); }
        .dashboard-stat-label {
            font-size: 10px;
            color: var(--text-secondary);
            margin-top: 4px;
            font-weight: 600;
        }
        
        .dashboard-table {
            width: 100%;
            font-size: 12px;
            border-collapse: collapse;
        }
        .dashboard-table th {
            text-align: left;
            padding: 8px 10px;
            background: white;
            font-weight: 700;
            color: var(--primary);
            border-bottom: 2px solid var(--border);
        }
        .dashboard-table td {
            padding: 8px 10px;
            border-bottom: 1px solid var(--border);
        }
        .dashboard-table tr:hover td {
            background: rgba(26, 58, 94, 0.03);
        }
        .dashboard-table .text-right { text-align: right; }
        .dashboard-table .text-center { text-align: center; }
        .dashboard-table .font-bold { font-weight: 700; }
        
        .dashboard-alert {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 14px;
            background: white;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 4px solid var(--warning);
        }
        .dashboard-alert.danger { border-left-color: var(--danger); }
        
        /* Dashboard status items */
        .dashboard-statuses { display: flex; flex-direction: column; gap: 6px; }
        .dashboard-status-item { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            padding: 10px 12px; 
            background: white; 
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        .dashboard-status-item:hover { background: var(--bg-main); transform: translateX(4px); }
        .dashboard-status-item .status-icon { font-size: 16px; }
        .dashboard-status-item .status-name { flex: 1; font-size: 13px; font-weight: 600; }
        .dashboard-status-item .status-count { 
            font-size: 14px; 
            font-weight: 700; 
            background: var(--bg-main); 
            padding: 4px 10px; 
            border-radius: 12px; 
        }
        .dashboard-alert-text {
            font-size: 12px;
            font-weight: 600;
        }
        .dashboard-alert-count {
            font-size: 14px;
            font-weight: 800;
            color: var(--warning);
        }
        .dashboard-alert.danger .dashboard-alert-count { color: var(--danger); }

        /* SIDE MENU (Mobile) */
        .side-menu-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 200; }
        .side-menu-overlay.show { display: block; }
        .side-menu { 
            position: fixed; 
            top: 0; 
            left: -200px; 
            width: 200px; 
            height: 100%; 
            background: linear-gradient(180deg, #1e3a5f 0%, #0f2744 100%); 
            z-index: 201; 
            transition: left 0.3s ease; 
            display: flex; 
            flex-direction: column; 
            box-shadow: 4px 0 20px rgba(0,0,0,0.3);
        }
        .side-menu.open { left: 0; }
        .side-menu-header { 
            background: rgba(255,255,255,0.1); 
            color: white; 
            padding: 14px 12px; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .side-menu-title { font-size: 13px; font-weight: 700; }
        .side-menu-close { 
            background: rgba(255,255,255,0.15); 
            border: none; 
            color: white; 
            width: 26px; 
            height: 26px; 
            border-radius: 6px; 
            font-size: 14px; 
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .side-menu-close:hover { background: rgba(255,255,255,0.25); }
        .side-menu-content { flex: 1; overflow-y: auto; padding: 8px; }
        .side-menu-section { margin-bottom: 6px; }
        .side-menu-section-header { 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            padding: 10px 12px; 
            background: rgba(255,255,255,0.1); 
            border-radius: 8px; 
            cursor: pointer; 
            margin-bottom: 4px; 
            border: none;
            transition: all 0.2s ease;
        }
        .side-menu-section-header:hover { background: rgba(255,255,255,0.15); }
        .side-menu-section-title { font-size: 11px; font-weight: 600; color: white; }
        .section-toggle { font-size: 8px; color: rgba(255,255,255,0.6); transition: transform 0.2s; }
        .section-toggle.open { transform: rotate(180deg); }
        .side-menu-collapsible { display: none; }
        .side-menu-collapsible.open { display: block; }
        .side-menu-item { 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            padding: 10px 12px; 
            background: rgba(255,255,255,0.08); 
            border: none; 
            border-radius: 6px; 
            margin-bottom: 3px; 
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .side-menu-item:hover { 
            background: rgba(255,255,255,0.15); 
            transform: translateX(3px);
        }
        .side-menu-item.active { background: rgba(255,255,255,0.25); }
        .side-menu-item-left { 
            display: flex; 
            align-items: center; 
            gap: 6px; 
            font-size: 11px; 
            font-weight: 600; 
            color: white;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3));
        }
        .side-menu-item-count { 
            background: rgba(255,255,255,0.2); 
            color: white; 
            padding: 2px 6px; 
            border-radius: 8px; 
            font-size: 9px; 
            font-weight: 700; 
        }
        .side-menu-item.active .side-menu-item-count { background: rgba(255,255,255,0.4); }
        .side-menu-item.optimize { background: rgba(139,92,246,0.3); }
        .side-menu-item.optimize:hover, .side-menu-item.optimize.active { background: rgba(139,92,246,0.5); }
        .side-menu-item.route { background: rgba(34,197,94,0.3); }
        .side-menu-item.route:hover, .side-menu-item.route.active { background: rgba(34,197,94,0.5); }
        .side-menu-item.archive { background: rgba(107,114,128,0.3); }
        .side-menu-item.archive:hover, .side-menu-item.archive.active { background: rgba(107,114,128,0.5); }
        
        /* Календар в бургер меню - темна тема */
        .side-menu .calendar-box { background: rgba(255,255,255,0.05); border-radius: 8px; padding: 8px; }
        .side-menu .calendar-header { padding: 6px 0; }
        .side-menu .calendar-title { font-size: 11px; color: white; }
        .side-menu .calendar-nav button { 
            width: 24px; 
            height: 24px; 
            font-size: 10px; 
            background: rgba(255,255,255,0.1); 
            border: none; 
            color: white;
            border-radius: 4px;
        }
        .side-menu .calendar-nav button:hover { background: rgba(255,255,255,0.2); }
        .side-menu .calendar-weekdays { margin-bottom: 4px; }
        .side-menu .calendar-weekday { font-size: 8px; color: rgba(255,255,255,0.5); padding: 3px 0; }
        .side-menu .calendar-days { gap: 2px; }
        .side-menu .calendar-day { 
            height: 26px; 
            font-size: 10px; 
            background: rgba(255,255,255,0.08); 
            color: rgba(255,255,255,0.7);
            border-radius: 4px;
        }
        .side-menu .calendar-day:hover { background: rgba(255,255,255,0.15); }
        .side-menu .calendar-day.other-month { color: rgba(255,255,255,0.25); background: transparent; }
        .side-menu .calendar-day.today { border: 2px solid #60a5fa; background: rgba(96,165,250,0.2); }
        .side-menu .calendar-day.selected { background: #3b82f6; color: white; }
        .side-menu .calendar-day.has-leads { background: rgba(59,130,246,0.3); color: white; }
        .side-menu .calendar-day.overbooked { background: rgba(239,68,68,0.3) !important; border: 1px solid #ef4444 !important; }
        .side-menu .calendar-day-count { 
            font-size: 7px; 
            padding: 0 2px; 
            min-width: 10px; 
            top: 1px; 
            right: 1px;
            background: #3b82f6;
        }
        .side-menu .calendar-actions { margin-top: 6px; gap: 4px; }
        .side-menu .calendar-actions button { 
            padding: 6px; 
            font-size: 9px; 
            border: none;
        }
        .side-menu .calendar-actions .btn-clear { 
            background: rgba(255,255,255,0.1); 
            color: rgba(255,255,255,0.7); 
        }
        .side-menu .calendar-actions .btn-today { 
            background: #3b82f6; 
            color: white; 
        }

        /* CALENDAR */
        .calendar-box { background: white; border-radius: 8px; padding: 12px; }
        .calendar-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
        .calendar-title { font-size: 14px; font-weight: 700; color: var(--primary); }
        .calendar-nav { display: flex; gap: 4px; }
        .calendar-nav button { width: 30px; height: 30px; border: 1px solid var(--border); background: white; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .calendar-nav button:hover { background: var(--bg-main); }
        .calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; margin-bottom: 4px; }
        .calendar-weekday { font-size: 10px; font-weight: 700; color: var(--text-secondary); padding: 4px 0; }
        .calendar-days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }
        .calendar-day { position: relative; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; border-radius: 6px; cursor: pointer; background: var(--bg-main); color: var(--text-secondary); height: 32px; }
        .calendar-day:hover { background: var(--border); }
        .calendar-day.other-month { color: #cbd5e1; background: transparent; cursor: default; }
        .calendar-day.other-month:hover { background: transparent; }
        .calendar-day.today { border: 2px solid var(--primary); background: white; }
        .calendar-day.selected { background: var(--primary); color: white; }
        .calendar-day.has-leads { background: #dbeafe; color: var(--info); font-weight: 700; }
        .calendar-day.has-leads.selected { background: var(--primary); color: white; }
        .calendar-day-count { position: absolute; top: 1px; right: 2px; font-size: 8px; font-weight: 700; color: white; background: var(--accent); padding: 1px 3px; border-radius: 6px; line-height: 1; min-width: 12px; text-align: center; }
        .calendar-day.selected .calendar-day-count { background: rgba(255,255,255,0.9); color: var(--primary); }
        .calendar-day.overbooked { background: #fee2e2 !important; border: 2px solid #ef4444 !important; }
        .calendar-day.overbooked .calendar-day-count { background: #ef4444; }
        .calendar-day.overbooked.selected { background: #ef4444 !important; color: white; }
        .calendar-actions { display: flex; gap: 8px; margin-top: 10px; }
        .calendar-actions button { flex: 1; padding: 8px; border: none; border-radius: 4px; font-size: 11px; font-weight: 600; cursor: pointer; font-family: inherit; }
        .calendar-actions .btn-clear { background: var(--bg-main); color: var(--text-secondary); }
        .calendar-actions .btn-today { background: var(--primary); color: white; }

        /* MAIN */
        .main-content { padding: 10px; max-width: 1100px; margin: 0 auto; padding-bottom: 130px; }

        /* WORKFLOW BAR */
        .workflow-bar { background: white; border-radius: 8px; padding: 10px; margin-bottom: 10px; box-shadow: var(--shadow); }
        .workflow-row { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
        .workflow-left { display: flex; align-items: center; gap: 8px; }
        .checkbox-wrapper { display: flex; align-items: center; gap: 5px; cursor: pointer; }
        .checkbox-wrapper input { width: 16px; height: 16px; cursor: pointer; }
        .checkbox-wrapper label { font-size: 10px; font-weight: 600; color: var(--text-secondary); cursor: pointer; }
        .selected-info { font-size: 10px; color: var(--info); font-weight: 600; }
        .workflow-buttons { display: flex; gap: 6px; flex-wrap: wrap; margin-left: auto; }
        .dropdown-container { position: relative; }
        .wf-btn { display: flex; align-items: center; gap: 4px; padding: 7px 12px; border: 2px solid var(--border); border-radius: 6px; background: white; color: var(--text-primary); font-family: inherit; font-size: 11px; font-weight: 600; cursor: pointer; white-space: nowrap; }
        .wf-btn:hover { border-color: var(--primary); background: #f8fafc; }
        .wf-btn.active { border-color: var(--primary); background: var(--primary); color: white; }
        .wf-btn .count { background: var(--bg-main); color: var(--primary); padding: 2px 6px; border-radius: 8px; font-size: 10px; font-weight: 700; }
        .wf-btn.active .count { background: rgba(255,255,255,0.3); color: white; }
        .wf-btn.optimize { border-color: var(--purple); color: var(--purple); }
        .wf-btn.optimize:hover, .wf-btn.optimize.active { background: var(--purple); color: white; border-color: var(--purple); }
        .wf-btn.route { border-color: var(--success); color: var(--success); }
        .wf-btn.route:hover, .wf-btn.route.active { background: var(--success); color: white; border-color: var(--success); }
        .wf-btn.archive { border-color: #6b7280; color: #6b7280; }
        .wf-btn.archive:hover, .wf-btn.archive.active { background: #6b7280; color: white; border-color: #6b7280; }
        .dropdown-menu { position: absolute; top: calc(100% + 4px); left: 0; background: white; border-radius: 8px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); min-width: 280px; display: none; z-index: 300; padding: 10px; }
        .dropdown-menu.show { display: block; }
        .dropdown-item { padding: 10px 12px; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border); color: var(--text-primary); }
        .dropdown-item:last-child { border: none; }
        .dropdown-item:hover { background: var(--bg-main); }
        .dropdown-item .badge { font-size: 10px; color: white; background: var(--primary); padding: 2px 8px; border-radius: 10px; font-weight: 600; }

        /* OPTIMIZATION PANEL */
        .optimization-panel { display: none; background: linear-gradient(135deg, #f0e6ff, #e6f0ff); border: 2px solid var(--purple); border-radius: 8px; padding: 12px; margin-bottom: 10px; }
        .optimization-panel.show { display: block; }
        .opt-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
        .opt-title { font-size: 13px; font-weight: 700; color: var(--purple); }
        .opt-close { background: none; border: none; font-size: 18px; cursor: pointer; color: var(--text-secondary); }
        .opt-stats { display: flex; gap: 16px; margin-bottom: 12px; flex-wrap: wrap; }
        .opt-stat { text-align: center; }
        .opt-stat-value { font-size: 20px; font-weight: 700; color: var(--primary); }
        .opt-stat-label { font-size: 9px; color: var(--text-secondary); text-transform: uppercase; }
        .opt-actions { display: flex; gap: 8px; flex-wrap: wrap; }
        .opt-btn { padding: 10px 16px; border: none; border-radius: 6px; font-family: inherit; font-size: 12px; font-weight: 600; cursor: pointer; }
        .opt-btn.map { background: var(--info); color: white; }
        .opt-btn.confirm { background: var(--success); color: white; }

        /* CARDS - NEW DESIGN */
        .cards-list { display: flex; flex-direction: column; gap: 8px; }
        .lead-card { background: white; border-radius: 8px; box-shadow: var(--shadow); border-left: 4px solid var(--border); position: relative; }
        .lead-card:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.12); }
        .lead-card.status-new { border-left-color: var(--warning); }
        .lead-card.status-work { border-left-color: var(--info); }
        .lead-card.status-optimize { border-left-color: var(--purple); }
        .lead-card.status-route { border-left-color: var(--success); }
        .lead-card.status-archived { border-left-color: #6b7280; opacity: 0.7; }
        .lead-card.status-refused { border-left-color: var(--danger); background: #fef2f2; }
        .lead-card.status-transferred { border-left-color: var(--teal); background: #f0fdfa; }
        .lead-card.status-deleted { border-left-color: #9ca3af; background: #f3f4f6; opacity: 0.6; }
        .lead-card.selected { background: #f0f7ff; }
        
        /* Статуси водія */
        .lead-card.driver-completed { background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); border-left-color: #28a745; }
        .lead-card.driver-in-progress { background: linear-gradient(135deg, #cce5ff 0%, #b8daff 100%); border-left-color: #007bff; }
        .lead-card.driver-cancelled { background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%); border-left-color: #dc3545; }
        .lead-card.driver-archived { background: linear-gradient(135deg, #e2e3e5 0%, #d6d8db 100%); border-left-color: #6c757d; opacity: 0.8; }
        
        /* Badge статусу */
        .status-badge { padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 600; }
        .status-badge.pending { background: #e9ecef; color: #6c757d; }
        .status-badge.completed { background: #28a745; color: white; }
        .status-badge.in-progress { background: #007bff; color: white; }
        .status-badge.cancelled { background: #dc3545; color: white; }
        .status-badge.archived { background: #6c757d; color: white; }
        
        /* Номер в маршруті */
        .route-order-num { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; background: var(--primary); color: white; border-radius: 50%; font-size: 11px; font-weight: 700; }
        
        .card-header { display: flex; align-items: stretch; padding: 0; cursor: pointer; border-radius: 8px 8px 0 0; overflow: hidden; }
        .card-checkbox-wrap { display: flex; align-items: center; justify-content: center; padding: 10px 8px; background: var(--bg-main); border-right: 1px solid var(--border); flex-shrink: 0; }
        .card-checkbox { width: 18px; height: 18px; cursor: pointer; }
        
        .card-body { flex: 1; padding: 10px; display: flex; flex-direction: column; gap: 4px; min-width: 0; overflow: hidden; }
        .card-body:hover { background: #fafbfc; }
        
        /* Дозволяємо виділення тексту для копіювання */
        .card-phone, .card-id, .card-name, .card-route { 
            user-select: text; 
            cursor: text;
        }
        .card-phone:hover, .card-id:hover { 
            background: rgba(26, 58, 94, 0.1); 
            border-radius: 4px;
            padding: 1px 4px;
            margin: -1px -4px;
        }
        
        /* Row 1: Direction, Phone, Seats, Date, Price */
        .card-top-row { display: flex; align-items: center; gap: 5px; flex-wrap: wrap; min-height: 24px; }
        .card-direction { font-size: 11px; flex-shrink: 0; font-weight: 800; letter-spacing: 0.3px; background: linear-gradient(135deg, #1e40af, #7c3aed); color: white; padding: 3px 8px; border-radius: 6px; white-space: nowrap; }
        .card-direction.eu-ua { background: linear-gradient(135deg, #7c3aed, #1e40af); }
        .card-phone { font-size: 13px; font-weight: 700; color: var(--primary); letter-spacing: 0.3px; white-space: nowrap; display: inline-flex; align-items: center; gap: 3px; }
        .card-seats { background: var(--info); color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px; font-weight: 700; flex-shrink: 0; min-width: 36px; text-align: center; }
        .card-date { background: var(--bg-main); color: var(--text-primary); padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 600; flex-shrink: 0; white-space: nowrap; }
        .card-price { font-size: 13px; font-weight: 700; color: var(--success); flex-shrink: 0; }

        /* Copy button mini */
        .copy-btn-mini { display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; border: none; border-radius: 4px; background: transparent; color: var(--text-secondary); cursor: pointer; font-size: 10px; opacity: 0.4; transition: all 0.15s; padding: 0; flex-shrink: 0; }
        .copy-btn-mini:hover { opacity: 1; background: var(--primary); color: white; }
        .copy-btn-mini.copied { opacity: 1; background: var(--success); color: white; }

        /* Payment badges in header */
        .card-pay-badge { font-size: 9px; font-weight: 600; padding: 2px 6px; border-radius: 4px; flex-shrink: 0; white-space: nowrap; }
        .card-pay-badge.paid { background: #d1fae5; color: #065f46; }
        .card-pay-badge.unpaid { background: #fee2e2; color: #991b1b; }
        .card-pay-badge.neutral { background: #f1f5f9; color: #475569; }
        
        /* Row 2 wrapper */
        .card-row2-wrap { display: flex; flex-direction: column; gap: 3px; }
        
        /* Route row */
        .card-route-row { display: flex; align-items: center; min-height: 18px; }
        .card-route { font-size: 12px; font-weight: 600; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
        .card-route-arrow { color: var(--success); font-weight: 700; margin: 0 4px; }
        
        /* Info row: ID + Name */
        .card-info-row { display: flex; align-items: center; gap: 6px; min-height: 18px; }
        .card-id { font-size: 10px; color: var(--text-secondary); font-weight: 500; background: var(--bg-main); padding: 1px 4px; border-radius: 3px; flex-shrink: 0; }
        .card-name { font-size: 11px; color: var(--text-secondary); font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; }
        .new-tag { background: var(--accent); color: white; padding: 2px 5px; border-radius: 4px; font-size: 8px; font-weight: 700; text-transform: uppercase; flex-shrink: 0; }
        .order-num { background: var(--purple); color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 700; flex-shrink: 0; }
        
        /* Right section - Авто вгорі, кнопка внизу */
        .card-right-section { display: flex; flex-direction: column; align-items: center; justify-content: space-between; padding: 6px 10px; border-left: 1px solid var(--border); flex-shrink: 0; min-width: 75px; overflow: visible; position: relative; }
        .card-vehicle-badge { background: var(--info); color: white; padding: 4px 8px; border-radius: 4px; font-size: 9px; font-weight: 600; cursor: pointer; white-space: nowrap; text-align: center; }
        .card-vehicle-badge:hover { background: var(--primary); }
        .card-vehicle-badge.empty { background: var(--bg-main); color: var(--text-secondary); border: 1px dashed var(--text-secondary); }
        .card-vehicle-badge.empty:hover { background: var(--info); color: white; border-style: solid; }
        .card-actions-toggle { width: 28px; height: 28px; border: none; border-radius: 6px; background: var(--bg-main); cursor: pointer; font-size: 10px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; flex-shrink: 0; margin-top: auto; }
        .card-actions-toggle:hover { background: var(--primary); color: white; }
        .card-actions-toggle.open { background: var(--primary); color: white; transform: rotate(180deg); }
        
        /* Details panel */
        .card-details { display: none; padding: 12px; background: #f8fafc; border-top: 1px solid var(--border); }
        .card-details.show { display: block; }
        .details-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 8px; }
        .detail-item { background: white; padding: 8px 10px; border-radius: 6px; border: 1px solid var(--border); }
        .detail-label { display: block; font-size: 10px; color: var(--text-secondary); margin-bottom: 2px; }
        .detail-value { font-size: 12px; font-weight: 600; color: var(--text); word-break: break-word; }
        .detail-note { background: #fffbeb; padding: 10px; border-radius: 6px; margin-top: 10px; border: 1px solid #fef3c7; }
        .detail-note .detail-label { margin-bottom: 4px; }
        .card-expand-icon { font-size: 10px; color: var(--text-secondary); transition: transform 0.2s; }
        .lead-card.expanded .card-expand-icon { transform: rotate(180deg); }
        .detail-block { background: white; border: 1px solid var(--border); border-left: 3px solid var(--primary); border-radius: 6px; padding: 8px 10px; }
        .detail-block-label { font-size: 9px; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 2px; }
        .detail-block-value { font-size: 12px; font-weight: 600; color: var(--text-primary); word-break: break-word; }
        .detail-block-value.empty { color: var(--text-secondary); opacity: 0.5; }

        /* INLINE EDIT FIELDS */
        .inline-edit-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(155px, 1fr)); gap: 6px; }
        .inline-edit-field { background: white; border: 1px solid var(--border); border-radius: 8px; padding: 7px 10px; transition: all 0.2s; }
        .inline-edit-field:focus-within { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(26,58,94,0.08); }
        .inline-edit-label { font-size: 9px; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 3px; display: block; letter-spacing: 0.3px; }
        .inline-edit-input { width: 100%; border: none; outline: none; font-size: 12px; font-weight: 600; font-family: inherit; color: var(--text-primary); background: transparent; padding: 2px 0; }
        .inline-edit-input::placeholder { color: #cbd5e1; font-weight: 400; }

        /* MODERN SELECT DROPDOWN */
        .inline-edit-select { width: 100%; border: none; outline: none; font-size: 12px; font-weight: 600; font-family: inherit; color: var(--text-primary); background: transparent; padding: 2px 20px 2px 0; cursor: pointer; -webkit-appearance: none; -moz-appearance: none; appearance: none; }
        .inline-edit-select option { font-family: 'Montserrat', sans-serif; font-size: 13px; padding: 10px; font-weight: 500; }
        .inline-edit-field.select-field { position: relative; cursor: pointer; }
        .inline-edit-field.select-field::after { content: ''; position: absolute; right: 10px; bottom: 12px; width: 0; height: 0; border-left: 4px solid transparent; border-right: 4px solid transparent; border-top: 5px solid var(--primary); pointer-events: none; opacity: 0.6; }
        .inline-edit-field.select-field:hover { background: #f8fafc; }
        .inline-edit-field.select-field:hover::after { opacity: 1; }

        .inline-edit-field.saved { animation: fieldSaved 0.6s ease; }
        @keyframes fieldSaved { 0% { background: #d1fae5; border-color: var(--success); } 100% { background: white; border-color: var(--border); } }

        /* Quick save indicator */
        .inline-save-indicator { display: inline-flex; align-items: center; gap: 4px; font-size: 10px; color: var(--success); font-weight: 600; opacity: 0; transition: opacity 0.3s; margin-top: 6px; }
        .inline-save-indicator.show { opacity: 1; }

        /* EDITABLE HEADER MODE */
        .lead-card .card-header-edit { display: none; }
        .lead-card.details-open .card-header-display { display: none; }
        .lead-card.details-open .card-header-edit { display: flex; flex-direction: column; gap: 4px; flex: 1; padding: 8px 10px; min-width: 0; }
        .lead-card.details-open .card-header-edit .edit-row { display: flex; align-items: center; gap: 5px; flex-wrap: wrap; }
        .lead-card.details-open .card-header-edit .edit-field { border: 1px solid var(--border); border-radius: 5px; padding: 4px 8px; font-size: 12px; font-weight: 600; font-family: inherit; outline: none; background: white; min-width: 80px; }
        .lead-card.details-open .card-header-edit .edit-field:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(26,58,94,0.1); }
        .lead-card.details-open .card-header-edit .edit-field-wide { flex: 1; min-width: 150px; }
        .lead-card.details-open .card-body { pointer-events: none; }

        /* Section title in inline edit */
        .inline-section-title { font-size: 10px; font-weight: 800; color: var(--primary); text-transform: uppercase; letter-spacing: 0.5px; margin: 6px 0 2px; padding-bottom: 3px; border-bottom: 1px dashed var(--border); grid-column: 1 / -1; }
        
        /* Actions panel - 2x2 grid */
        .card-actions { display: none; padding: 10px 12px; background: white; border-top: 1px solid var(--border); }
        .card-actions.show { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
        .btn-card-action { padding: 10px 6px; border: none; border-radius: 6px; font-size: 11px; font-weight: 600; cursor: pointer; font-family: inherit; display: flex; align-items: center; justify-content: center; gap: 4px; }
        .btn-card-action.btn-delete { background: #fee2e2; color: #dc2626; }
        .btn-card-action.btn-delete:hover { background: #dc2626; color: white; }
        
        /* Route stats - адаптивна статистика */
        .route-stats-box { background: white; border-radius: 8px; padding: 12px; margin-bottom: 12px; box-shadow: var(--shadow); }
        .route-stats-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 4px; text-align: center; }
        .route-stat-item { cursor: pointer; padding: 8px 4px; border-radius: 8px; transition: all 0.2s ease; }
        .route-stat-item:hover { background: var(--bg-main); }
        .route-stat-item.active { background: var(--primary); color: white !important; }
        .route-stat-item.active.pending { background: #6c757d; }
        .route-stat-item.active.in-progress { background: #007bff; }
        .route-stat-item.active.completed { background: #28a745; }
        .route-stat-item.active.cancelled { background: #dc3545; }
        .route-stat-item.active.not-notified { background: #f97316; }
        .route-stat-num { font-size: 18px; font-weight: 700; }
        .route-stat-label { font-size: 9px; white-space: nowrap; }
        
        @media (max-width: 500px) {
            .route-stats-grid { grid-template-columns: repeat(3, 1fr); gap: 6px; }
            .route-stat-item { padding: 10px 6px; }
            .route-stat-num { font-size: 20px; }
            .route-stat-label { font-size: 10px; }
            /* Картки на мобільному */
            .card-top-row { flex-wrap: wrap; }
            .card-phone { min-width: auto; }
            .card-direction { width: auto; }
        }
        .btn-call { background: var(--primary); color: white; }
        .btn-msg { background: #7c3aed; color: white; }
        .btn-map { background: var(--info); color: white; }
        .btn-edit { background: var(--warning); color: white; }
        
        /* Vehicle badge - тільки відображення */
        .card-vehicle { }
        .card-vehicle-badge { background: var(--info); color: white; padding: 4px 8px; border-radius: 4px; font-size: 9px; font-weight: 600; white-space: nowrap; text-align: center; cursor: default; }
        .card-vehicle-badge.empty { background: var(--bg-main); color: var(--text-secondary); }
        
        /* DRAG HANDLE */
        .drag-handle { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 3px; cursor: grab; color: var(--text-secondary); opacity: 0.4; padding: 12px 8px; background: var(--bg-main); border-right: 1px solid var(--border); }
        .drag-handle:hover { opacity: 1; background: #e8eaed; }
        .drag-handle span { display: block; width: 14px; height: 2px; background: currentColor; border-radius: 1px; }
        .drag-handle:active { cursor: grabbing; }
        .lead-card.dragging { opacity: 0.5; transform: scale(1.02); }
        .lead-card.drag-over { border-top: 3px solid var(--success); margin-top: -3px; }

        /* BULK ACTIONS SIDEBAR - виїзна панель (червоно-бордова) */
        .bulk-actions-sidebar { 
            display: none; 
            position: fixed; 
            top: 52px; 
            left: 0; 
            bottom: 56px; 
            width: 220px; 
            background: linear-gradient(180deg, #7f1d1d 0%, #450a0a 100%); 
            z-index: 200; 
            box-shadow: 4px 0 20px rgba(0,0,0,0.3); 
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            overflow-y: auto;
        }
        .bulk-actions-sidebar.show { 
            display: flex; 
            flex-direction: column;
            transform: translateX(0);
        }
        .bulk-sidebar-header {
            padding: 16px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .bulk-sidebar-title {
            color: white;
            font-size: 14px;
            font-weight: 700;
        }
        .bulk-sidebar-count {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .bulk-sidebar-actions {
            flex: 1;
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .bulk-sidebar-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 14px;
            border: none;
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-family: inherit;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
        }
        .bulk-sidebar-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: translateX(4px);
        }
        .bulk-sidebar-btn:active {
            transform: scale(0.98);
        }
        /* Всі кнопки однакові - стильно */
        .bulk-sidebar-btn .btn-icon { 
            font-size: 18px; 
            width: 24px; 
            text-align: center;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.2));
        }
        .bulk-sidebar-divider {
            height: 1px;
            background: rgba(255,255,255,0.1);
            margin: 8px 0;
        }
        .bulk-sidebar-close {
            padding: 12px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .bulk-sidebar-close-btn {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            background: transparent;
            color: white;
            font-family: inherit;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .bulk-sidebar-close-btn:hover {
            background: rgba(255,255,255,0.1);
        }
        
        /* Стара панель - приховуємо на PC */
        @media (min-width: 1100px) {
            .bulk-actions-bar { display: none !important; }
        }
        
        /* Mobile styles */
        @media (max-width: 1099px) {
            /* Bulk actions sidebar - СПРАВА на мобільному */
            .bulk-actions-bar { display: none !important; }
            .bulk-actions-sidebar { 
                display: none; 
                position: fixed; 
                top: 52px; 
                right: 0; 
                left: auto;
                bottom: 56px; 
                width: 180px; 
                transform: translateX(100%);
                box-shadow: -4px 0 20px rgba(0,0,0,0.3);
            }
            .bulk-actions-sidebar.show { 
                display: flex; 
                transform: translateX(0);
            }
            .bulk-sidebar-header { padding: 12px; }
            .bulk-sidebar-title { font-size: 13px; }
            .bulk-sidebar-count { font-size: 11px; padding: 3px 8px; }
            .bulk-sidebar-actions { padding: 6px; gap: 3px; }
            .bulk-sidebar-btn { 
                padding: 10px 12px; 
                font-size: 12px; 
                border-radius: 6px;
            }
            .bulk-sidebar-btn .btn-icon { font-size: 14px; }
            .bulk-sidebar-divider { margin: 6px 0; }
            .bulk-sidebar-close { padding: 8px; }
            .bulk-sidebar-close-btn { padding: 10px; font-size: 12px; }
        }

        /* VEHICLE BADGE ON CARD */
        .card-vehicle { position: relative; }
        .card-vehicle-badge { background: var(--info); color: white; padding: 3px 8px; border-radius: 4px; font-size: 9px; font-weight: 600; cursor: pointer; white-space: nowrap; }
        .card-vehicle-badge:hover { background: var(--primary); }
        .card-vehicle-badge.empty { background: var(--border); color: var(--text-secondary); border: 1px dashed var(--text-secondary); }
        .card-vehicle-badge.empty:hover { background: var(--info); color: white; border-style: solid; }
        .vehicle-dropdown { position: absolute; top: calc(100% + 4px); right: 0; background: white; border-radius: 6px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); min-width: 130px; z-index: 50; overflow: hidden; display: none; }
        .vehicle-dropdown.show { display: block; }
        .vehicle-dropdown-item { padding: 8px 12px; font-size: 11px; cursor: pointer; border-bottom: 1px solid var(--border); }
        .vehicle-dropdown-item:last-child { border: none; }
        .vehicle-dropdown-item:hover { background: var(--bg-main); }
        .vehicle-dropdown-item.active { background: var(--info); color: white; }

        /* VEHICLE SELECT MODAL */
        .vehicle-select-list { display: flex; flex-direction: column; gap: 8px; }
        .vehicle-select-item { padding: 14px; border: 2px solid var(--border); border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: space-between; }
        .vehicle-select-item:hover { border-color: var(--info); background: #f0f7ff; }
        .vehicle-select-name { font-size: 13px; font-weight: 700; }
        .vehicle-select-info { font-size: 11px; color: var(--text-secondary); }

        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid var(--border); padding: 6px 10px; z-index: 100; display: flex; justify-content: space-around; }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 2px; padding: 5px 12px; border: none; background: none; font-family: inherit; font-size: 9px; color: var(--text-secondary); cursor: pointer; position: relative; }
        .nav-item.active { color: var(--accent); }
        .nav-item span:first-child { font-size: 18px; }

        /* DIRECTION POPUP */
        .direction-popup { position: fixed; bottom: 60px; left: 10px; background: white; border-radius: 12px; box-shadow: 0 -4px 20px rgba(0,0,0,0.15); padding: 8px; display: none; z-index: 150; min-width: 200px; }
        .direction-popup.show { display: block; }
        .direction-option { display: flex; align-items: center; gap: 10px; padding: 12px 14px; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600; color: var(--text-primary); }
        .direction-option:hover { background: var(--bg-main); }
        .direction-option.active { background: var(--primary); color: white; }
        .direction-option span:first-child { font-size: 16px; }
        .dir-count { margin-left: auto; background: rgba(0,0,0,0.1); padding: 2px 8px; border-radius: 10px; font-size: 11px; }
        .direction-option.active .dir-count { background: rgba(255,255,255,0.3); }

        /* MODALS */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 10px; }
        .modal-overlay.show { display: flex; }
        .modal { background: white; border-radius: 8px; width: 100%; max-width: 400px; max-height: 85vh; overflow: hidden; }
        .modal-header { background: var(--primary); color: white; padding: 10px 12px; display: flex; align-items: center; justify-content: space-between; }
        .modal-title { font-size: 13px; font-weight: 700; }
        .modal-close { background: rgba(255,255,255,0.2); border: none; color: white; width: 26px; height: 26px; border-radius: 4px; cursor: pointer; font-size: 14px; }
        .modal-body { padding: 12px; max-height: 60vh; overflow-y: auto; }
        .modal-footer { padding: 10px 12px; background: var(--bg-main); display: flex; justify-content: flex-end; gap: 6px; }
        .form-group { margin-bottom: 8px; }
        .form-group label { display: block; font-size: 9px; font-weight: 600; color: var(--text-secondary); margin-bottom: 2px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 7px; border: 2px solid var(--border); border-radius: 4px; font-size: 12px; font-family: inherit; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--primary); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
        .btn-cancel { padding: 7px 12px; background: white; border: 2px solid var(--border); border-radius: 4px; font-size: 10px; font-weight: 600; cursor: pointer; font-family: inherit; }
        .btn-save { padding: 7px 14px; background: var(--success); border: none; border-radius: 4px; color: white; font-size: 10px; font-weight: 700; cursor: pointer; font-family: inherit; }
        .columns-hint { background: #fffbeb; border-left: 2px solid var(--warning); padding: 6px 8px; border-radius: 4px; font-size: 9px; color: var(--text-secondary); margin-bottom: 10px; }
        .columns-section { margin-bottom: 12px; }
        .columns-section-title { font-size: 10px; font-weight: 700; color: var(--primary); margin-bottom: 5px; padding-bottom: 3px; border-bottom: 2px solid var(--primary); }
        .columns-list { display: flex; flex-direction: column; gap: 2px; }
        .column-item { display: flex; align-items: center; gap: 6px; padding: 6px 8px; background: var(--bg-main); border-radius: 4px; cursor: pointer; }
        .column-item:hover { background: var(--border); }
        .column-item input { width: 13px; height: 13px; }
        .column-item label { font-size: 10px; flex: 1; cursor: pointer; }
        .column-item.disabled { opacity: 0.4; pointer-events: none; }

        /* MAP MODAL */
        .map-options { display: flex; flex-direction: column; gap: 8px; }
        .map-option-btn { display: flex; align-items: center; gap: 12px; padding: 14px; border: 2px solid var(--border); border-radius: 8px; background: white; cursor: pointer; text-align: left; transition: all 0.2s; }
        .map-option-btn:hover { border-color: var(--primary); background: #f8fafc; }
        .map-option-btn.route { border-color: var(--success); background: #f0fdf4; }
        .map-option-btn.route:hover { background: var(--success); color: white; }
        .map-option-btn.route:hover .map-option-label { color: white; }
        .map-option-btn.route:hover .map-option-address { color: rgba(255,255,255,0.8); }
        .map-option-icon { font-size: 20px; }
        .map-option-text { display: flex; flex-direction: column; gap: 2px; flex: 1; min-width: 0; }
        .map-option-label { font-size: 12px; font-weight: 600; color: var(--text-primary); }
        .map-option-address { font-size: 11px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .toast { position: fixed; bottom: 120px; left: 50%; transform: translateX(-50%); background: var(--primary); color: white; padding: 10px 20px; border-radius: 6px; font-size: 11px; font-weight: 600; display: none; z-index: 2000; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .toast.show { display: block; }
        .empty-state { text-align: center; padding: 30px 15px; color: var(--text-secondary); }
        .empty-state-icon { font-size: 36px; margin-bottom: 8px; }
        
        /* Search highlight */
        .search-highlight { background: #fef08a; color: #000; padding: 0 2px; border-radius: 2px; }

        /* OPTIMIZE MODAL STYLES */
        .optimize-info { display: flex; align-items: center; gap: 10px; background: linear-gradient(135deg, #e3f2fd, #bbdefb); padding: 12px 16px; border-radius: 10px; margin-bottom: 16px; }
        .optimize-info-icon { font-size: 24px; }
        .optimize-info-text { font-size: 14px; color: #0d47a1; }
        .optimize-section { margin-bottom: 16px; }
        .optimize-label { display: block; font-weight: 600; margin-bottom: 8px; color: var(--text); font-size: 13px; }
        .optimize-radio-group { display: flex; flex-direction: column; gap: 8px; }
        .optimize-radio { display: flex; align-items: center; gap: 12px; padding: 12px 14px; border: 2px solid var(--border); border-radius: 10px; cursor: pointer; transition: all 0.2s; }
        .optimize-radio:hover { border-color: var(--primary); background: rgba(15,52,96,0.03); }
        .optimize-radio.selected { border-color: var(--primary); background: rgba(15,52,96,0.08); }
        .optimize-radio-icon { font-size: 20px; }
        .optimize-radio-text { display: flex; flex-direction: column; }
        .optimize-radio-text strong { font-size: 13px; color: var(--text); }
        .optimize-radio-text small { font-size: 11px; color: var(--text-secondary); }
        .optimize-input { width: 100%; padding: 10px 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 14px; background: var(--bg); color: var(--text); }
        .optimize-input:focus { outline: none; border-color: var(--primary); }
        .optimize-hint { display: block; font-size: 11px; color: var(--text-secondary); margin-top: 4px; }
        .optimize-method { background: #fff3e0; padding: 10px 14px; border-radius: 8px; font-size: 12px; color: #e65100; text-align: center; }
        
        .optimize-loading { text-align: center; padding: 30px; }
        .optimize-spinner { border: 3px solid var(--border); border-top: 3px solid var(--primary); border-radius: 50%; width: 36px; height: 36px; animation: spin 1s linear infinite; margin: 0 auto 12px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .optimize-loading-text { font-weight: 600; color: var(--primary); margin-bottom: 4px; }
        .optimize-loading small { color: var(--text-secondary); }
        
        /* Global Loader */
        .global-loader { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 9999; backdrop-filter: blur(4px); }
        .global-loader.show { display: flex; }
        .loader-box { background: white; padding: 30px 50px; border-radius: 16px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
        .loader-spinner { width: 50px; height: 50px; border: 4px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 16px; }
        .loader-text { font-weight: 600; color: var(--primary); font-size: 14px; }
        .loader-progress { font-size: 12px; color: var(--text-secondary); margin-top: 8px; }
        
        /* Capacity Alert - ненав'язливе сповіщення справа */
        .capacity-alert { position: fixed; top: 70px; right: 20px; background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); border: 2px solid #ef4444; border-radius: 12px; padding: 14px 18px; box-shadow: 0 4px 20px rgba(239,68,68,0.3); z-index: 500; max-width: 280px; animation: slideInRight 0.4s ease, pulse 2s ease-in-out infinite; cursor: pointer; }
        .capacity-alert:hover { transform: scale(1.02); }
        .capacity-alert-header { display: flex; align-items: center; gap: 8px; font-weight: 700; color: #dc2626; font-size: 13px; margin-bottom: 6px; }
        .capacity-alert-body { font-size: 12px; color: #7f1d1d; line-height: 1.4; }
        .capacity-alert-close { position: absolute; top: 8px; right: 10px; background: none; border: none; font-size: 16px; cursor: pointer; color: #dc2626; opacity: 0.6; }
        .capacity-alert-close:hover { opacity: 1; }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes pulse { 0%, 100% { box-shadow: 0 4px 20px rgba(239,68,68,0.3); } 50% { box-shadow: 0 4px 30px rgba(239,68,68,0.5); } }
        
        .optimize-result-header { font-size: 18px; font-weight: 700; color: var(--success); text-align: center; margin-bottom: 16px; }
        .optimize-stats { background: var(--card-bg); border: 1px solid var(--border); border-radius: 10px; padding: 14px; margin-bottom: 16px; }
        .optimize-stat-row { display: flex; justify-content: space-between; padding: 6px 0; font-size: 13px; border-bottom: 1px solid var(--border); }
        .optimize-stat-row:last-child { border-bottom: none; }
        .optimize-stat-label { color: var(--text-secondary); }
        .optimize-stat-value { font-weight: 600; color: var(--text); }
        
        .optimize-not-geocoded { background: #fff5f5; border: 1px solid #fecaca; border-radius: 10px; padding: 12px; margin-bottom: 16px; }
        .optimize-not-geocoded-title { font-size: 13px; font-weight: 600; color: #dc2626; margin-bottom: 8px; }
        .optimize-not-geocoded-list { font-size: 12px; color: #991b1b; }
        .optimize-not-geocoded-item { padding: 4px 0; border-bottom: 1px solid #fecaca; }
        .optimize-not-geocoded-item:last-child { border-bottom: none; }
        
        .optimize-map-links { display: flex; flex-direction: column; gap: 8px; }
        .optimize-map-btn { display: block; padding: 14px; background: linear-gradient(135deg, var(--primary), #1e4976); color: white; text-decoration: none; border-radius: 10px; text-align: center; font-weight: 700; font-size: 14px; transition: transform 0.2s; }
        .optimize-map-btn:hover { transform: scale(1.02); }
        
        .not-geocoded-card { border-left: 3px solid #dc2626 !important; background: #fff5f5 !important; }

        @media (max-width: 900px) {
            .burger-btn { display: flex; }
            .workflow-bar { display: none; }
            .search-box { max-width: none; }
            .pc-sidebar { display: none; }
        }

        /* SCANNER / CAMERA */
        .scanner-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #000; z-index: 2000; display: none; flex-direction: column; }
        .scanner-overlay.show { display: flex; }
        .scanner-top-bar { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; background: rgba(0,0,0,0.7); color: white; z-index: 10; }
        .scanner-title { font-size: 14px; font-weight: 700; }
        .scanner-close-btn { background: rgba(255,255,255,0.2); border: none; color: white; width: 36px; height: 36px; border-radius: 50%; font-size: 18px; cursor: pointer; }
        .scanner-video-wrap { flex: 1; position: relative; overflow: hidden; background: #111; display: flex; align-items: center; justify-content: center; }
        .scanner-video-wrap video { width: 100%; height: 100%; object-fit: cover; }
        .scanner-video-wrap canvas { display: none; }
        .scanner-guide { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); width: 280px; height: 180px; border: 3px solid rgba(255,255,255,0.6); border-radius: 12px; pointer-events: none; }
        .scanner-guide::before { content: 'Наведіть на накладну'; position: absolute; bottom: -30px; left: 50%; transform: translateX(-50%); color: rgba(255,255,255,0.7); font-size: 12px; font-weight: 600; white-space: nowrap; }
        .scanner-bottom-bar { display: flex; align-items: center; justify-content: space-around; padding: 16px; background: rgba(0,0,0,0.85); z-index: 10; }
        .scanner-btn { display: flex; flex-direction: column; align-items: center; gap: 4px; background: none; border: none; color: white; font-size: 10px; font-weight: 600; cursor: pointer; font-family: inherit; padding: 8px 16px; border-radius: 10px; transition: all 0.2s; }
        .scanner-btn:hover, .scanner-btn:active { background: rgba(255,255,255,0.15); }
        .scanner-btn .btn-icon { font-size: 28px; }
        .scanner-btn.capture { background: white; color: #000; border-radius: 50%; width: 64px; height: 64px; padding: 0; justify-content: center; }
        .scanner-btn.capture .btn-icon { font-size: 24px; }
        .scanner-btn.capture:active { transform: scale(0.9); background: #ddd; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Scanner preview (after photo taken) */
        .scanner-preview { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: #000; display: none; flex-direction: column; z-index: 5; }
        .scanner-preview.show { display: flex; }
        .scanner-preview img { flex: 1; object-fit: contain; }
        .scanner-preview-actions { display: flex; gap: 12px; padding: 16px; background: rgba(0,0,0,0.85); justify-content: center; }
        .scanner-preview-btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 13px; font-weight: 700; cursor: pointer; font-family: inherit; display: flex; align-items: center; gap: 6px; }
        .scanner-preview-btn.retake { background: rgba(255,255,255,0.2); color: white; }
        .scanner-preview-btn.use { background: var(--success); color: white; }

        /* Add popup (choose manual or scanner) */
        .add-popup { position: fixed; bottom: 60px; right: 10px; background: white; border-radius: 12px; box-shadow: 0 -4px 30px rgba(0,0,0,0.2); padding: 8px; display: none; z-index: 150; min-width: 200px; }
        .add-popup.show { display: block; }
        .add-popup-option { display: flex; align-items: center; gap: 10px; padding: 14px 16px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; color: var(--text-primary); border: none; background: none; width: 100%; text-align: left; font-family: inherit; transition: all 0.2s; }
        .add-popup-option:hover { background: var(--bg-main); }
        .add-popup-option span:first-child { font-size: 20px; }
        .add-popup-option small { display: block; font-size: 10px; color: var(--text-secondary); font-weight: 400; margin-top: 2px; }

        @media (min-width: 901px) {
            .side-menu, .side-menu-overlay { display: none !important; }
            .header { padding: 12px 20px; }
            .logo { font-size: 15px; }
            .search-box { max-width: 300px; }
            .role-badge { display: block; }
            .main-content-area { padding: 16px 24px; padding-bottom: 130px; }
            .card-name { font-size: 14px; }
            .card-extra, .card-extra2 { font-size: 11px; }
            .card-route { font-size: 12px; }
            .card-price { font-size: 15px; }
            .details-grid { grid-template-columns: repeat(4, 1fr); }
            .card-actions.show { grid-template-columns: repeat(4, 1fr); }
            .workflow-bar { display: none; }
        }
    </style>
</head>
<body>

<!-- SIDE MENU -->
<div class="side-menu-overlay" id="sideMenuOverlay" onclick="closeSideMenu()"></div>
<div class="side-menu" id="sideMenu">
    <div class="side-menu-header">
        <span class="side-menu-title">📦 Посилки</span>
        <button class="side-menu-close" onclick="closeSideMenu()">×</button>
    </div>
    <div class="side-menu-content">
        <!-- Напрямок -->
        <div class="side-menu-section">
            <div class="side-menu-section-header" onclick="toggleMobileSection('direction')">
                <span class="side-menu-section-title">🧭 Напрямок</span>
                <span class="section-toggle" id="toggleDirection">▼</span>
            </div>
            <div class="side-menu-collapsible" id="mobileDirectionSection">
                <div class="side-menu-item" id="mobileDirectionAll" onclick="setDirection('all'); closeSideMenu();">
                    <span class="side-menu-item-left">📊 Всі напрямки</span>
                    <span class="side-menu-item-count" id="mobileCountAll">0</span>
                </div>
                <div class="side-menu-item" id="mobileNewLeads" onclick="showNewLeads(); closeSideMenu();" style="background:rgba(249,115,22,0.15);">
                    <span class="side-menu-item-left">🆕 Нові (24 год)</span>
                    <span class="side-menu-item-count" id="mobileCountNew" style="background:var(--accent);color:white;">0</span>
                </div>
                <div class="side-menu-item" id="mobileDirectionUaEu" onclick="setDirection('ua-eu'); closeSideMenu();">
                    <span class="side-menu-item-left">🇺🇦→🇪🇺 Україна → Європа</span>
                    <span class="side-menu-item-count" id="mobileCountUaEu">0</span>
                </div>
                <div class="side-menu-item" id="mobileDirectionEuUa" onclick="setDirection('eu-ua'); closeSideMenu();">
                    <span class="side-menu-item-left">🇪🇺→🇺🇦 Європа → Україна</span>
                    <span class="side-menu-item-count" id="mobileCountEuUa">0</span>
                </div>
            </div>
        </div>
        
        <!-- Дати - Календар -->
        <div class="side-menu-section">
            <div class="side-menu-section-header" onclick="toggleMobileSection('dates')">
                <span class="side-menu-section-title">📅 Дата виїзду</span>
                <span class="section-toggle" id="toggleDates">▼</span>
            </div>
            <div class="side-menu-collapsible" id="mobileDatesSection">
                <div class="calendar-box" id="mobileCalendar"></div>
            </div>
        </div>
        
        <!-- Авто -->
        <div class="side-menu-section">
            <div class="side-menu-section-header" onclick="toggleMobileSection('vehicles')">
                <span class="side-menu-section-title">🚐 Автомобіль</span>
                <span class="section-toggle" id="toggleVehicles">▼</span>
            </div>
            <div class="side-menu-collapsible" id="mobileVehiclesSection">
                <div class="side-menu-item" style="border-color:var(--warning);color:var(--warning);" onclick="mobileSetVehicle('none')">
                    <span class="side-menu-item-left">❓ Без авто</span>
                    <span class="side-menu-item-count" id="mobileCountNoVehicle">0</span>
                </div>
                <div id="mobileVehiclesList"></div>
                <div class="side-menu-item" onclick="openAddVehicleModal(); closeSideMenu();" style="color:var(--info);font-weight:600;border-top:1px solid var(--border);margin-top:8px;">
                    <span class="side-menu-item-left">➕ Додати авто</span>
                </div>
            </div>
        </div>
        
        <!-- Маршрути -->
        <div class="side-menu-section">
            <div class="side-menu-section-header" onclick="toggleMobileSection('routes')">
                <span class="side-menu-section-title">🚀 Маршрути</span>
                <span class="section-toggle" id="toggleRoutes">▼</span>
            </div>
            <div class="side-menu-collapsible" id="mobileRoutesSection">
                <div class="side-menu-item" onclick="showAllRoutes(); closeSideMenu();">
                    <span class="side-menu-item-left">📋 Всі маршрути</span>
                    <span class="side-menu-item-count" id="mobileCountRoute">0</span>
                </div>
                <div id="mobileRoutesList"></div>
            </div>
        </div>
        
        <!-- Дії -->
        <div class="side-menu-section">
            <div class="side-menu-section-header" onclick="toggleMobileSection('actions')">
                <span class="side-menu-section-title">📋 Статуси</span>
                <span class="section-toggle" id="toggleActions">▼</span>
            </div>
            <div class="side-menu-collapsible" id="mobileActionsSection">
                <div class="side-menu-item" onclick="showStatusFilter('archived'); closeSideMenu();">
                    <span class="side-menu-item-left">📦 Архів</span>
                    <span class="side-menu-item-count" id="mobileCountArchive">0</span>
                </div>
                <div class="side-menu-item" onclick="showStatusFilter('refused'); closeSideMenu();">
                    <span class="side-menu-item-left">❌ Відмови</span>
                    <span class="side-menu-item-count" id="mobileCountRefused">0</span>
                </div>
                <div class="side-menu-item" onclick="showStatusFilter('transferred'); closeSideMenu();">
                    <span class="side-menu-item-left">📆 Перенос</span>
                    <span class="side-menu-item-count" id="mobileCountTransferred">0</span>
                </div>
                <div class="side-menu-item" onclick="showStatusFilter('deleted'); closeSideMenu();">
                    <span class="side-menu-item-left">🗑️ Видалені</span>
                    <span class="side-menu-item-count" id="mobileCountDeleted">0</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- HEADER -->
<header class="header">
    <div class="header-top">
        <button class="burger-btn" onclick="openSideMenu()">☰</button>
        <div class="logo">YURA<span>TRANSPORTATION</span> 📦</div>
        <div class="search-box">
            <span class="search-icon">🔍</span>
            <input type="text" class="search-input" id="searchInput" placeholder="Пошук посилок..." oninput="handleSearch()">
        </div>
        <div class="header-right">
            <span class="role-badge">📦 Посилки</span>
            <div class="user-avatar">Y</div>
        </div>
    </div>
</header>

<!-- MAIN LAYOUT with PC SIDEBAR -->
<div class="main-layout">
    <!-- PC SIDEBAR -->
    <aside class="pc-sidebar" id="pcSidebar">
        <!-- Напрямок -->
        <div class="pc-sidebar-section">
            <div class="pc-sidebar-header" onclick="togglePcSection('direction')">
                <span class="pc-sidebar-title"><span>🧭</span> Напрямок</span>
                <span class="pc-sidebar-toggle" id="pcToggleDirection">▼</span>
            </div>
            <div class="pc-sidebar-content" id="pcSectionDirection">
                <div class="pc-sidebar-item" id="pcDirectionAll" onclick="setDirection('all')">
                    <span><span class="item-icon">📊</span>Всі посилки</span>
                    <span class="item-count" id="pcCountAll">0</span>
                </div>
                <div class="pc-sidebar-item" id="pcNewLeads" onclick="showNewLeads()" style="background:rgba(249,115,22,0.1);">
                    <span><span class="item-icon">🆕</span>Нові (24 год)</span>
                    <span class="item-count" id="pcCountNew" style="background:var(--accent);color:white;">0</span>
                </div>
                <div class="pc-sidebar-item" id="pcDirectionUaEu" onclick="setDirection('ua-eu')">
                    <span><span class="item-icon">🇺🇦→🇪🇺</span>Україна → Європа</span>
                    <span class="item-count" id="pcCountUaEu">0</span>
                </div>
                <div class="pc-sidebar-item" id="pcDirectionEuUa" onclick="setDirection('eu-ua')">
                    <span><span class="item-icon">🇪🇺→🇺🇦</span>Європа → Україна</span>
                    <span class="item-count" id="pcCountEuUa">0</span>
                </div>
            </div>
        </div>
        
        <!-- Дата -->
        <div class="pc-sidebar-section">
            <div class="pc-sidebar-header collapsed" onclick="togglePcSection('date')">
                <span class="pc-sidebar-title"><span>📅</span> Дата відправки</span>
                <span class="pc-sidebar-toggle" id="pcToggleDate">▼</span>
            </div>
            <div class="pc-sidebar-content collapsed" id="pcSectionDate">
                <div class="pc-sidebar-calendar" id="pcCalendar"></div>
            </div>
        </div>
        
        <!-- Автомобіль -->
        <div class="pc-sidebar-section">
            <div class="pc-sidebar-header collapsed" onclick="togglePcSection('vehicles')">
                <span class="pc-sidebar-title"><span>🚐</span> Автомобіль</span>
                <span class="pc-sidebar-toggle" id="pcToggleVehicles">▼</span>
            </div>
            <div class="pc-sidebar-content collapsed" id="pcSectionVehicles">
                <div class="pc-sidebar-item warning" id="pcVehicleNone" onclick="setVehicleFilter('none')">
                    <span><span class="item-icon">❓</span>Без авто</span>
                    <span class="item-count" id="pcCountNoVehicle">0</span>
                </div>
                <div id="pcVehiclesList"></div>
                <div class="pc-sidebar-add" onclick="openAddVehicleModal()">➕ Додати авто</div>
            </div>
        </div>
        
        <!-- Маршрути -->
        <div class="pc-sidebar-section">
            <div class="pc-sidebar-header collapsed" onclick="togglePcSection('routes')">
                <span class="pc-sidebar-title"><span>🚀</span> Маршрути</span>
                <span class="pc-sidebar-toggle" id="pcToggleRoutes">▼</span>
            </div>
            <div class="pc-sidebar-content collapsed" id="pcSectionRoutes">
                <div class="pc-sidebar-item route" id="pcRouteAll" onclick="showAllRoutes()">
                    <span><span class="item-icon">📋</span>Всі маршрути</span>
                    <span class="item-count" id="pcCountRoute">0</span>
                </div>
                <div id="pcRoutesList"></div>
            </div>
        </div>
        
        <!-- Дії -->
        <div class="pc-sidebar-section">
            <div class="pc-sidebar-header collapsed" onclick="togglePcSection('actions')">
                <span class="pc-sidebar-title"><span>📋</span> Статуси</span>
                <span class="pc-sidebar-toggle" id="pcToggleActions">▼</span>
            </div>
            <div class="pc-sidebar-content collapsed" id="pcSectionActions">
                <div class="pc-sidebar-item archive" id="pcArchive" onclick="showStatusFilter('archived')">
                    <span><span class="item-icon">📦</span>Архів</span>
                    <span class="item-count" id="pcCountArchive">0</span>
                </div>
                <div class="pc-sidebar-item" id="pcRefused" onclick="showStatusFilter('refused')">
                    <span><span class="item-icon">❌</span>Відмови</span>
                    <span class="item-count" id="pcCountRefused">0</span>
                </div>
                <div class="pc-sidebar-item" id="pcTransferred" onclick="showStatusFilter('transferred')">
                    <span><span class="item-icon">📆</span>Перенос</span>
                    <span class="item-count" id="pcCountTransferred">0</span>
                </div>
                <div class="pc-sidebar-item" id="pcDeleted" onclick="showStatusFilter('deleted')">
                    <span><span class="item-icon">🗑️</span>Видалені</span>
                    <span class="item-count" id="pcCountDeleted">0</span>
                </div>
            </div>
        </div>
    </aside>
    
    <!-- MAIN CONTENT AREA -->
    <main class="main-content-area">
        <!-- DASHBOARD - Owner Only -->
        <div class="dashboard-panel" id="dashboardPanel" data-access="owner">
            <div class="dashboard-header collapsed" onclick="toggleDashboard()">
                <span class="dashboard-title">📊 Дашборд посилок</span>
                <span class="dashboard-toggle" id="dashboardToggle">▼</span>
            </div>
            <div class="dashboard-content collapsed" id="dashboardContent">
                <div class="dashboard-grid">
                    <!-- Загальна статистика -->
                    <div class="dashboard-card">
                        <div class="dashboard-card-title">📈 Загальна статистика</div>
                        <div class="dashboard-stats">
                            <div class="dashboard-stat">
                                <div class="dashboard-stat-value" id="dashTotalOrders">0</div>
                                <div class="dashboard-stat-label">Всього посилок</div>
                            </div>
                            <div class="dashboard-stat">
                                <div class="dashboard-stat-value success" id="dashCompleted">0</div>
                                <div class="dashboard-stat-label">Виконано</div>
                            </div>
                            <div class="dashboard-stat">
                                <div class="dashboard-stat-value" id="dashTotalSeats">0</div>
                                <div class="dashboard-stat-label">Всього кг</div>
                            </div>
                            <div class="dashboard-stat">
                                <div class="dashboard-stat-value success" id="dashTotalSum">€0</div>
                                <div class="dashboard-stat-label">Загальна сума</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Потребують уваги -->
                    <div class="dashboard-card">
                        <div class="dashboard-card-title">⚠️ Потребують уваги</div>
                        <div class="dashboard-alert">
                            <span class="dashboard-alert-text">❓ Без авто</span>
                            <span class="dashboard-alert-count" id="dashNoVehicle">0</span>
                        </div>
                        <div class="dashboard-alert danger">
                            <span class="dashboard-alert-text">💰 Без оплати</span>
                            <span class="dashboard-alert-count" id="dashNoPayment">0</span>
                        </div>
                        <div class="dashboard-alert">
                            <span class="dashboard-alert-text">🔄 В роботі</span>
                            <span class="dashboard-alert-count" id="dashInWork">0</span>
                        </div>
                    </div>
                    
                    <!-- По авто -->
                    <div class="dashboard-card">
                        <div class="dashboard-card-title">🚐 Статистика по авто</div>
                        <table class="dashboard-table">
                            <thead>
                                <tr>
                                    <th>Авто</th>
                                    <th class="text-center">Посилок</th>
                                    <th class="text-center">Вага (кг)</th>
                                    <th class="text-right">Сума</th>
                                </tr>
                            </thead>
                            <tbody id="dashVehicleStats"></tbody>
                        </table>
                    </div>
                    
                    <!-- Постійні клієнти -->
                    <div class="dashboard-card">
                        <div class="dashboard-card-title">👥 Топ-10 клієнтів</div>
                        <table class="dashboard-table">
                            <thead>
                                <tr>
                                    <th>Клієнт</th>
                                    <th class="text-center">Посилок</th>
                                    <th class="text-center">Вага (кг)</th>
                                    <th class="text-right">Сума</th>
                                </tr>
                            </thead>
                            <tbody id="dashTopClients"></tbody>
                        </table>
                    </div>
                    
                    <!-- Статуси заявок -->
                    <div class="dashboard-card">
                        <div class="dashboard-card-title">📋 Статуси заявок</div>
                        <div class="dashboard-statuses">
                            <div class="dashboard-status-item" onclick="showStatusFilter('archived')" style="cursor:pointer;">
                                <span class="status-icon">📦</span>
                                <span class="status-name">Архів</span>
                                <span class="status-count" id="dashArchived">0</span>
                            </div>
                            <div class="dashboard-status-item" onclick="showStatusFilter('refused')" style="cursor:pointer;color:var(--danger);">
                                <span class="status-icon">❌</span>
                                <span class="status-name">Відмови</span>
                                <span class="status-count" id="dashRefused">0</span>
                            </div>
                            <div class="dashboard-status-item" onclick="showStatusFilter('transferred')" style="cursor:pointer;color:var(--teal);">
                                <span class="status-icon">📆</span>
                                <span class="status-name">Перенос</span>
                                <span class="status-count" id="dashTransferred">0</span>
                            </div>
                            <div class="dashboard-status-item" onclick="showStatusFilter('deleted')" style="cursor:pointer;color:#6b7280;">
                                <span class="status-icon">🗑️</span>
                                <span class="status-name">Видалені</span>
                                <span class="status-count" id="dashDeleted">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="workflow-bar">
            <div class="workflow-row">
                <div class="workflow-left">
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                        <label for="selectAll">Всі</label>
                    </div>
                    <span class="selected-info" id="selectedInfo"></span>
                </div>
                <div class="workflow-buttons">
                    <button class="wf-btn" onclick="resetFilters()">📊 Всі <span class="count" id="countAll">0</span></button>
                    <div class="dropdown-container">
                        <button class="wf-btn" id="btnDate" onclick="toggleDropdown('dateDropdown')">📅 <span id="dateLabel">Дата</span> <span class="count" id="dateCount" style="display:none">0</span> ▼</button>
                        <div class="dropdown-menu" id="dateDropdown">
                            <div id="desktopCalendar"></div>
                        </div>
                    </div>
                    <div class="dropdown-container">
                        <button class="wf-btn" id="btnVehicle" onclick="toggleDropdown('vehicleDropdown')">🚐 <span id="vehicleLabel">Авто</span> ▼</button>
                        <div class="dropdown-menu" id="vehicleDropdown" style="padding:0;">
                            <div class="dropdown-item" onclick="setVehicleFilter('')">Всі авто</div>
                            <div class="dropdown-item" onclick="setVehicleFilter('none')" style="color:var(--warning);">❓ Без авто <span class="badge" style="background:var(--warning);" id="countNoVehicle">0</span></div>
                            <div id="vehiclesList"></div>
                            <div class="dropdown-item" onclick="openAddVehicleModal()" style="color:var(--info);font-weight:600;border-top:1px solid var(--border);">➕ Додати авто</div>
                        </div>
                    </div>
                    <div class="dropdown-container">
                        <button class="wf-btn route" id="btnRoute" onclick="toggleDropdown('routeDropdown')">🚀 Маршрути <span class="count" id="countRoute">0</span> ▼</button>
                        <div class="dropdown-menu" id="routeDropdown" style="padding:0;">
                            <div class="dropdown-item" onclick="showAllRoutes()">📋 Всі маршрути</div>
                            <div id="routesList"></div>
                        </div>
                    </div>
                    <button class="wf-btn optimize" onclick="runOptimization()">⚡ Оптимізація</button>
                    <button class="wf-btn archive" id="btnArchive" onclick="toggleArchiveFilter()">📦 <span class="count" id="countArchive">0</span></button>
                </div>
            </div>
        </div>

        <div class="optimization-panel" id="optimizationPanel">
            <div class="opt-header">
                <div class="opt-title">⚡ Оптимізація</div>
                <button class="opt-close" onclick="closeOptimization()">×</button>
            </div>
            <div class="opt-stats">
                <div class="opt-stat"><div class="opt-stat-value" id="optLeads">0</div><div class="opt-stat-label">Посилок</div></div>
                <div class="opt-stat"><div class="opt-stat-value" id="optSeats">0</div><div class="opt-stat-label">Місць</div></div>
                <div class="opt-stat"><div class="opt-stat-value" id="optSum">€0</div><div class="opt-stat-label">Сума</div></div>
            </div>
            <div class="opt-actions">
                <button class="opt-btn map" onclick="openGoogleMaps()">🗺️ Карта</button>
                <button class="opt-btn confirm" onclick="confirmOptimization()">✅ В маршрут</button>
            </div>
        </div>

        <div class="cards-list" id="cardsList"></div>
    </main>
</div>

<!-- GLOBAL LOADER -->
<div class="global-loader" id="globalLoader">
    <div class="loader-box">
        <div class="loader-spinner"></div>
        <div class="loader-text" id="loaderText">Завантаження...</div>
        <div class="loader-progress" id="loaderProgress"></div>
    </div>
</div>

<!-- BULK ACTIONS SIDEBAR - PC версія (виїзна панель зліва) -->
<div class="bulk-actions-sidebar" id="bulkActionsSidebar">
    <div class="bulk-sidebar-header">
        <span class="bulk-sidebar-title">Дії</span>
        <span class="bulk-sidebar-count"><span id="bulkCountSidebar">0</span> вибрано</span>
    </div>
    <div class="bulk-sidebar-actions">
        <button class="bulk-sidebar-btn" onclick="selectAllVisible()">
            <span class="btn-icon">☑️</span> Вибрати всіх
        </button>
        <div class="bulk-sidebar-divider"></div>
        <button class="bulk-sidebar-btn" onclick="openBulkVehicleModal()">
            <span class="btn-icon">🚐</span> Призначити авто
        </button>
        <button class="bulk-sidebar-btn" onclick="bulkOptimize()">
            <span class="btn-icon">⚡</span> Оптимізація
        </button>
        <button class="bulk-sidebar-btn" onclick="bulkMoveToRoute()">
            <span class="btn-icon">🚀</span> В маршрут
        </button>
        <button class="bulk-sidebar-btn" onclick="bulkSetParcelStatus()">
            <span class="btn-icon">📋</span> Статус посилки
        </button>
        <button class="bulk-sidebar-btn" onclick="bulkSetSmsNote()">
            <span class="btn-icon">💬</span> Примітка СМС
        </button>
        <button class="bulk-sidebar-btn" onclick="bulkSetDateReceive()">
            <span class="btn-icon">📅</span> Дата отримання
        </button>
        <button class="bulk-sidebar-btn" id="btnSidebarNotify" onclick="bulkMarkNotified()" style="display:none;">
            <span class="btn-icon">🔔</span> Сповіщено
        </button>
        <div class="bulk-sidebar-divider"></div>
        <button class="bulk-sidebar-btn" onclick="bulkRefuse()">
            <span class="btn-icon">❌</span> Відмова
        </button>
        <button class="bulk-sidebar-btn" onclick="bulkTransfer()">
            <span class="btn-icon">📆</span> Перенос
        </button>
        <button class="bulk-sidebar-btn" onclick="bulkDelete()">
            <span class="btn-icon">🗑️</span> Видалити
        </button>
        <button class="bulk-sidebar-btn" onclick="bulkArchive()">
            <span class="btn-icon">📦</span> В архів
        </button>
        <div class="bulk-sidebar-divider"></div>
        <button class="bulk-sidebar-btn" id="btnSidebarRestore" onclick="bulkRestore()" style="display:none;">
            <span class="btn-icon">↩️</span> Відновити
        </button>
        <button class="bulk-sidebar-btn" id="btnSidebarDeleteForever" onclick="bulkDeleteForever()" style="display:none;">
            <span class="btn-icon">💀</span> Видалити назавжди
        </button>
    </div>
    <div class="bulk-sidebar-close">
        <button class="bulk-sidebar-close-btn" onclick="clearSelection()">
            <span>✕</span> Скасувати вибір
        </button>
    </div>
</div>

<!-- BULK ACTIONS BAR - Mobile версія -->
<div class="bulk-actions-bar" id="bulkActionsBar">
    <div class="bulk-actions-content">
        <span class="bulk-selected">Вибрано: <span id="bulkCount">0</span></span>
        <div class="bulk-buttons">
            <button class="bulk-btn select-all" onclick="selectAllVisible()">☑️ Всі</button>
            <button class="bulk-btn vehicle" onclick="openBulkVehicleModal()">🚐 Авто</button>
            <button class="bulk-btn optimize" onclick="bulkOptimize()">⚡</button>
            <button class="bulk-btn route" onclick="bulkMoveToRoute()">🚀</button>
            <button class="bulk-btn" onclick="bulkSetParcelStatus()" style="background:var(--info);">📋</button>
            <button class="bulk-btn" onclick="bulkSetSmsNote()" style="background:#7c3aed;">💬</button>
            <button class="bulk-btn" onclick="bulkSetDateReceive()" style="background:var(--success);">📅</button>
            <button class="bulk-btn notify" id="btnBulkNotify" onclick="bulkMarkNotified()" style="display:none;background:#f97316;">🔔</button>
            <button class="bulk-btn archive" id="btnBulkArchive" onclick="bulkArchive()">📦</button>
            <button class="bulk-btn restore" id="btnBulkRestore" onclick="bulkRestore()" style="display:none;background:var(--success);">↩️</button>
            <button class="bulk-btn cancel" onclick="clearSelection()">✕</button>
        </div>
    </div>
</div>

<!-- DIRECTION POPUP -->
<div class="direction-popup" id="directionPopup">
    <div class="direction-option active" data-dir="all" onclick="setDirection('all')">
        <span>📊</span> Всі <span class="dir-count" id="countDirAll">0</span>
    </div>
    <div class="direction-option" data-dir="ua-eu" onclick="setDirection('ua-eu')">
        <span>🇺🇦→🇪🇺</span> Україна-Європа <span class="dir-count" id="countDirUaEu">0</span>
    </div>
    <div class="direction-option" data-dir="eu-ua" onclick="setDirection('eu-ua')">
        <span>🇪🇺→🇺🇦</span> Європа-Україна <span class="dir-count" id="countDirEuUa">0</span>
    </div>
</div>

<nav class="bottom-nav">
    <button class="nav-item active" id="navPackages" onclick="toggleDirectionPopup()">
        <span>📦</span>
        <span id="navPackagesLabel">Посилки</span>
    </button>
    <button class="nav-item" onclick="showToast('👥 Пасажири — окрема CRM')"><span>👥</span>Пасажири</button>
    <button class="nav-item" onclick="syncWithSheets()"><span>🔄</span>Синхр.</button>
    <button class="nav-item" onclick="openColumnsModal()"><span>⚙️</span>Колонки</button>
    <button class="nav-item" onclick="toggleAddPopup()"><span>➕</span>Додати</button>
</nav>

<!-- ADD POPUP: Manual or Scanner -->
<div class="add-popup" id="addPopup">
    <button class="add-popup-option" onclick="closeAddPopup();openAddModal()">
        <span>📝</span>
        <div>Вручну<small>Заповнити форму самостійно</small></div>
    </button>
    <button class="add-popup-option" onclick="closeAddPopup();openScanner()">
        <span>📷</span>
        <div>Сканер<small>Камера → штрих-код, текст, фото</small></div>
    </button>
</div>

<!-- SCANNER FULLSCREEN -->
<div class="scanner-overlay" id="scannerOverlay">
    <div class="scanner-top-bar">
        <span class="scanner-title">📷 Сканер накладної</span>
        <button class="scanner-close-btn" onclick="closeScanner()">✕</button>
    </div>
    <div class="scanner-video-wrap">
        <video id="scannerVideo" autoplay playsinline muted></video>
        <canvas id="scannerCanvas"></canvas>
        <div class="scanner-guide"></div>
        <!-- Preview after capture -->
        <div class="scanner-preview" id="scannerPreview">
            <img id="scannerPreviewImg" src="" alt="Preview">
            <div class="scanner-preview-actions">
                <button class="scanner-preview-btn retake" onclick="retakePhoto()">🔄 Ще раз</button>
                <button class="scanner-preview-btn use" onclick="usePhoto()">✅ Використати</button>
            </div>
        </div>
    </div>
    <div class="scanner-bottom-bar">
        <button class="scanner-btn" onclick="switchCamera()">
            <span class="btn-icon">🔄</span>
            Камера
        </button>
        <button class="scanner-btn capture" onclick="capturePhoto()">
            <span class="btn-icon">📸</span>
        </button>
        <button class="scanner-btn" onclick="scanBarcode()">
            <span class="btn-icon">📊</span>
            Штрих-код
        </button>
    </div>
</div>

<!-- MODALS -->
<div class="modal-overlay" id="packageModal" onclick="if(event.target===this)closeModal('packageModal')">
    <div class="modal">
        <div class="modal-header"><span class="modal-title" id="packageModalTitle">📦 Додати посилку</span><button class="modal-close" onclick="closeModal('packageModal')">×</button></div>
        <div class="modal-body">
            <div class="form-group">
                <label>Напрямок</label>
                <select id="fDirection" style="background:var(--bg-main);">
                    <option value="ua-eu">🇺🇦→🇪🇺 Україна-Європа</option>
                    <option value="eu-ua">🇪🇺→🇺🇦 Європа-Україна</option>
                </select>
            </div>
            <div class="form-group"><label>ПіБ отримувача</label><input type="text" id="fName"></div>
            <div class="form-row"><div class="form-group"><label>Телефон отримувача</label><input type="tel" id="fPhone"></div><div class="form-group"><label>Тел. реєстратора</label><input type="tel" id="fPhoneReg"></div></div>
            <div class="form-group"><label>Адреса отримувача</label><input type="text" id="fAddress"></div>
            <div class="form-row"><div class="form-group"><label>Номер ТТН</label><input type="text" id="fTtn"></div><div class="form-group"><label>Вага (кг)</label><input type="text" id="fWeight"></div></div>
            <div class="form-row"><div class="form-group"><label>Сума €</label><input type="text" id="fAmount"></div><div class="form-group"><label>Статус оплати</label><select id="fPayStatus"><option value="">—</option><option value="Оплачено">Оплачено</option><option value="Неоплачено">Неоплачено</option><option value="Відправник">Відправник</option><option value="Отримувач">Отримувач</option></select></div></div>
            <div class="form-row"><div class="form-group"><label>Оплата</label><select id="fPayment"><option value="">—</option><option value="При отр гот">При отр гот</option><option value="При отр на карту">При отр на карту</option><option value="Відпр на карту">Відпр на карту</option><option value="Картка">Картка</option><option value="Готівка">Готівка</option></select></div><div class="form-group"><label>ВО</label><select id="fVo"><option value="">—</option><option value="Д">Д</option><option value="Ш">Ш</option><option value="Б">Б</option></select></div></div>
            <div class="form-row"><div class="form-group"><label>Авто</label><select id="fVehicle"><option value="">—</option></select></div><div class="form-group"><label>Статус посилки</label><select id="fParcelStatus"><option value="">—</option><option value="Невідомий">Невідомий</option><option value="Зареєстровано">Зареєстровано</option><option value="Оформлено">Оформлено</option><option value="Кордон">Кордон</option><option value="Доставка">Доставка</option></select></div></div>
            <div class="form-row"><div class="form-group"><label>Таймінг</label><input type="text" id="fTiming"></div><div class="form-group"><label>Дата оформлення</label><input type="date" id="fDateReg"></div></div>
            <div class="form-group"><label>Примітка</label><textarea id="fNote" rows="2"></textarea></div>
            <div class="form-group"><label>Примітка СМС</label><input type="text" id="fSmsNote"></div>
        </div>
        <div class="modal-footer"><button class="btn-cancel" onclick="closeModal('packageModal')">Скасувати</button><button class="btn-save" onclick="savePackage()">💾 Зберегти</button></div>
    </div>
</div>


<div class="modal-overlay" id="bulkVehicleModal" onclick="if(event.target===this)closeModal('bulkVehicleModal')">
    <div class="modal" style="max-width:400px">
        <div class="modal-header" style="background:linear-gradient(135deg,#1a3a5e,#0d1f3c);">
            <span class="modal-title" style="color:white;">🚐 Призначити авто</span>
            <button class="modal-close" style="color:white;" onclick="closeModal('bulkVehicleModal')">×</button>
        </div>
        <div class="modal-body">
            <div style="display:flex;align-items:center;gap:10px;background:linear-gradient(135deg,#e3f2fd,#bbdefb);padding:12px 16px;border-radius:10px;margin-bottom:16px;">
                <span style="font-size:24px;">📦</span>
                <span style="font-size:14px;color:#0d47a1;">Вибрано посилок: <strong id="bulkVehicleCount">0</strong></span>
            </div>
            <label style="font-size:13px;font-weight:600;color:var(--text-secondary);margin-bottom:10px;display:block;">Оберіть авто:</label>
            <div class="vehicle-select-list" id="bulkVehicleList" style="max-height:300px;overflow-y:auto;"></div>
        </div>
        <div class="modal-footer" style="display:flex;gap:8px;">
            <button class="btn-cancel" onclick="closeModal('bulkVehicleModal')">Скасувати</button>
            <button class="btn-save" id="bulkVehicleConfirmBtn" onclick="confirmBulkVehicle()" disabled style="opacity:0.5;">🚐 Призначити</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="columnsModal" onclick="if(event.target===this)closeModal('columnsModal')">
    <div class="modal" style="max-width:350px">
        <div class="modal-header"><span class="modal-title">⚙️ Колонки</span><button class="modal-close" onclick="closeModal('columnsModal')">×</button></div>
        <div class="modal-body">
            <div class="columns-hint">Якщо в заголовку — не в деталях</div>
            <div class="columns-section"><div class="columns-section-title">Заголовок</div><div class="columns-list" id="headerColList"></div></div>
            <div class="columns-section"><div class="columns-section-title">Деталі</div><div class="columns-list" id="detailsColList"></div></div>
        </div>
        <div class="modal-footer" style="display:flex;gap:8px;">
            <button class="btn-secondary" onclick="resetColumnsSettings()" style="flex:1;">🔄 Скинути</button>
            <button class="btn-save" onclick="saveColumnsSettings()" style="flex:1;">💾 Зберегти</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="mapModal" onclick="if(event.target===this)closeModal('mapModal')">
    <div class="modal" style="max-width:320px">
        <div class="modal-header"><span class="modal-title">🗺️ Карта</span><button class="modal-close" onclick="closeModal('mapModal')">×</button></div>
        <div class="modal-body">
            <p style="font-size:12px;color:var(--text-secondary);margin-bottom:12px;">Оберіть що переглянути:</p>
            <div class="map-options">
                <button class="map-option-btn" onclick="openMapLocation('from')">
                    <span class="map-option-icon">📍</span>
                    <span class="map-option-text">
                        <span class="map-option-label">Пункт відправки</span>
                        <span class="map-option-address" id="mapFromAddress">—</span>
                    </span>
                </button>
                <button class="map-option-btn" onclick="openMapLocation('to')">
                    <span class="map-option-icon">🏁</span>
                    <span class="map-option-text">
                        <span class="map-option-label">Пункт прибуття</span>
                        <span class="map-option-address" id="mapToAddress">—</span>
                    </span>
                </button>
                <button class="map-option-btn route" onclick="openMapLocation('route')">
                    <span class="map-option-icon">🛣️</span>
                    <span class="map-option-text">
                        <span class="map-option-label">Прокласти маршрут</span>
                        <span class="map-option-address" id="mapRouteAddress">—</span>
                    </span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- МОДАЛКА ДОДАТИ АВТО -->
<div class="modal-overlay" id="vehicleModal" onclick="if(event.target===this)closeModal('vehicleModal')">
    <div class="modal" style="max-width:340px">
        <div class="modal-header"><span class="modal-title">🚐 Нове авто</span><button class="modal-close" onclick="closeModal('vehicleModal')">×</button></div>
        <div class="modal-body">
            <div class="form-group">
                <label>Назва авто</label>
                <input type="text" id="vName" placeholder="Наприклад: А-Братислава">
            </div>
            <div class="form-group">
                <label>Ліміт ваги (кг)</label>
                <input type="number" id="vWeight" value="2000" min="1">
            </div>
            <div class="form-group">
                <label>Ліміт посилок (точок)</label>
                <input type="number" id="vPoints" value="60" min="1">
            </div>
            <div style="background:#fff3e0;padding:10px;border-radius:6px;font-size:11px;color:#e65100;margin-top:12px;">
                ⚠️ Попередження з'явиться при перевищенні ваги або кількості точок
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-cancel" onclick="closeModal('vehicleModal')">Скасувати</button>
            <button class="btn-save" onclick="saveVehicle()">💾 Створити</button>
        </div>
    </div>
</div>

<!-- МОДАЛКА ОПТИМІЗАЦІЇ -->
<div class="modal-overlay" id="optimizeModal" onclick="if(event.target===this)closeModal('optimizeModal')">
    <div class="modal" style="max-width:420px">
        <div class="modal-header">
            <span class="modal-title">🚀 Оптимізація маршруту</span>
            <button class="modal-close" onclick="closeModal('optimizeModal')">×</button>
        </div>
        <div class="modal-body" id="optimizeFormBody">
            <div class="optimize-info">
                <span class="optimize-info-icon">📦</span>
                <span class="optimize-info-text">Заявок для оптимізації: <strong id="optimizeCount">0</strong></span>
            </div>
            
            <div class="optimize-section">
                <label class="optimize-label">📋 Оптимізувати по:</label>
                <div class="optimize-radio-group">
                    <label class="optimize-radio selected" id="optFrom" onclick="selectOptimizeBy('from')">
                        <span class="optimize-radio-icon">📍</span>
                        <span class="optimize-radio-text">
                            <strong>Адреса ВІДПРАВНИКА</strong>
                            <small>де забирати посилки</small>
                        </span>
                    </label>
                    <label class="optimize-radio" id="optTo" onclick="selectOptimizeBy('to')">
                        <span class="optimize-radio-icon">🏁</span>
                        <span class="optimize-radio-text">
                            <strong>Адреса ОТРИМУВАЧА</strong>
                            <small>де доставляти посилки</small>
                        </span>
                    </label>
                </div>
            </div>
            
            <div class="optimize-section">
                <label class="optimize-label">📍 Точка старту:</label>
                <input type="text" class="optimize-input" id="optimizeStart" placeholder="Залиште пустим → Ужгород">
                <small class="optimize-hint">Звідки починається маршрут</small>
            </div>
            
            <div class="optimize-section">
                <label class="optimize-label">🏁 Точка закінчення:</label>
                <input type="text" class="optimize-input" id="optimizeEnd" placeholder="Залиште пустим → остання точка">
                <small class="optimize-hint">Де закінчується маршрут</small>
            </div>
            
            <div class="optimize-method">
                🗺️ Google Directions API + посилання на карту
            </div>
        </div>
        
        <!-- Результат оптимізації -->
        <div class="modal-body" id="optimizeResultBody" style="display:none">
            <div class="optimize-result-header">✅ Маршрут оптимізовано!</div>
            <div class="optimize-stats" id="optimizeStats"></div>
            <div class="optimize-not-geocoded" id="optimizeNotGeocoded" style="display:none">
                <div class="optimize-not-geocoded-title">⚠️ Не вдалось знайти адреси:</div>
                <div class="optimize-not-geocoded-list" id="optimizeNotGeocodedList"></div>
            </div>
            <div class="optimize-map-links" id="optimizeMapLinks"></div>
        </div>
        
        <!-- Завантаження -->
        <div class="modal-body" id="optimizeLoadingBody" style="display:none">
            <div class="optimize-loading">
                <div class="optimize-spinner"></div>
                <div class="optimize-loading-text">Оптимізація маршруту...</div>
                <small>Це може зайняти 10-30 секунд</small>
            </div>
        </div>
        
        <div class="modal-footer" id="optimizeFormFooter">
            <button class="btn-cancel" onclick="closeModal('optimizeModal')">Скасувати</button>
            <button class="btn-save" onclick="startOptimization()">🚀 Оптимізувати</button>
        </div>
        <div class="modal-footer" id="optimizeResultFooter" style="display:none">
            <button class="btn-save" onclick="closeModal('optimizeModal')">Закрити</button>
        </div>
    </div>
</div>

<div class="toast" id="toast"></div>

<script>
const ALL_COLUMNS = {
    name:{label:'ПіБ',group:'row1'},
    phone:{label:'Телефон отримувача',group:'row1'},
    weight:{label:'Вага',group:'row1'},
    ttn:{label:'Номер ТТН',group:'row1'},
    id:{label:'ІД',group:'row1'},
    address:{label:'Адреса отримувача',group:'row2'},
    vehicle:{label:'Авто',group:'row2'},
    dateReg:{label:'Дата оформлення',group:'meta'},
    amount:{label:'Сума €',group:'meta'},
    payStatus:{label:'Статус оплати',group:'meta'},
    payment:{label:'Оплата',group:'meta'},
    vo:{label:'ВО',group:'details'},
    number:{label:'Номер №',group:'details'},
    parcelStatus:{label:'Статус посилки',group:'details'},
    phoneReg:{label:'Тел. реєстратора',group:'details'},
    timing:{label:'Таймінг',group:'details'},
    dateReceive:{label:'Дата отримання',group:'details'},
    smsNote:{label:'Примітка СМС',group:'details'},
    note:{label:'Примітка',group:'details'},
    photo:{label:'Фото',group:'details'}
};

let colSettings = {header:['name','phone','weight','address','dateReg','amount','payStatus'],details:['ttn','vo','number','parcelStatus','payment','phoneReg','timing','dateReceive','smsNote','note']};
let packages = [];

let vehicles = [
    {id:'v1', name:'А-Братислава', maxWeight:2000, maxPoints:60},
    {id:'v2', name:'А-Нітра', maxWeight:2000, maxPoints:60},
    {id:'v3', name:'А-Словаччина', maxWeight:2000, maxPoints:60},
    {id:'v4', name:'А-Кошице+Прешов', maxWeight:2000, maxPoints:60}
];
let filters = {date:'',vehicle:'',search:'',showArchive:false,statusFilter:'',routeVehicle:'',direction:'all',specialStatus:'',statusDateFrom:'',statusDateTo:'',showNewOnly:true};
let selectedIds = new Set();
let editingId = null;
let openDetailsId = null;
let openActionsId = null;
let calendarDate = new Date(); // Поточна дата
let draggedId = null;
let undoHistory = []; // Історія для відміни дій

// INIT
document.addEventListener('DOMContentLoaded', () => {
    loadSettings();
    renderCalendars();
    
    // За замовчуванням показуємо нові ліди
    filters.showNewOnly = true;
    document.getElementById('pcNewLeads')?.classList.add('active');
    document.getElementById('mobileNewLeads')?.classList.add('active');
    const navLabel = document.getElementById('navPackagesLabel');
    if (navLabel) navLabel.textContent = '🆕 Нові';
    
    render();
    updateVehiclesList();
    updateAllCounts();
    
    // Перевірка перевищення місткості при завантаженні (з затримкою)
    setTimeout(() => checkAllCapacityWarnings(), 2000);
    
    // Періодична перевірка кожні 5 хвилин
    setInterval(() => checkAllCapacityWarnings(), 300000);
    
    // Тихе авто-оновлення кожні 60 секунд
    setInterval(() => silentSync(), 60000);
});

// Тиха синхронізація (без loader)
function silentSync() {
    // Не оновлюємо якщо відкрита модалка редагування
    if (document.getElementById('packageModal')?.classList.contains('show')) return;

    fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({ action: 'getAll' })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success && data.packages) {
            const oldCount = packages.length;
            const serverPackages = data.packages.map(p => {
                let normalizedStatus = (p.status || '').toString().toLowerCase().trim();

                return {
                    id: p.id || 'srv_' + p.rowNum,
                    name: p.name || '',
                    phone: p.phone || '',
                    phoneReg: p.phoneReg || '',
                    address: p.address || '',
                    vo: p.vo || '',
                    number: p.number || '',
                    ttn: p.ttn || '',
                    weight: p.weight || '',
                    amount: p.amount || '',
                    payStatus: p.payStatus || '',
                    payment: p.payment || '',
                    parcelStatus: p.parcelStatus || '',
                    vehicle: p.vehicle || '',
                    timing: p.timing || '',
                    dateReg: normalizeDate(p.dateReg),
                    dateReceive: normalizeDate(p.dateReceive),
                    smsNote: p.smsNote || '',
                    photo: p.photo || '',
                    note: p.note || '',
                    direction: p.direction,
                    status: normalizedStatus,
                    statusDate: p.dateArchive || '',
                    isNew: p.isNew,
                    isNew24h: p.isNew,
                    _sheet: p.sheet,
                    _rowNum: p.rowNum
                };
            });

            // Перевіряємо чи є нові ліди
            const hiddenStatuses = ['archived', 'refused', 'transferred', 'deleted'];
            const newCount = serverPackages.filter(p => p.isNew && !hiddenStatuses.includes(p.status)).length;
            const oldNewCount = packages.filter(p => p.isNew && !hiddenStatuses.includes(p.status)).length;

            packages = serverPackages;
            saveSettings();
            
            // Оновлюємо UI тільки якщо не в режимі маршруту
            if (filters.statusFilter !== 'route') {
                render();
                updateAllCounts();
                renderCalendars();
            }
            
            // Якщо з'явились нові ліди - сповіщаємо
            if (newCount > oldNewCount) {
                playNotificationSound();
                showToast(`🆕 Новий лід! (${newCount})`);
            }
        }
    })
    .catch(err => {
        console.log('Silent sync failed:', err);
    });
}

// Звук сповіщення для нових лідів
function playNotificationSound() {
    try {
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        
        oscillator.frequency.value = 800;
        oscillator.type = 'sine';
        gainNode.gain.value = 0.1;
        
        oscillator.start();
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
        oscillator.stop(audioCtx.currentTime + 0.3);
    } catch(e) {
        console.log('Sound not supported');
    }
}

function loadSettings() { try { const s = JSON.parse(localStorage.getItem('yuraCrmPackagesV1')||'{}'); if(s.colSettings)colSettings=s.colSettings; if(s.packages)packages=s.packages; if(s.columnLabels){Object.keys(s.columnLabels).forEach(k=>{if(ALL_COLUMNS[k])ALL_COLUMNS[k].label=s.columnLabels[k];});} } catch(e){} }
function saveSettings() { const columnLabels={}; Object.keys(ALL_COLUMNS).forEach(k=>{columnLabels[k]=ALL_COLUMNS[k].label;}); localStorage.setItem('yuraCrmPackagesV1', JSON.stringify({colSettings,packages,vehicles,columnLabels})); }

// SIDE MENU
function openSideMenu() { document.getElementById('sideMenu').classList.add('open'); document.getElementById('sideMenuOverlay').classList.add('show'); renderMobileCalendar(); updateMobileVehicles(); }
function closeSideMenu() { document.getElementById('sideMenu').classList.remove('open'); document.getElementById('sideMenuOverlay').classList.remove('show'); }

function toggleMobileSection(section) {
    const ids = {direction:'mobileDirectionSection',dates:'mobileDatesSection',vehicles:'mobileVehiclesSection',routes:'mobileRoutesSection',actions:'mobileActionsSection'};
    const toggles = {direction:'toggleDirection',dates:'toggleDates',vehicles:'toggleVehicles',routes:'toggleRoutes',actions:'toggleActions'};
    document.getElementById(ids[section])?.classList.toggle('open');
    document.getElementById(toggles[section])?.classList.toggle('open');
}

// PC Sidebar згортання
function togglePcSection(section) {
    const sectionMap = {
        direction: { content: 'pcSectionDirection', toggle: 'pcToggleDirection', header: null },
        date: { content: 'pcSectionDate', toggle: 'pcToggleDate', header: null },
        vehicles: { content: 'pcSectionVehicles', toggle: 'pcToggleVehicles', header: null },
        routes: { content: 'pcSectionRoutes', toggle: 'pcToggleRoutes', header: null },
        actions: { content: 'pcSectionActions', toggle: 'pcToggleActions', header: null }
    };
    
    const config = sectionMap[section];
    if (!config) return;
    
    const content = document.getElementById(config.content);
    const toggle = document.getElementById(config.toggle);
    const header = toggle?.parentElement;
    
    if (content) content.classList.toggle('collapsed');
    if (header) header.classList.toggle('collapsed');
}

// ============================================
// DASHBOARD - Owner Only
// ============================================
const USER_ACCESS = 'owner'; // 'owner' | 'admin' | 'dispatcher'

function toggleDashboard() {
    const content = document.getElementById('dashboardContent');
    const header = document.querySelector('.dashboard-header');
    content.classList.toggle('collapsed');
    header.classList.toggle('collapsed');
    
    // Оновлюємо дані при відкритті
    if (!content.classList.contains('collapsed')) {
        updateDashboard();
    }
}

function updateDashboard() {
    // Перевірка доступу (на майбутнє)
    if (USER_ACCESS !== 'owner') {
        document.getElementById('dashboardPanel').style.display = 'none';
        return;
    }
    
    const active = packages.filter(p => p.status !== 'archived');
    
    // 1. Загальна статистика
    const totalOrders = active.length;
    const completed = active.filter(p => p.status === 'route' || p.status === 'done').length;
    const totalSeats = active.reduce((sum, p) => sum + (parseFloat(p.weight) || 0), 0);
    const totalSum = active.reduce((sum, p) => {
        const amount = parseFloat(String(p.amount || '0').replace(/[^0-9.,]/g, '').replace(',', '.')) || 0;
        const payment = parseFloat(String(p.payment || '0').replace(/[^0-9.,]/g, '').replace(',', '.')) || 0;
        return sum + (amount || payment);
    }, 0);
    
    document.getElementById('dashTotalOrders').textContent = totalOrders;
    document.getElementById('dashCompleted').textContent = completed;
    document.getElementById('dashTotalSeats').textContent = totalSeats.toFixed(1) + ' кг';
    document.getElementById('dashTotalSum').textContent = '€' + totalSum.toFixed(0);
    
    // 2. Потребують уваги
    const noVehicle = active.filter(p => !p.vehicle).length;
    const noPayment = active.filter(p => !p.payment || p.payment === '' || p.payment === '0').length;
    const inWork = active.filter(p => p.status === 'work' || p.status === 'new').length;
    
    document.getElementById('dashNoVehicle').textContent = noVehicle;
    document.getElementById('dashNoPayment').textContent = noPayment;
    document.getElementById('dashInWork').textContent = inWork;
    
    // 3. Статистика по авто
    const vehicleStats = {};
    vehicles.forEach(v => {
        vehicleStats[v.id] = { name: v.name, orders: 0, seats: 0, sum: 0 };
    });
    
    active.forEach(p => {
        const veh = vehicles.find(v => v.id === p.vehicle || v.name === p.vehicle);
        if (veh && vehicleStats[veh.id]) {
            vehicleStats[veh.id].orders++;
            vehicleStats[veh.id].seats += parseFloat(p.weight) || 1;
            const payment = parseFloat(String(p.payment || '0').replace(/[^0-9.,]/g, '').replace(',', '.')) || 0;
            vehicleStats[veh.id].sum += payment;
        }
    });
    
    const vehicleStatsHtml = Object.values(vehicleStats)
        .filter(v => v.orders > 0)
        .sort((a, b) => b.sum - a.sum)
        .map(v => `
            <tr>
                <td class="font-bold">🚐 ${v.name}</td>
                <td class="text-center">${v.orders}</td>
                <td class="text-center">${v.seats.toFixed(1)} кг</td>
                <td class="text-right font-bold">€${v.sum.toFixed(0)}</td>
            </tr>
        `).join('') || '<tr><td colspan="4" style="text-align:center;color:var(--text-secondary);">Немає даних</td></tr>';
    
    document.getElementById('dashVehicleStats').innerHTML = vehicleStatsHtml;
    
    // 4. Топ клієнти (групування по телефону)
    const clientsMap = {};
    active.forEach(p => {
        const phone = (p.phone || '').replace(/\D/g, '');
        if (!phone) return;

        if (!clientsMap[phone]) {
            clientsMap[phone] = {
                phone: p.phone,
                name: p.name || 'Невідомий',
                parcels: 0,
                weight: 0,
                sum: 0
            };
        }
        clientsMap[phone].parcels++;
        clientsMap[phone].weight += parseFloat(p.weight) || 0;
        const amount = parseFloat(String(p.amount || '0').replace(/[^0-9.,]/g, '').replace(',', '.')) || 0;
        const payment = parseFloat(String(p.payment || '0').replace(/[^0-9.,]/g, '').replace(',', '.')) || 0;
        clientsMap[phone].sum += (amount || payment);
        if (p.name && p.name.length > clientsMap[phone].name.length) {
            clientsMap[phone].name = p.name;
        }
    });

    const topClients = Object.values(clientsMap)
        .sort((a, b) => b.parcels - a.parcels || b.weight - a.weight || b.sum - a.sum)
        .slice(0, 10);

    const clientsHtml = topClients.length > 0
        ? topClients.map(c => `
            <tr>
                <td>
                    <div class="font-bold">${c.name}</div>
                    <div style="font-size:10px;color:var(--text-secondary);">${c.phone}</div>
                </td>
                <td class="text-center font-bold">${c.parcels}</td>
                <td class="text-center font-bold">${c.weight.toFixed(1)} кг</td>
                <td class="text-right font-bold">€${c.sum.toFixed(0)}</td>
            </tr>
        `).join('')
        : '<tr><td colspan="4" style="text-align:center;color:var(--text-secondary);">Немає клієнтів</td></tr>';
    
    document.getElementById('dashTopClients').innerHTML = clientsHtml;
}

// CALENDAR
function renderCalendars() { renderCalendarTo('desktopCalendar'); renderMobileCalendar(); renderCalendarTo('pcCalendar'); }
function renderMobileCalendar() { renderCalendarTo('mobileCalendar'); }

function renderCalendarTo(containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;
    const year = calendarDate.getFullYear(), month = calendarDate.getMonth();
    const months = ['Січень','Лютий','Березень','Квітень','Травень','Червень','Липень','Серпень','Вересень','Жовтень','Листопад','Грудень'];
    const today = new Date().toISOString().split('T')[0];
    
    // Рахуємо кількість посилок на кожну дату ВІДПРАВКИ (dateReceive)
    const seatCounts = {};
    const leadCounts = {};
    packages.filter(p => p.status !== 'archived').forEach(p => {
        const shipDate = p.dateReceive || p.dateReg;
        if(shipDate) {
            leadCounts[shipDate] = (leadCounts[shipDate]||0) + 1;
            seatCounts[shipDate] = (seatCounts[shipDate]||0) + (parseFloat(p.weight) || 1);
        }
    });
    
    // Загальна місткість всіх авто
    const totalCapacity = vehicles.reduce((sum, v) => sum + (parseInt(v.maxPoints) || 60), 0);
    
    const firstDay = new Date(year, month, 1), lastDay = new Date(year, month + 1, 0);
    const startDay = (firstDay.getDay() + 6) % 7, daysInMonth = lastDay.getDate();
    const prevMonthLastDay = new Date(year, month, 0).getDate();
    let daysHtml = '';
    
    // Дні попереднього місяця (блідо)
    for (let i = startDay - 1; i >= 0; i--) {
        const day = prevMonthLastDay - i;
        daysHtml += `<div class="calendar-day other-month">${day}</div>`;
    }
    
    // Дні поточного місяця
    for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
        const count = leadCounts[dateStr] || 0;
        const seats = seatCounts[dateStr] || 0;
        const isOverbooked = seats > totalCapacity;
        let cls = 'calendar-day';
        if (dateStr === today) cls += ' today';
        if (dateStr === filters.date) cls += ' selected';
        if (count > 0) cls += ' has-leads';
        if (isOverbooked) cls += ' overbooked';
        const tooltip = isOverbooked ? `title="⚠️ ${seats}/${totalCapacity} місць"` : '';
        daysHtml += `<div class="${cls}" onclick="selectDate('${dateStr}')" ${tooltip}>${day}${count ? `<span class="calendar-day-count">${count}</span>` : ''}</div>`;
    }
    
    // Дні наступного місяця (блідо)
    const totalCells = startDay + daysInMonth;
    const remainder = totalCells % 7;
    if (remainder > 0) {
        for (let i = 1; i <= 7 - remainder; i++) {
            daysHtml += `<div class="calendar-day other-month">${i}</div>`;
        }
    }
    
    container.innerHTML = `
        <div class="calendar-header">
            <div class="calendar-nav"><button onclick="event.stopPropagation();changeMonth(-1)">◀</button></div>
            <div class="calendar-title">${months[month]} ${year}</div>
            <div class="calendar-nav"><button onclick="event.stopPropagation();changeMonth(1)">▶</button></div>
        </div>
        <div class="calendar-weekdays">
            <div class="calendar-weekday">Пн</div>
            <div class="calendar-weekday">Вт</div>
            <div class="calendar-weekday">Ср</div>
            <div class="calendar-weekday">Чт</div>
            <div class="calendar-weekday">Пт</div>
            <div class="calendar-weekday">Сб</div>
            <div class="calendar-weekday">Нд</div>
        </div>
        <div class="calendar-days">${daysHtml}</div>
        <div class="calendar-actions">
            <button class="btn-clear" onclick="event.stopPropagation();selectDate('')">Скинути</button>
            <button class="btn-today" onclick="event.stopPropagation();goToday()">Сьогодні</button>
        </div>
    `;
}

function changeMonth(delta) { calendarDate.setMonth(calendarDate.getMonth() + delta); renderCalendars(); }
function goToday() { calendarDate = new Date(); selectDate(new Date().toISOString().split('T')[0]); }
function selectDate(dateStr) { 
    filters.date = dateStr; 
    filters.statusFilter = ''; 
    renderCalendars(); 
    render(); 
    updateFilterButtons(); 
    updateVehiclesList(); 
    document.getElementById('dateDropdown')?.classList.remove('show');
    
    // Перевірка на перевищення місткості
    if (dateStr) {
        checkCapacityWarning(dateStr);
    }
}

// Перевірка місткості на дату (при виборі)
function checkCapacityWarning(dateStr) {
    const totalCapacity = vehicles.reduce((sum, v) => sum + (parseInt(v.maxPoints) || 60), 0);
    const seatsOnDate = packages
        .filter(p => p.dateReg === dateStr && p.status !== 'archived')
        .reduce((sum, p) => sum + (parseFloat(p.weight) || 1), 0);
    
    if (seatsOnDate > totalCapacity) {
        const dateFormatted = new Date(dateStr).toLocaleDateString('uk-UA');
        showCapacityWarning(dateFormatted, seatsOnDate, totalCapacity);
    }
}

// Перевірка всіх дат на перевищення (при завантаженні та періодично)
function checkAllCapacityWarnings() {
    const totalCapacity = vehicles.reduce((sum, v) => sum + (parseInt(v.maxPoints) || 60), 0);
    if (totalCapacity === 0) return;
    
    // Групуємо по датах
    const seatsByDate = {};
    packages.filter(p => p.status !== 'archived' && p.dateReg).forEach(p => {
        seatsByDate[p.dateReg] = (seatsByDate[p.dateReg] || 0) + (parseFloat(p.weight) || 1);
    });
    
    // Шукаємо перевищення (тільки майбутні дати)
    const today = new Date().toISOString().split('T')[0];
    const overbooked = [];
    
    for (const [date, seats] of Object.entries(seatsByDate)) {
        if (date >= today && seats > totalCapacity) {
            overbooked.push({ date, seats, diff: seats - totalCapacity });
        }
    }
    
    // Показуємо сповіщення якщо є перевищення
    if (overbooked.length > 0) {
        showCapacityAlert(overbooked, totalCapacity);
    }
}

// Ненав'язливе сповіщення справа
function showCapacityAlert(overbooked, capacity) {
    // Видаляємо старе якщо є
    document.getElementById('capacityAlert')?.remove();
    
    const dates = overbooked.slice(0, 5).map(o => {
        const d = new Date(o.date);
        return `<div><strong>${d.toLocaleDateString('uk-UA')}</strong>: ${o.seats}/${capacity} (+${o.diff})</div>`;
    }).join('');
    
    const moreText = overbooked.length > 5 ? `<div style="margin-top:4px;font-size:10px;">...ще ${overbooked.length - 5} дат</div>` : '';
    
    const alert = document.createElement('div');
    alert.className = 'capacity-alert';
    alert.id = 'capacityAlert';
    alert.innerHTML = `
        <button class="capacity-alert-close" onclick="event.stopPropagation();this.parentElement.remove()">✕</button>
        <div class="capacity-alert-header">⚠️ Перевищення місткості!</div>
        <div class="capacity-alert-body">
            ${dates}
            ${moreText}
            <div style="margin-top:8px;font-size:11px;opacity:0.8;">Натисніть для деталей</div>
        </div>
    `;
    alert.onclick = (e) => {
        if (e.target.classList.contains('capacity-alert-close')) return;
        alert.remove();
        // Показуємо першу дату з перевищенням
        const first = overbooked[0];
        const dateFormatted = new Date(first.date).toLocaleDateString('uk-UA');
        showCapacityWarning(dateFormatted, first.seats, capacity);
    };
    
    document.body.appendChild(alert);
    
    // Автоматично ховаємо через 5 секунд
    setTimeout(() => alert?.remove(), 5000);
}

// Показати детальне попередження (модалка)
function showCapacityWarning(date, seats, capacity) {
    const diff = seats - capacity;
    document.getElementById('capacityWarningModal')?.remove();
    
    const modal = document.createElement('div');
    modal.className = 'modal-overlay show';
    modal.id = 'capacityWarningModal';
    modal.innerHTML = `
        <div class="modal" style="max-width:400px;">
            <div class="modal-header" style="background:#fee2e2;border-bottom:1px solid #fecaca;">
                <span class="modal-title" style="color:#dc2626;">⚠️ Перевищення місткості!</span>
                <button class="modal-close" onclick="document.getElementById('capacityWarningModal').remove()">✕</button>
            </div>
            <div class="modal-body" style="text-align:center;padding:24px;">
                <div style="font-size:48px;margin-bottom:16px;">🚐💥</div>
                <div style="font-size:16px;font-weight:700;margin-bottom:8px;">На ${date}</div>
                <div style="font-size:14px;color:var(--text-secondary);margin-bottom:16px;">
                    Заброньовано <strong style="color:#dc2626;">${seats}</strong> місць<br>
                    Доступно <strong style="color:var(--success);">${capacity}</strong> місць
                </div>
                <div style="background:#fef3c7;padding:12px;border-radius:8px;font-size:13px;color:#92400e;">
                    <strong>+${diff}</strong> зайвих місць!<br>
                    Додайте авто або відмовте клієнту
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="document.getElementById('capacityWarningModal').remove()">Зрозуміло</button>
                <button class="btn-save" onclick="document.getElementById('capacityWarningModal').remove();openVehicleModal()">➕ Додати авто</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function updateMobileVehicles() {
    const el = document.getElementById('mobileVehiclesList');
    if (!el) return;
    el.innerHTML = vehicles.map(v => {
        const count = packages.filter(p => p.vehicle === v.id && p.status !== 'archived').length;
        const active = filters.vehicle === v.id;
        return `<div class="side-menu-item ${active?'active':''}" onclick="mobileSetVehicle('${v.id}')"><span class="side-menu-item-left">🚐 ${v.name}</span><span class="side-menu-item-count">${count}</span></div>`;
    }).join('');
}

function mobileFilterAll() { filters.date=''; filters.vehicle=''; filters.showArchive=false; filters.statusFilter=''; closeSideMenu(); render(); updateAllCounts(); }
function mobileSetVehicle(id) { filters.vehicle = id; filters.statusFilter = ''; closeSideMenu(); render(); }

// DATA
function getFieldValue(p, key) {
    const v = vehicles.find(x => x.id === p.vehicle);
    const val = p[key];
    if (!val && val !== 0) return '';
    if (key === 'dateReg' || key === 'dateReceive' || key === 'dateArchive') {
        const d = new Date(val);
        if (isNaN(d.getTime())) return val;
        const day = String(d.getDate()).padStart(2, '0');
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const year = d.getFullYear();
        return `${day}.${month}.${year}`;
    }
    if (key === 'amount') return val ? '€' + val : '';
    if (key === 'payment') return val ? '€' + val : '';
    if (key === 'vehicle') return v ? v.name : '';
    if (key === 'weight') return val ? val + ' кг' : '';
    if (key === 'photo') {
        const str = String(val).trim();
        if (str.match(/^https?:\/\//i)) {
            return `<a href="${str}" target="_blank" rel="noopener" onclick="event.stopPropagation();" style="color:var(--info);text-decoration:underline;word-break:break-all;">📷 Переглянути фото</a>`;
        }
        return str;
    }
    return val;
}

function getFilteredData() {
    let data = [...packages];
    
    // Фільтр "Нові" - заявки за останні 24 години
    if (filters.showNewOnly) {
        const now = new Date();
        const yesterday = new Date(now.getTime() - 24 * 60 * 60 * 1000);
        const yesterdayStr = yesterday.toISOString().split('T')[0];
        
        // Фільтруємо по даті оформлення (dateReg) або isNew24h
        data = data.filter(p => {
            // Якщо є dateReg - перевіряємо чи за останні 24 год
            if (p.dateReg && p.dateReg >= yesterdayStr) return true;
            // Або якщо позначено як isNew24h
            if (p.isNew24h) return true;
            return false;
        });
        
        // Приховуємо закриті статуси
        const hiddenStatuses = ['archived', 'refused', 'transferred', 'deleted'];
        data = data.filter(p => !hiddenStatuses.includes(p.status));
    }
    // Спеціальний фільтр по статусу (archived, refused, transferred, deleted)
    else if (filters.specialStatus) {
        data = data.filter(p => p.status === filters.specialStatus);
    } else if (filters.showArchive) {
        data = data.filter(p => p.status === 'archived');
    } else {
        // Приховуємо всі "закриті" статуси в звичайному режимі
        const hiddenStatuses = ['archived', 'refused', 'transferred', 'deleted'];
        data = data.filter(p => !hiddenStatuses.includes(p.status));
    }
    
    if (!filters.showNewOnly && filters.direction && filters.direction !== 'all') data = data.filter(p => p.direction === filters.direction);
    if (filters.statusFilter) data = data.filter(p => p.status === filters.statusFilter);
    if (filters.routeVehicle) data = data.filter(p => p.vehicle === filters.routeVehicle);
    if (filters.search && filters.search.trim()) { 
        const s = filters.search.trim().toLowerCase();
        data = data.filter(p => {
            // Збираємо всі текстові поля в один рядок
            const searchStr = [
                p.id || '',
                p.name || '',
                p.phone || '',
                p.phoneReg || '',
                p.address || '',
                p.ttn || '',
                p.amount || '',
                p.note || '',
                p.dispatcher || '',
                p.payment || '',
                p.mark || ''
            ].join(' ').toLowerCase();
            return searchStr.includes(s);
        }); 
    }
    if (!filters.showNewOnly && filters.date) data = data.filter(p => (p.dateReceive || p.dateReg) === filters.date);
    if (filters.vehicle === 'none') {
        data = data.filter(p => !p.vehicle);
    } else if (filters.vehicle && !filters.routeVehicle) {
        // Знаходимо авто по ID
        const v = vehicles.find(x => x.id === filters.vehicle);
        const vName = v ? v.name : filters.vehicle;
        // Порівнюємо і по id і по name
        data = data.filter(p => p.vehicle === filters.vehicle || p.vehicle === vName);
    }
    
    // Фільтр по даті статусу (для архіву, відмов, тощо)
    if (filters.statusDateFrom) {
        data = data.filter(p => p.statusDate >= filters.statusDateFrom);
    }
    if (filters.statusDateTo) {
        data = data.filter(p => p.statusDate <= filters.statusDateTo);
    }
    
    return data.sort((a,b) => {
        // Нові (isNew) завжди зверху
        if (a.isNew && !b.isNew) return -1;
        if (!a.isNew && b.isNew) return 1;
        // Потім по даті статусу (для архіву/відмов - новіші зверху)
        if (filters.specialStatus && a.statusDate && b.statusDate) {
            return b.statusDate.localeCompare(a.statusDate);
        }
        // Потім по даті реєстрації (новіші зверху)
        const dateA = new Date(a.dateReg || '1970-01-01');
        const dateB = new Date(b.dateReg || '1970-01-01');
        if (dateB - dateA !== 0) return dateB - dateA;
        // Потім по order
        return (a.order||0) - (b.order||0);
    });
}

// Функція підсвічування пошукового запиту
function highlightSearch(text) {
    if (!text || !filters.search || !filters.search.trim()) return text;
    const search = filters.search.trim();
    const regex = new RegExp(`(${search.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
    return String(text).replace(regex, '<span class="search-highlight">$1</span>');
}

function render() {
    const c = document.getElementById('cardsList');
    
    // Якщо це режим маршруту - рендеримо пасажирів з таблиці маршрутів
    if (filters.statusFilter === 'route' && filters.routeVehicle) {
        renderRoutePassengers();
        return;
    }
    
    let data = getFilteredData();
    updateFilterButtons();
    updateBulkBar();
    
    if (!data.length) { c.innerHTML = '<div class="empty-state"><div class="empty-state-icon">🔍</div><div>Не знайдено</div></div>'; return; }
    
    const detailCols = colSettings.details;
    const isRouteView = filters.statusFilter === 'route';
    const canDrag = true; // Завжди дозволяємо перетягування
    const hasSearch = filters.search && filters.search.trim();
    
    c.innerHTML = data.map((p, idx) => {
        const uniqueKey = (p._sheet && p._rowNum) ? `${p._sheet}_${p._rowNum}` : `local_${idx}`;
        const sel = selectedIds.has(uniqueKey);
        const dOpen = openDetailsId === uniqueKey;
        const aOpen = openActionsId === uniqueKey;
        const veh = vehicles.find(v => v.id === p.vehicle || v.name === p.vehicle);
        const isUaEu = p.direction === 'ua-eu';
        const uk = uniqueKey;
        const esc = (v) => (v || '').toString().replace(/"/g, '&quot;').replace(/'/g, '&#39;');

        // Direction label (bold text, no emoji)
        const dirLabel = isUaEu ? 'UA→EU' : 'EU→UA';
        const dirClass = isUaEu ? '' : ' eu-ua';

        // Header values
        const phoneRaw = p.phone || '—';
        const phoneDisplay = hasSearch ? highlightSearch(phoneRaw) : phoneRaw;
        const weightDisplay = p.weight ? p.weight + ' кг' : '';
        const priceDisplay = p.amount ? '€' + p.amount : '';
        const ttnRaw = p.ttn || '';
        const ttnDisplay = hasSearch ? highlightSearch(ttnRaw) : ttnRaw;
        const idRaw = p.id || '—';
        const idDisplay = hasSearch ? highlightSearch(idRaw) : idRaw;
        const nameDisplay = hasSearch ? highlightSearch(p.name || '—') : (p.name || '—');
        const numberDisplay = p.number || '';
        const dateDisplay = p.dateReg ? getFieldValue(p, 'dateReg') : '—';
        const addressShort = p.address ? (p.address.length > 40 ? p.address.substring(0, 40) + '...' : p.address) : '—';
        const addressDisplay = hasSearch ? highlightSearch(addressShort) : addressShort;

        // Payment badges for header
        const payStatusClass = p.payStatus === 'Оплачено' ? 'paid' : (p.payStatus === 'Неоплачено' ? 'unpaid' : 'neutral');
        const payStatusBadge = p.payStatus ? `<span class="card-pay-badge ${payStatusClass}">${p.payStatus}</span>` : '';
        const paymentBadge = p.payment ? `<span class="card-pay-badge neutral">${p.payment}</span>` : '';

        // Vehicle badge
        const vehicleBadge = veh
            ? `<span class="card-vehicle-badge">${veh.name}</span>`
            : `<span class="card-vehicle-badge empty">—</span>`;
        const orderNum = isRouteView ? `<span class="order-num">${idx + 1}</span>` : '';
        const notGeocodedClass = p._notGeocoded ? 'not-geocoded-card' : '';

        // === ALL INLINE EDITABLE FIELDS ===
        const vehOpts = vehicles.map(v => `<option value="${esc(v.name)}" ${(p.vehicle===v.id||p.vehicle===v.name)?'selected':''}>${v.name}</option>`).join('');

        const selOpt = (field, val, options) => options.map(o => `<option value="${esc(o)}" ${val===o?'selected':''}>${o}</option>`).join('');
        const payStatuses = ['Оплачено','Неоплачено','Відправник','Отримувач'];
        const payments = ['При отр гот','При отр на карту','Відпр на карту','Картка','Готівка'];
        const parcelStatuses = ['Невідомий','Зареєстровано','Оформлено','Кордон','Доставка'];
        const voOptions = ['Д','Ш','Б'];

        const mkInput = (label, field, val, ph, type) => `<div class="inline-edit-field"><span class="inline-edit-label">${label}</span><input class="inline-edit-input" type="${type||'text'}" value="${esc(val)}" placeholder="${ph||'—'}" onchange="inlineSave('${uk}','${field}',this.value)" onclick="event.stopPropagation()"></div>`;
        const mkSelect = (label, field, val, opts) => `<div class="inline-edit-field select-field"><span class="inline-edit-label">${label}</span><select class="inline-edit-select" onchange="inlineSave('${uk}','${field}',this.value)" onclick="event.stopPropagation()"><option value="">—</option>${selOpt(field,val,opts)}</select></div>`;
        const mkSelectVeh = () => `<div class="inline-edit-field select-field"><span class="inline-edit-label">Авто</span><select class="inline-edit-select" onchange="inlineSave('${uk}','vehicle',this.value)" onclick="event.stopPropagation()"><option value="">—</option>${vehOpts}</select></div>`;

        // TTN multi-value support: parse comma-separated TTNs
        const ttnArr = (p.ttn || '').split(',').map(t => t.trim()).filter(Boolean);
        const ttnEditHtml = `<div class="inline-edit-field" style="grid-column:1/-1;">
            <span class="inline-edit-label">НОМЕРИ ТТН</span>
            <div id="ttnList_${uk.replace(/[^a-zA-Z0-9]/g,'_')}" style="display:flex;flex-direction:column;gap:4px;">
                ${ttnArr.length ? ttnArr.map((t, ti) => `<div style="display:flex;gap:4px;align-items:center;">
                    <input class="inline-edit-input" style="flex:1;" value="${esc(t)}" placeholder="ТТН..." onchange="updateTtnList('${uk}')" onclick="event.stopPropagation()">
                    <button class="copy-btn-mini" onclick="event.stopPropagation();copyToClip('${esc(t)}',this)" title="Копіювати" style="opacity:0.7;">📋</button>
                    ${ttnArr.length > 1 ? `<button class="copy-btn-mini" onclick="event.stopPropagation();removeTtnItem('${uk}',${ti})" title="Видалити" style="opacity:0.7;color:var(--danger);">✕</button>` : ''}
                </div>`).join('') : `<div style="display:flex;gap:4px;align-items:center;">
                    <input class="inline-edit-input" style="flex:1;" value="" placeholder="ТТН..." onchange="updateTtnList('${uk}')" onclick="event.stopPropagation()">
                </div>`}
            </div>
            <button onclick="event.stopPropagation();addTtnItem('${uk}')" style="margin-top:4px;border:1px dashed var(--border);background:var(--bg-main);border-radius:4px;padding:4px 8px;font-size:10px;font-weight:600;color:var(--info);cursor:pointer;font-family:inherit;">+ Додати ТТН</button>
        </div>`;

        let inlineHtml = `<div class="inline-edit-grid">`;

        inlineHtml += mkInput('Тел. реєстратора','phoneReg',p.phoneReg,'+380...');

        if (isUaEu) {
            inlineHtml += `<div class="inline-section-title">Менеджер заповнює</div>`;
            inlineHtml += mkInput('Внутр. номер','number',p.number,'—');
            inlineHtml += mkInput('Вага (кг)','weight',p.weight,'0');
            inlineHtml += mkInput('Сума €','amount',p.amount,'0');
            inlineHtml += mkSelectVeh();
            inlineHtml += mkSelect('Статус оплати','payStatus',p.payStatus,payStatuses);
            inlineHtml += mkSelect('Оплата','payment',p.payment,payments);
            inlineHtml += mkSelect('Статус посилки','parcelStatus',p.parcelStatus,parcelStatuses);
            inlineHtml += mkSelect('ВО','vo',p.vo,voOptions);
            inlineHtml += mkInput('Примітка','note',p.note,'—');
            inlineHtml += mkInput('Примітка СМС','smsNote',p.smsNote,'—');
            inlineHtml += mkInput('Таймінг','timing',p.timing,'—');
            inlineHtml += mkInput('Дата отримання','dateReceive',p.dateReceive,'','date');
            inlineHtml += mkInput('Фото (URL)','photo',p.photo,'https://...');
        } else {
            inlineHtml += `<div class="inline-section-title">Менеджер заповнює</div>`;
            inlineHtml += mkInput('Таймінг','timing',p.timing,'—');
            inlineHtml += mkInput('Примітка','note',p.note,'—');
            inlineHtml += mkInput('Дата отримання','dateReceive',p.dateReceive,'','date');
            inlineHtml += mkInput('Виклик кур\'єра','number',p.number,'Введіть...');
            inlineHtml += mkInput('Примітка СМС','smsNote',p.smsNote,'—');
            inlineHtml += mkSelectVeh();
            inlineHtml += mkSelect('Статус посилки','parcelStatus',p.parcelStatus,parcelStatuses);
            inlineHtml += mkSelect('Статус оплати','payStatus',p.payStatus,payStatuses);
            inlineHtml += mkSelect('Оплата','payment',p.payment,payments);
            inlineHtml += mkSelect('ВО','vo',p.vo,voOptions);
            inlineHtml += mkInput('Вага (кг)','weight',p.weight,'0');
            inlineHtml += mkInput('Сума €','amount',p.amount,'0');
            inlineHtml += mkInput('Фото (URL)','photo',p.photo,'https://...');
        }
        inlineHtml += `</div>`;

        return `<div class="lead-card status-${p.status} ${sel?'selected':''} ${notGeocodedClass}" data-uid="${uk}" data-id="${p.id}" draggable="true" ondragstart="handleDragStart(event,'${uk}')" ondragend="handleDragEnd(event)" ondragover="handleDragOver(event)" ondrop="handleDrop(event,'${uk}')">
            <div class="card-header">
                <div class="drag-handle"><span></span><span></span><span></span></div>
                <div class="card-checkbox-wrap">
                    <input type="checkbox" class="card-checkbox" ${sel?'checked':''} onclick="event.stopPropagation();toggleSelect('${uk}')">
                </div>
                <div class="card-header-display card-body" onclick="toggleDetails('${uk}')">
                    <div class="card-top-row">
                        ${orderNum}
                        <span class="card-direction${dirClass}">${dirLabel}</span>
                        ${numberDisplay ? `<span style="background:var(--purple);color:white;padding:2px 7px;border-radius:5px;font-size:10px;font-weight:700;flex-shrink:0;">№${numberDisplay}</span>` : ''}
                        ${ttnRaw ? `<span style="background:var(--info);color:white;padding:2px 6px;border-radius:5px;font-size:10px;font-weight:600;flex-shrink:0;display:inline-flex;align-items:center;gap:3px;">ТТН:${ttnDisplay}<button class="copy-btn-mini" onclick="event.stopPropagation();copyToClip('${esc(ttnRaw)}',this)" title="Копіювати ТТН">📋</button></span>` : ''}
                        <span class="card-phone" onclick="event.stopPropagation()" onmousedown="event.stopPropagation()">${phoneDisplay}<button class="copy-btn-mini" onclick="event.stopPropagation();copyToClip('${esc(phoneRaw)}',this)" title="Копіювати тел.">📋</button></span>
                        ${weightDisplay ? `<span class="card-seats">${weightDisplay}</span>` : ''}
                        <span class="card-price">${priceDisplay}</span>
                        ${payStatusBadge}
                        ${paymentBadge}
                    </div>
                    <div class="card-row2-wrap">
                        <div class="card-route-row">
                            <span class="card-route" onclick="event.stopPropagation()" onmousedown="event.stopPropagation()"><a href="https://www.google.com/maps/search/${encodeURIComponent(p.address || '')}" target="_blank" rel="noopener" style="color:inherit;text-decoration:none;" onclick="event.stopPropagation()">📍 ${addressDisplay}</a><button class="copy-btn-mini" onclick="event.stopPropagation();copyToClip('${esc(p.address || '')}',this)" title="Копіювати адресу">📋</button></span>
                        </div>
                        <div class="card-info-row">
                            <span class="card-id" onclick="event.stopPropagation()" onmousedown="event.stopPropagation()">${idDisplay}<button class="copy-btn-mini" onclick="event.stopPropagation();copyToClip('${esc(idRaw)}',this)" title="Копіювати ІД">📋</button></span>
                            <span class="card-name" onclick="event.stopPropagation()" onmousedown="event.stopPropagation()">${nameDisplay}</span>
                            <span class="card-date">${dateDisplay}</span>
                            ${p.isNew ? '<span class="new-tag">NEW</span>' : ''}
                        </div>
                    </div>
                </div>
                <div class="card-header-edit">
                    <div class="edit-row">
                        ${orderNum}
                        <span class="card-direction${dirClass}">${dirLabel}</span>
                        <input class="edit-field" style="flex:1;min-width:100px;" value="${esc(phoneRaw)}" placeholder="Телефон" onchange="inlineSave('${uk}','phone',this.value)" onclick="event.stopPropagation()">
                        <input class="edit-field" style="width:60px;" value="${esc(p.weight||'')}" placeholder="Вага" onchange="inlineSave('${uk}','weight',this.value)" onclick="event.stopPropagation()">
                        <input class="edit-field" style="width:60px;" value="${esc(p.amount||'')}" placeholder="€" onchange="inlineSave('${uk}','amount',this.value)" onclick="event.stopPropagation()">
                    </div>
                    <div class="edit-row">
                        <input class="edit-field edit-field-wide" value="${esc(p.name||'')}" placeholder="ПІБ" onchange="inlineSave('${uk}','name',this.value)" onclick="event.stopPropagation()">
                        <input class="edit-field edit-field-wide" value="${esc(p.ttn||'')}" placeholder="ТТН" onchange="inlineSave('${uk}','ttn',this.value)" onclick="event.stopPropagation()">
                    </div>
                    <div class="edit-row">
                        <input class="edit-field edit-field-wide" value="${esc(p.address||'')}" placeholder="Адреса" onchange="inlineSave('${uk}','address',this.value)" onclick="event.stopPropagation()">
                    </div>
                </div>
                <div class="card-right-section">
                    <div class="card-vehicle">${vehicleBadge}</div>
                    <button class="card-actions-toggle ${aOpen?'open':''}" onclick="event.stopPropagation();toggleActions('${uk}')">▼</button>
                </div>
            </div>
            <div class="card-details ${dOpen?'show':''}">
                ${inlineHtml}
                <span class="inline-save-indicator" id="saveInd_${uk.replace(/[^a-zA-Z0-9]/g,'_')}">✓ Збережено</span>
            </div>
            <div class="card-actions ${aOpen?'show':''}">
                <button class="btn-card-action btn-call" onclick="event.stopPropagation();location.href='tel:${p.phone}'">📞 Дзвонити</button>
                <button class="btn-card-action btn-msg" onclick="event.stopPropagation();showToast('💬 Скоро!')">💬 Писати</button>
                <button class="btn-card-action btn-map" onclick="event.stopPropagation();openMapModal('${uk}')">🗺️ Карта</button>
                <button class="btn-card-action" style="background:#d1fae5;color:#065f46;" onclick="event.stopPropagation();restorePackageToOriginal('${uk}')">↩️ Відновити</button>
                <button class="btn-card-action btn-delete" onclick="event.stopPropagation();deletePackage('${uk}')">🗑️ Видалити</button>
            </div>
        </div>`;
    }).join('');
}

// DRAG & DROP
function handleDragStart(e, id) { draggedId = id; e.target.classList.add('dragging'); }
function handleDragEnd(e) { e.target.classList.remove('dragging'); document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over')); draggedId = null; }
function handleDragOver(e) { e.preventDefault(); const card = e.target.closest('.lead-card'); if (card && card.dataset.id !== draggedId) { document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over')); card.classList.add('drag-over'); } }
function handleDrop(e, targetId) {
    e.preventDefault();
    if (!draggedId || draggedId === targetId) return;
    const data = getFilteredData();
    // Шукаємо по uid (sheet_rowNum), а не по id
    const getUid = (p, i) => (p._sheet && p._rowNum) ? `${p._sheet}_${p._rowNum}` : `local_${i}`;
    const dragIdx = data.findIndex((p, i) => getUid(p, i) === draggedId);
    const targetIdx = data.findIndex((p, i) => getUid(p, i) === targetId);
    if (dragIdx === -1 || targetIdx === -1) return;

    // Копіюємо всі дані при переміщенні (зберігаємо повний об'єкт)
    const draggedP = data[dragIdx];
    const targetP = data[targetIdx];

    // Призначаємо нові order значення
    data.forEach((p, i) => {
        const orig = packages.find(x => x._sheet === p._sheet && x._rowNum === p._rowNum);
        if (orig) orig.order = i * 10;
    });

    const origDragged = packages.find(x => x._sheet === draggedP._sheet && x._rowNum === draggedP._rowNum);
    const origTarget = packages.find(x => x._sheet === targetP._sheet && x._rowNum === targetP._rowNum);
    if (origDragged && origTarget) {
        origDragged.order = dragIdx < targetIdx ? origTarget.order + 1 : origTarget.order - 1;
    }

    saveSettings();
    render();
    showToast('↕️ Порядок змінено');
}

// Хелпер: знайти пасажира по uniqueKey
function findPackageByUid(uid) {
    if (!uid) return null;
    if (uid.startsWith('local_')) {
        const idx = parseInt(uid.replace('local_', ''));
        const data = getFilteredData();
        return data[idx] || null;
    }
    // uid = "sheet_rowNum"
    const parts = uid.split('_');
    const rowNum = parseInt(parts.pop());
    const sheet = parts.join('_');
    return packages.find(p => p._sheet === sheet && p._rowNum === rowNum);
}

// SELECTION & BULK ACTIONS
function toggleDetails(uid) {
    const p = findPackageByUid(uid);
    if (p?.isNew) { p.isNew = false; saveSettings(); }
    // Закриваємо дії інших карток
    if (openActionsId) {
        document.querySelector(`[data-uid="${openActionsId}"] .card-actions`)?.classList.remove('show');
        document.querySelector(`[data-uid="${openActionsId}"] .card-actions-toggle`)?.classList.remove('open');
        openActionsId = null;
    }
    if (openDetailsId && openDetailsId !== uid) {
        const prevCard = document.querySelector(`[data-uid="${openDetailsId}"]`);
        if (prevCard) prevCard.classList.remove('details-open');
        document.querySelector(`[data-uid="${openDetailsId}"] .card-details`)?.classList.remove('show');
    }
    openDetailsId = openDetailsId === uid ? null : uid;
    const cardEl = document.querySelector(`[data-uid="${uid}"]`);
    if (cardEl) cardEl.classList.toggle('details-open', openDetailsId === uid);
    document.querySelector(`[data-uid="${uid}"] .card-details`)?.classList.toggle('show', openDetailsId === uid);
    document.querySelector(`[data-uid="${uid}"] .new-tag`)?.remove();
}

function toggleActions(uid) { 
    // Закриваємо дії інших карток
    if (openActionsId && openActionsId !== uid) {
        document.querySelector(`[data-uid="${openActionsId}"] .card-actions`)?.classList.remove('show');
        document.querySelector(`[data-uid="${openActionsId}"] .card-actions-toggle`)?.classList.remove('open');
    }
    // Закриваємо деталі інших карток
    if (openDetailsId && openDetailsId !== uid) {
        const prevCard = document.querySelector(`[data-uid="${openDetailsId}"]`);
        if (prevCard) prevCard.classList.remove('details-open');
        document.querySelector(`[data-uid="${openDetailsId}"] .card-details`)?.classList.remove('show');
        openDetailsId = null;
    }
    openActionsId = openActionsId === uid ? null : uid;
    document.querySelector(`[data-uid="${uid}"] .card-actions`)?.classList.toggle('show', openActionsId === uid);
    document.querySelector(`[data-uid="${uid}"] .card-actions-toggle`)?.classList.toggle('open', openActionsId === uid);
}

function toggleSelect(uid) { 
    selectedIds.has(uid) ? selectedIds.delete(uid) : selectedIds.add(uid); 
    document.querySelector(`[data-uid="${uid}"]`)?.classList.toggle('selected', selectedIds.has(uid)); 
    updateBulkBar();
}

function toggleSelectAll() { 
    const data = getFilteredData(); 
    if (document.getElementById('selectAll').checked) {
        data.forEach(p => {
            const uid = (p._sheet && p._rowNum) ? `${p._sheet}_${p._rowNum}` : `local_${data.indexOf(p)}`;
            selectedIds.add(uid);
        });
    } else {
        selectedIds.clear();
    }
    render();
}

function clearSelection() { 
    selectedIds.clear(); 
    render(); 
    // Ховаємо sidebar тільки тут
    const sidebar = document.getElementById('bulkActionsSidebar');
    if (sidebar) sidebar.classList.remove('show');
    const bar = document.getElementById('bulkActionsBar');
    if (bar) bar.classList.remove('show');
    document.getElementById('bulkCount').textContent = 0;
    const sidebarCount = document.getElementById('bulkCountSidebar');
    if (sidebarCount) sidebarCount.textContent = 0;
}

function updateBulkBar() {
    const bar = document.getElementById('bulkActionsBar');
    const sidebar = document.getElementById('bulkActionsSidebar');
    const count = selectedIds.size;
    
    // Оновлюємо лічильники
    document.getElementById('bulkCount').textContent = count;
    const sidebarCount = document.getElementById('bulkCountSidebar');
    if (sidebarCount) sidebarCount.textContent = count;
    
    // Mobile bar - показуємо/ховаємо
    bar.classList.toggle('show', count > 0);
    
    // PC Sidebar - тільки ПОКАЗУЄМО, не ховаємо (ховає clearSelection)
    if (sidebar && count > 0) sidebar.classList.add('show');
    
    const isRouteView = filters.statusFilter === 'route' && filters.routeVehicle;
    const isArchiveView = filters.showArchive;
    const isSpecialStatus = !!filters.specialStatus; // archived, refused, transferred, deleted
    const canRestore = isArchiveView || isSpecialStatus;
    const canDeleteForever = filters.specialStatus === 'deleted';
    
    // Mobile кнопки
    const restoreBtn = document.getElementById('btnBulkRestore');
    const notifyBtn = document.getElementById('btnBulkNotify');
    if (restoreBtn) restoreBtn.style.display = canRestore ? 'inline-flex' : 'none';
    if (notifyBtn) notifyBtn.style.display = isRouteView ? 'inline-flex' : 'none';
    
    // PC Sidebar кнопки
    const sidebarNotify = document.getElementById('btnSidebarNotify');
    const sidebarRestore = document.getElementById('btnSidebarRestore');
    const sidebarDeleteForever = document.getElementById('btnSidebarDeleteForever');
    if (sidebarNotify) sidebarNotify.style.display = isRouteView ? 'flex' : 'none';
    if (sidebarRestore) sidebarRestore.style.display = canRestore ? 'flex' : 'none';
    if (sidebarDeleteForever) sidebarDeleteForever.style.display = canDeleteForever ? 'flex' : 'none';
}

function handleSearch() { filters.search = document.getElementById('searchInput').value; render(); }

function updateAllCounts() {
    // Активні = без закритих статусів
    const hiddenStatuses = ['archived', 'refused', 'transferred', 'deleted'];
    const active = packages.filter(p => !hiddenStatuses.includes(p.status));
    const archived = packages.filter(p => p.status === 'archived');
    const refused = packages.filter(p => p.status === 'refused');
    const transferred = packages.filter(p => p.status === 'transferred');
    const deleted = packages.filter(p => p.status === 'deleted');
    const inRoute = active.filter(p => p.status === 'route');
    const noVehicle = active.filter(p => !p.vehicle);
    const uaEu = active.filter(p => p.direction === 'ua-eu');
    const euUa = active.filter(p => p.direction === 'eu-ua');
    
    // Нові заявки за останні 24 години
    const now = new Date();
    const yesterday = new Date(now.getTime() - 24 * 60 * 60 * 1000);
    const yesterdayStr = yesterday.toISOString().split('T')[0];
    const newLeads = active.filter(p => (p.dateReg && p.dateReg >= yesterdayStr) || p.isNew24h);
    
    document.getElementById('countAll').textContent = active.length;
    // countRoute оновлюється через updateAllRoutesCount() API
    document.getElementById('countArchive').textContent = archived.length;
    document.getElementById('countNoVehicle').textContent = noVehicle.length;
    
    // Лічильники в popup напрямків
    const dAll = document.getElementById('countDirAll');
    const dUaEu = document.getElementById('countDirUaEu');
    const dEuUa = document.getElementById('countDirEuUa');
    if (dAll) dAll.textContent = active.length;
    if (dUaEu) dUaEu.textContent = uaEu.length;
    if (dEuUa) dEuUa.textContent = euUa.length;
    
    // Мобільні лічильники
    const mAll = document.getElementById('mobileCountAll');
    const mNew = document.getElementById('mobileCountNew');
    // mobileCountRoute оновлюється через updateAllRoutesCount() API
    const mArch = document.getElementById('mobileCountArchive');
    const mNoVeh = document.getElementById('mobileCountNoVehicle');
    const mUaEu = document.getElementById('mobileCountUaEu');
    const mEuUa = document.getElementById('mobileCountEuUa');
    const mRefused = document.getElementById('mobileCountRefused');
    const mTransferred = document.getElementById('mobileCountTransferred');
    const mDeleted = document.getElementById('mobileCountDeleted');
    if (mAll) mAll.textContent = active.length;
    if (mNew) mNew.textContent = newLeads.length;
    // НЕ перезаписуємо mobileCountRoute - він оновлюється через API
    if (mArch) mArch.textContent = archived.length;
    if (mNoVeh) mNoVeh.textContent = noVehicle.length;
    if (mUaEu) mUaEu.textContent = uaEu.length;
    if (mEuUa) mEuUa.textContent = euUa.length;
    if (mRefused) mRefused.textContent = refused.length;
    if (mTransferred) mTransferred.textContent = transferred.length;
    if (mDeleted) mDeleted.textContent = deleted.length;
    
    // PC Sidebar лічильники
    const pcAll = document.getElementById('pcCountAll');
    const pcNew = document.getElementById('pcCountNew');
    const pcUaEu = document.getElementById('pcCountUaEu');
    const pcEuUa = document.getElementById('pcCountEuUa');
    const pcNoVeh = document.getElementById('pcCountNoVehicle');
    const pcRoute = document.getElementById('pcCountRoute');
    const pcArch = document.getElementById('pcCountArchive');
    const pcRefused = document.getElementById('pcCountRefused');
    const pcTransferred = document.getElementById('pcCountTransferred');
    const pcDeleted = document.getElementById('pcCountDeleted');
    if (pcAll) pcAll.textContent = active.length;
    if (pcNew) pcNew.textContent = newLeads.length;
    if (pcUaEu) pcUaEu.textContent = uaEu.length;
    if (pcEuUa) pcEuUa.textContent = euUa.length;
    if (pcNoVeh) pcNoVeh.textContent = noVehicle.length;
    if (pcRoute) pcRoute.textContent = inRoute.length;
    if (pcArch) pcArch.textContent = archived.length;
    if (pcRefused) pcRefused.textContent = refused.length;
    if (pcTransferred) pcTransferred.textContent = transferred.length;
    if (pcDeleted) pcDeleted.textContent = deleted.length;
    
    // Dashboard лічильники
    const dashArch = document.getElementById('dashArchived');
    const dashRefused = document.getElementById('dashRefused');
    const dashTransferred = document.getElementById('dashTransferred');
    const dashDeleted = document.getElementById('dashDeleted');
    if (dashArch) dashArch.textContent = archived.length;
    if (dashRefused) dashRefused.textContent = refused.length;
    if (dashTransferred) dashTransferred.textContent = transferred.length;
    if (dashDeleted) dashDeleted.textContent = deleted.length;
    
    // Оновлюємо списки маршрутів та авто
    updateRoutesList();
    updatePcVehiclesList();
}

// Оновлення списку авто в PC Sidebar
function updatePcVehiclesList() {
    const container = document.getElementById('pcVehiclesList');
    if (!container) return;
    
    container.innerHTML = vehicles.map(v => {
        const count = packages.filter(p => (p.vehicle === v.id || p.vehicle === v.name) && p.status !== 'archived').length;
        const isActive = filters.vehicle === v.id;
        return `<div class="pc-sidebar-item ${isActive ? 'active' : ''}" style="display:flex;justify-content:space-between;align-items:center;">
            <div onclick="setVehicleFilter('${v.id}')" style="flex:1;cursor:pointer;">
                <span class="item-icon">🚐</span>${v.name}
            </div>
            <span class="item-count" style="margin-right:8px;">${count}</span>
            <button onclick="event.stopPropagation();deleteVehicle('${v.id}')" style="background:none;border:none;cursor:pointer;font-size:12px;opacity:0.5;padding:4px;" title="Видалити авто">🗑️</button>
        </div>`;
    }).join('');
}

// ROUTES LIST - оновлюємо з реальними даними з таблиці
function updateRoutesList() {
    // Спочатку показуємо з локальними даними
    renderRoutesListLocal();
    
    // Потім асинхронно оновлюємо з API
    vehicles.forEach(v => {
        fetch(ROUTE_API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain' },
            body: JSON.stringify({
                action: 'getRoutePassengers',
                payload: { vehicleName: v.name }
            })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                // Оновлюємо badge в desktop dropdown
                const desktopBadge = document.querySelector(`#routesList [data-vehicle="${v.id}"] .badge`);
                if (desktopBadge) {
                    desktopBadge.textContent = data.stats.total;
                    desktopBadge.style.background = data.stats.total > 0 ? 'var(--success)' : 'var(--border)';
                    desktopBadge.style.color = data.stats.total > 0 ? 'white' : 'var(--text-secondary)';
                }
                
                // Оновлюємо badge в mobile menu
                const mobileBadge = document.querySelector(`#mobileRoutesList [data-vehicle="${v.id}"] .side-menu-item-count`);
                if (mobileBadge) {
                    mobileBadge.textContent = data.stats.total;
                }
                
                // Оновлюємо badge в PC sidebar
                const pcBadge = document.querySelector(`#pcRoutesList [data-vehicle="${v.id}"] .item-count`);
                if (pcBadge) {
                    pcBadge.textContent = data.stats.total;
                }
            }
        })
        .catch(() => {});
    });
}

// Рендер списку маршрутів з локальними даними (швидко)
function renderRoutesListLocal() {
    const routesHtml = vehicles.map(v => {
        const count = packages.filter(p => (p.vehicle === v.id || p.vehicle === v.name) && p.status === 'route').length;
        return `<div class="dropdown-item" data-vehicle="${v.id}" onclick="showVehicleRoute('${v.id}')">
            <span>🚐 ${v.name}</span>
            <span class="badge" style="background:${count > 0 ? 'var(--success)' : 'var(--border)'};color:${count > 0 ? 'white' : 'var(--text-secondary)'}">${count}</span>
        </div>`;
    }).join('');
    
    const routesList = document.getElementById('routesList');
    if (routesList) routesList.innerHTML = routesHtml;
    
    // Mobile routes
    const mobileRoutesHtml = vehicles.map(v => {
        const count = packages.filter(p => (p.vehicle === v.id || p.vehicle === v.name) && p.status === 'route').length;
        return `<div class="side-menu-item route ${filters.routeVehicle === v.id ? 'active' : ''}" data-vehicle="${v.id}" onclick="showVehicleRoute('${v.id}'); closeSideMenu();">
            <span class="side-menu-item-left">🚐 ${v.name}</span>
            <span class="side-menu-item-count">${count}</span>
        </div>`;
    }).join('');
    
    const mobileRoutesList = document.getElementById('mobileRoutesList');
    if (mobileRoutesList) mobileRoutesList.innerHTML = mobileRoutesHtml;
    
    // PC Sidebar routes
    const pcRoutesHtml = vehicles.map(v => {
        const count = packages.filter(p => (p.vehicle === v.id || p.vehicle === v.name) && p.status === 'route').length;
        const isActive = filters.routeVehicle === v.id;
        return `<div class="pc-sidebar-item route ${isActive ? 'active' : ''}" data-vehicle="${v.id}" onclick="showVehicleRoute('${v.id}')">
            <span><span class="item-icon">🚐</span>${v.name}</span>
            <span class="item-count">${count}</span>
        </div>`;
    }).join('');
    
    const pcRoutesList = document.getElementById('pcRoutesList');
    if (pcRoutesList) pcRoutesList.innerHTML = pcRoutesHtml;
    
    // Оновлюємо лічильник "Всі маршрути" через API
    updateAllRoutesCount();
}

// Оновлення лічильника "Всі маршрути" через API
async function updateAllRoutesCount() {
    try {
        const response = await fetch(ROUTE_API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain' },
            body: JSON.stringify({ action: 'getAvailableRoutes' })
        });
        const data = await response.json();
        
        if (data.success && data.routes) {
            // Рахуємо суму всіх записів
            const totalCount = data.routes.reduce((sum, r) => sum + (r.count || 0), 0);
            
            // Оновлюємо всі лічильники "Всі маршрути"
            const countRoute = document.getElementById('countRoute');
            const pcCount = document.getElementById('pcCountRoute');
            const mobileCount = document.getElementById('mobileCountRoute');
            
            if (countRoute) countRoute.textContent = totalCount;
            if (pcCount) pcCount.textContent = totalCount;
            if (mobileCount) mobileCount.textContent = totalCount;
        }
    } catch (err) {
        console.error('Error updating all routes count:', err);
    }
}

function showAllRoutes() {
    // Показати всі маршрути - завантажуємо всі авто
    filters.statusFilter = 'route';
    filters.routeVehicle = 'all';
    filters.showArchive = false;
    document.getElementById('routeDropdown')?.classList.remove('show');
    closeSideMenu();
    
    // Завантажуємо всі маршрути (loader всередині функції)
    loadAllRoutePassengers();
}

function showVehicleRoute(vehicleId) {
    const v = vehicles.find(x => x.id === vehicleId);
    if (!v) return showToast('❌ Авто не знайдено');
    
    filters.statusFilter = 'route';
    filters.routeVehicle = vehicleId;
    filters.showArchive = false;
    document.getElementById('routeDropdown')?.classList.remove('show');
    closeSideMenu();
    
    showLoader(`Завантаження: ${v.name}`, '');
    
    // Завантажуємо дані з таблиці маршрутів + статус розсилки
    Promise.all([
        fetch(ROUTE_API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain' },
            body: JSON.stringify({
                action: 'getRoutePassengers',
                payload: { vehicleName: v.name }
            })
        }).then(r => r.json()),
        fetch(ROUTE_API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain' },
            body: JSON.stringify({ action: 'getMailingStatus' })
        }).then(r => r.json())
    ])
    .then(([routeData, mailingData]) => {
        hideLoader();
        
        // Зберігаємо mailingIds
        if (mailingData.success) {
            mailingIds = mailingData.mailingIds || [];
        }
        
        if (routeData.success) {
            // Зберігаємо дані маршруту
            routePassengers = routeData.packages.map((p, idx) => ({
                ...p,
                _uid: `route_${v.id}_${idx}`,
                _isRouteData: true,
                _vehicleId: v.id,
                _vehicleName: v.name
            }));
            routeStats = routeData.stats;
            currentRouteVehicle = v;
            
            // Рендеримо
            renderRoutePassengers();
            updateFilterButtons();
            showToast(`🚐 ${v.name}: ${routeData.stats.total} пасажирів`);
        } else {
            showToast('❌ ' + routeData.error);
        }
    })
    .catch(err => {
        hideLoader();
        console.error('Route load error:', err);
        showToast('❌ Помилка завантаження');
    });
}

// Завантажити всі маршрути
async function loadAllRoutePassengers() {
    routePassengers = [];
    routeStats = { total: 0, pending: 0, inProgress: 0, completed: 0, cancelled: 0, archived: 0, notified: 0, notNotified: 0 };
    currentRouteVehicle = null;
    
    // Показуємо loader
    showLoader('Завантаження маршрутів...', '');
    
    // Паралельно завантажуємо: статус розсилки + список маршрутів
    try {
        const [mailingResponse, routesResponse] = await Promise.all([
            fetch(ROUTE_API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({ action: 'getMailingStatus' })
            }).then(r => r.json()).catch(() => ({ success: false })),
            fetch(ROUTE_API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({ action: 'getAvailableRoutes' })
            }).then(r => r.json()).catch(() => ({ success: false }))
        ]);
        
        // Зберігаємо mailingIds
        if (mailingResponse.success) {
            mailingIds = mailingResponse.mailingIds || [];
        }
        
        if (routesResponse.success && routesResponse.routes && routesResponse.routes.length > 0) {
            const routes = routesResponse.routes;
            updateLoader('Завантаження пасажирів...', `0 / ${routes.length}`);
            
            // Паралельно завантажуємо ВСІ маршрути одночасно
            const routePromises = routes.map(route => 
                fetch(ROUTE_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        action: 'getRoutePassengers',
                        payload: { sheetName: route.name }
                    })
                })
                .then(r => r.json())
                .then(data => ({ route, data }))
                .catch(err => ({ route, data: { success: false, error: err } }))
            );
            
            // Чекаємо всі результати
            const results = await Promise.all(routePromises);
            
            // Обробляємо результати
            let loaded = 0;
            for (const { route, data } of results) {
                loaded++;
                updateLoader(`Обробка: ${route.name}`, `${loaded} / ${routes.length}`);
                
                if (data.success && data.packages && data.packages.length > 0) {
                    // Знаходимо відповідне авто
                    const matchedVehicle = vehicles.find(v => 
                        v.name === route.name || 
                        v.routeSheet === route.name ||
                        route.name.includes(v.name)
                    );
                    
                    const mapped = data.packages.map((p, idx) => ({
                        ...p,
                        _uid: `route_${route.name.replace(/\s+/g, '_')}_${idx}`,
                        _isRouteData: true,
                        _vehicleId: matchedVehicle?.id || route.name,
                        _vehicleName: route.name
                    }));
                    routePassengers = routePassengers.concat(mapped);
                    
                    // Додаємо статистику
                    if (data.stats) {
                        routeStats.total += data.stats.total || 0;
                        routeStats.pending += data.stats.pending || 0;
                        routeStats.inProgress += data.stats.inProgress || 0;
                        routeStats.completed += data.stats.completed || 0;
                        routeStats.cancelled += data.stats.cancelled || 0;
                        routeStats.archived += data.stats.archived || 0;
                    }
                }
            }
        }
    } catch (err) {
        console.error('Error loading routes:', err);
    }
    
    hideLoader();
    renderRoutePassengers();
    updateFilterButtons();
    showToast(`📋 Всі маршрути: ${routeStats.total} пасажирів`);
}

// Loader functions
function showLoader(text, progress) {
    document.getElementById('loaderText').textContent = text || 'Завантаження...';
    document.getElementById('loaderProgress').textContent = progress || '';
    document.getElementById('globalLoader').classList.add('show');
}
function updateLoader(text, progress) {
    if (text) document.getElementById('loaderText').textContent = text;
    if (progress !== undefined) document.getElementById('loaderProgress').textContent = progress;
}
function hideLoader() {
    document.getElementById('globalLoader').classList.remove('show');
}

// Глобальні змінні для маршрутів
let routePassengers = [];
let routeStats = { total: 0, pending: 0, inProgress: 0, completed: 0, cancelled: 0, archived: 0, notified: 0, notNotified: 0 };
let currentRouteVehicle = null;
let routeStatusFilter = 'all'; // Фільтр по статусу в маршруті
let mailingIds = []; // ІД тих хто отримав розсилку

// Рендер пасажирів маршруту в основному списку
function renderRoutePassengers() {
    const container = document.getElementById('cardsList');
    if (!container) return;
    
    // Скролимо до верху
    container.scrollTop = 0;
    window.scrollTo({ top: 0, behavior: 'smooth' });
    
    updateBulkBar();
    
    if (routePassengers.length === 0) {
        container.innerHTML = `
            <div style="text-align:center;padding:40px;color:var(--text-secondary);">
                <div style="font-size:48px;margin-bottom:12px;">📭</div>
                <div style="font-size:14px;font-weight:600;">Маршрут порожній</div>
                <div style="font-size:12px;margin-top:8px;">Додайте пасажирів через кнопку "🚀 Маршрут"</div>
            </div>
        `;
        return;
    }
    
    // Фільтруємо по статусу
    let filteredPassengers = routePassengers;
    if (routeStatusFilter === 'not-notified') {
        filteredPassengers = routePassengers.filter(p => !mailingIds.includes(String(p.id)));
    } else if (routeStatusFilter === 'notified') {
        filteredPassengers = routePassengers.filter(p => mailingIds.includes(String(p.id)));
    } else if (routeStatusFilter !== 'all') {
        filteredPassengers = routePassengers.filter(p => p.driverStatus === routeStatusFilter);
    }
    
    // Рахуємо сповіщення
    const notifiedCount = routePassengers.filter(p => mailingIds.includes(String(p.id))).length;
    const notNotifiedCount = routePassengers.length - notifiedCount;
    routeStats.notified = notifiedCount;
    routeStats.notNotified = notNotifiedCount;
    
    let html = '';
    
    // Статистика зверху - клікабельна, адаптивна
    html += `
        <div class="route-stats-box">
            <div class="route-stats-grid">
                <div class="route-stat-item ${routeStatusFilter === 'all' ? 'active' : ''}" onclick="filterRouteByStatus('all')">
                    <div class="route-stat-num">${routeStats.total}</div>
                    <div class="route-stat-label">Всього</div>
                </div>
                <div class="route-stat-item ${routeStatusFilter === 'pending' ? 'active pending' : ''}" onclick="filterRouteByStatus('pending')" style="${routeStatusFilter !== 'pending' ? 'color:#6c757d;' : ''}">
                    <div class="route-stat-num">${routeStats.pending}</div>
                    <div class="route-stat-label">⏳ Очікує</div>
                </div>
                <div class="route-stat-item ${routeStatusFilter === 'in-progress' ? 'active in-progress' : ''}" onclick="filterRouteByStatus('in-progress')" style="${routeStatusFilter !== 'in-progress' ? 'color:#007bff;' : ''}">
                    <div class="route-stat-num">${routeStats.inProgress}</div>
                    <div class="route-stat-label">🔄 В дорозі</div>
                </div>
                <div class="route-stat-item ${routeStatusFilter === 'completed' ? 'active completed' : ''}" onclick="filterRouteByStatus('completed')" style="${routeStatusFilter !== 'completed' ? 'color:#28a745;' : ''}">
                    <div class="route-stat-num">${routeStats.completed}</div>
                    <div class="route-stat-label">✅ Готово</div>
                </div>
                <div class="route-stat-item ${routeStatusFilter === 'cancelled' ? 'active cancelled' : ''}" onclick="filterRouteByStatus('cancelled')" style="${routeStatusFilter !== 'cancelled' ? 'color:#dc3545;' : ''}">
                    <div class="route-stat-num">${routeStats.cancelled}</div>
                    <div class="route-stat-label">❌ Відмова</div>
                </div>
                <div class="route-stat-item ${routeStatusFilter === 'not-notified' ? 'active not-notified' : ''}" onclick="filterRouteByStatus('not-notified')" style="${routeStatusFilter !== 'not-notified' ? 'color:#f97316;' : ''}">
                    <div class="route-stat-num">${notNotifiedCount}</div>
                    <div class="route-stat-label">🔔 Не спов.</div>
                </div>
            </div>
            ${currentRouteVehicle ? `<div style="text-align:center;margin-top:10px;"><button onclick="showVehicleRoute('${currentRouteVehicle.id}')" style="padding:8px 20px;border:none;border-radius:6px;background:var(--info);color:white;font-weight:600;cursor:pointer;font-size:12px;">🔄 Оновити</button></div>` : ''}
        </div>
    `;
    
    if (filteredPassengers.length === 0) {
        html += `<div style="text-align:center;padding:30px;color:var(--text-secondary);">Немає записів з цим статусом</div>`;
        container.innerHTML = html;
        return;
    }
    
    // Картки пасажирів - використовуємо стандартний стиль lead-card
    filteredPassengers.forEach((p, idx) => {
        // Визначаємо клас по статусу водія
        let statusClass = '';
        let statusBadge = '<span class="status-badge pending">⏳ Очікує</span>';
        
        if (p.driverStatus === 'completed') {
            statusClass = 'driver-completed';
            statusBadge = '<span class="status-badge completed">✅ Готово</span>';
        } else if (p.driverStatus === 'in-progress') {
            statusClass = 'driver-in-progress';
            statusBadge = '<span class="status-badge in-progress">🔄 В дорозі</span>';
        } else if (p.driverStatus === 'cancelled') {
            statusClass = 'driver-cancelled';
            statusBadge = '<span class="status-badge cancelled">❌ Відмова</span>';
        } else if (p.driverStatus === 'archived') {
            statusClass = 'driver-archived';
            statusBadge = '<span class="status-badge archived">📦 Архів</span>';
        }
        
        // Перевіряємо чи сповіщений
        const isNotified = mailingIds.includes(String(p.id));
        const notifyBadge = isNotified 
            ? '<span style="background:#f97316;color:white;padding:2px 6px;border-radius:4px;font-size:9px;font-weight:600;">🔔 Сповіщено</span>' 
            : '';
        const notifyClass = isNotified ? 'is-notified' : '';
        
        const veh = vehicles.find(v => v.id === p._vehicleId || v.name === p._vehicleName);
        const vehicleBadge = veh 
            ? `<span class="card-vehicle-badge">${veh.name}</span>` 
            : `<span class="card-vehicle-badge">${p._vehicleName || '?'}</span>`;
        
        const isSelected = selectedIds.has(p._uid);
        
        html += `
            <div class="lead-card ${statusClass} ${notifyClass} ${isSelected ? 'selected' : ''}" data-uid="${p._uid}">
                <div class="card-header" onclick="toggleRouteCardDetails('${p._uid}')">
                    <div class="card-checkbox-wrap">
                        <input type="checkbox" class="card-checkbox" ${isSelected ? 'checked' : ''} onclick="event.stopPropagation();toggleSelect('${p._uid}')">
                        <span class="route-order-num">${idx + 1}</span>
                    </div>
                    <div class="card-body">
                        <div class="card-top-row">
                            <span class="card-phone">${p.phone || '—'}</span>
                            <span class="card-seats">👥 ${p.weight || ''}</span>
                            <span class="card-date">${p.date || '—'}</span>
                            ${p.payment ? `<span class="card-price">💰 ${p.payment}</span>` : ''}
                        </div>
                        <div class="card-row2-wrap">
                            <div class="card-route-row">
                                <span class="card-route">📍 ${p.address || '?'}${p.ttn ? ` <span style="color:var(--info);font-size:10px;">ТТН: ${p.ttn}</span>` : ''}</span>
                            </div>
                            <div class="card-info-row">
                                <span class="card-id">${p.id || '—'}</span>
                                <span class="card-name">${p.name || '—'}</span>
                            </div>
                        </div>
                        <div style="margin-top:6px;display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
                            ${statusBadge}
                            ${notifyBadge}
                            ${p.timing ? `<span style="font-size:10px;color:#666;">⏰ ${p.timing}</span>` : ''}
                        </div>
                        ${p.note ? `<div style="font-size:10px;color:#666;margin-top:4px;font-style:italic;">📝 ${p.note}</div>` : ''}
                    </div>
                    <div class="card-right-section">
                        <div class="card-vehicle">
                            ${vehicleBadge}
                        </div>
                        <span class="card-expand-icon">▼</span>
                    </div>
                </div>
                <div class="card-details" id="details_${p._uid}" style="display:none;">
                    <div class="details-grid">
                        <div class="detail-item"><span class="detail-label">📞 Телефон</span><span class="detail-value">${p.phone || '—'}</span></div>
                        <div class="detail-item"><span class="detail-label">📞 Реєстратор</span><span class="detail-value">${p.phoneReg || '—'}</span></div>
                        <div class="detail-item"><span class="detail-label">👤 ПІБ</span><span class="detail-value">${p.name || '—'}</span></div>
                        <div class="detail-item"><span class="detail-label">📦 Вага</span><span class="detail-value">${p.weight ? p.weight + ' кг' : '—'}</span></div>
                        <div class="detail-item"><span class="detail-label">📍 Адреса</span><span class="detail-value">${p.address || '—'}</span></div>
                        <div class="detail-item"><span class="detail-label">📋 ТТН</span><span class="detail-value">${p.ttn || '—'}</span></div>
                        <div class="detail-item"><span class="detail-label">💰 Сума</span><span class="detail-value">${p.amount ? '€' + p.amount : '—'}</span></div>
                        <div class="detail-item"><span class="detail-label">💳 Оплата</span><span class="detail-value">${p.payment || '—'}</span></div>
                        <div class="detail-item"><span class="detail-label">⏰ Таймінг</span><span class="detail-value">${p.timing || '—'}</span></div>
                        <div class="detail-item"><span class="detail-label">📅 Дата</span><span class="detail-value">${p.dateReg || '—'}</span></div>
                        <div class="detail-item"><span class="detail-label">👨‍💼 Диспетчер</span><span class="detail-value">${p.dispatcher || '—'}</span></div>
                        <div class="detail-item"><span class="detail-label">⚖️ Вага</span><span class="detail-value">${p.weight || '—'}</span></div>
                    </div>
                    ${p.note ? `<div class="detail-note"><span class="detail-label">📝 Примітка</span><div>${p.note}</div></div>` : ''}
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Фільтр по статусу в маршруті
function filterRouteByStatus(status) {
    routeStatusFilter = status;
    renderRoutePassengers();
}

// Розгортання деталей картки маршруту
function toggleRouteCardDetails(uid) {
    const details = document.getElementById('details_' + uid);
    const card = details?.closest('.lead-card');
    if (!details || !card) return;
    
    const isOpen = details.style.display !== 'none';
    
    // Закриваємо всі інші
    document.querySelectorAll('.card-details').forEach(d => {
        d.style.display = 'none';
        d.closest('.lead-card')?.classList.remove('expanded');
    });
    
    // Відкриваємо/закриваємо поточну
    if (!isOpen) {
        details.style.display = 'block';
        card.classList.add('expanded');
    }
}

// Оновити кількість в маршрутах (викликається при відкритті dropdown)
function updateRoutesCounts() {
    vehicles.forEach(v => {
        fetch(ROUTE_API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain' },
            body: JSON.stringify({
                action: 'getRoutePassengers',
                payload: { vehicleName: v.name }
            })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                // Оновлюємо badge в dropdown
                const badges = document.querySelectorAll(`[data-route-vehicle="${v.id}"] .side-menu-item-count, [data-route-count="${v.id}"]`);
                badges.forEach(badge => {
                    badge.textContent = data.stats.total;
                });
            }
        })
        .catch(() => {});
    });
}

function updateFilterButtons() {
    if (filters.date) {
        const d = new Date(filters.date);
        document.getElementById('dateLabel').textContent = d.getDate() + ' ' + d.toLocaleDateString('uk',{month:'short'});
        document.getElementById('dateCount').style.display = 'inline';
        document.getElementById('dateCount').textContent = getFilteredData().length;
        document.getElementById('btnDate').classList.add('active');
    } else {
        document.getElementById('dateLabel').textContent = 'Дата';
        document.getElementById('dateCount').style.display = 'none';
        document.getElementById('btnDate').classList.remove('active');
    }
    document.getElementById('btnArchive')?.classList.toggle('active', filters.showArchive);
    document.getElementById('btnRoute')?.classList.toggle('active', filters.statusFilter === 'route');
}

function toggleDropdown(id) { document.querySelectorAll('.dropdown-menu').forEach(d => { if(d.id !== id) d.classList.remove('show'); }); document.getElementById(id).classList.toggle('show'); if(id === 'dateDropdown') renderCalendarTo('desktopCalendar'); }
function resetFilters() { filters.date = ''; filters.vehicle = ''; filters.showArchive = false; filters.statusFilter = ''; filters.routeVehicle = ''; routePassengers = []; routeStats = { total: 0, pending: 0, inProgress: 0, completed: 0, cancelled: 0, archived: 0 }; currentRouteVehicle = null; routeStatusFilter = 'all'; render(); renderCalendars(); updateVehiclesList(); updateAllCounts(); updatePcVehiclesList(); }
function setVehicleFilter(id) { 
    filters.vehicle = id; 
    filters.statusFilter = ''; 
    filters.routeVehicle = '';
    routePassengers = [];
    routeStats = { total: 0, pending: 0, inProgress: 0, completed: 0, cancelled: 0, archived: 0 };
    currentRouteVehicle = null;
    routeStatusFilter = 'all';
    document.getElementById('vehicleDropdown')?.classList.remove('show'); 
    render(); 
    updatePcVehiclesList();
}
function filterByStatus(status) { filters.statusFilter = filters.statusFilter === status ? '' : status; filters.showArchive = false; filters.routeVehicle = ''; routePassengers = []; routeStats = { total: 0, pending: 0, inProgress: 0, completed: 0, cancelled: 0, archived: 0 }; currentRouteVehicle = null; routeStatusFilter = 'all'; render(); updateFilterButtons(); }
function toggleArchiveFilter() { filters.showArchive = !filters.showArchive; filters.statusFilter = ''; filters.routeVehicle = ''; routePassengers = []; routeStats = { total: 0, pending: 0, inProgress: 0, completed: 0, cancelled: 0, archived: 0 }; currentRouteVehicle = null; routeStatusFilter = 'all'; render(); updateAllCounts(); updateFilterButtons(); }

// SINGLE ACTIONS
function moveOneToRoute(id) {
    const p = packages.find(x => x.id === id);
    if (!p) return;
    if (!p.vehicle) return showToast('⚠️ Спочатку призначте авто');
    p.status = 'route';
    saveSettings();
    render();
    updateAllCounts();
    showToast('🚀 В маршруті');
}

function archivePackage(id) {
    const p = packages.find(x => x.id === id);
    if (p) { p.status = 'archived'; saveSettings(); render(); updateAllCounts(); renderCalendars(); showToast('📦 В архіві'); }
}

function restorePackage(id) {
    const p = packages.find(x => x.id === id);
    if (p) { p.status = 'new'; saveSettings(); render(); updateAllCounts(); renderCalendars(); showToast('♻️ Відновлено'); }
}

function bulkRestore() {
    if (selectedIds.size === 0) return showToast('⚠️ Оберіть заявки');
    
    const closedStatuses = ['archived', 'refused', 'transferred', 'deleted'];
    
    // Збираємо дані для API
    const packagesToRestore = [];
    selectedIds.forEach(uid => {
        const p = findPackageByUid(uid);
        if (p && p._sheet && p._rowNum && closedStatuses.includes(p.status)) {
            packagesToRestore.push({
                sheet: p._sheet,
                rowNum: p._rowNum
            });
        }
    });
    
    if (packagesToRestore.length === 0) {
        return showToast('⚠️ Немає заявок для відновлення');
    }
    
    showLoader('Відновлюю...', '');
    
    // Викликаємо API
    fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({
            action: 'bulkUpdateStatus',
            items: packagesToRestore,
            status: 'new'
        })
    })
    .then(r => r.json())
    .then(data => {
        hideLoader();
        if (data.success) {
            // Оновлюємо локально
            selectedIds.forEach(uid => {
                const p = findPackageByUid(uid);
                if (p && closedStatuses.includes(p.status)) {
                    p.status = 'new';
                    p.statusDate = '';
                    // Очищаємо причину відмови/пересадки з примітки
                    if (p.note) {
                        p.note = p.note.replace(/^(Відмова|Перенос|Видалено):.*?\|?\s*/i, '');
                    }
                }
            });
            clearSelection();
            render();
            updateAllCounts();
            showToast(`↩️ Відновлено: ${data.restored || packagesToRestore.length}`);
        } else {
            showToast('❌ ' + data.error);
        }
    })
    .catch(err => {
        hideLoader();
        console.error('Restore error:', err);
        // Відновлюємо локально
        selectedIds.forEach(uid => {
            const p = findPackageByUid(uid);
            if (p && closedStatuses.includes(p.status)) {
                p.status = 'new';
                p.statusDate = '';
            }
        });
        clearSelection();
        saveSettings();
        render();
        updateAllCounts();
        showToast('↩️ Відновлено локально');
    });
}

// Відмітити як сповіщених
function bulkMarkNotified() {
    if (selectedIds.size === 0) return showToast('⚠️ Оберіть пасажирів');
    
    // Питаємо ім'я (поки немає системи логіну)
    const userName = prompt('Введіть ваше ім\'я:');
    if (!userName || !userName.trim()) {
        return showToast('⚠️ Введіть ім\'я');
    }
    
    // Збираємо записи для додавання
    const records = [];
    selectedIds.forEach(uid => {
        // Шукаємо в routePassengers (бо ми в режимі маршруту)
        const p = routePassengers.find(x => x._uid === uid);
        if (p && p.id) {
            // Перевіряємо чи вже не сповіщений
            if (!mailingIds.includes(String(p.id))) {
                records.push({
                    date: p.date || new Date().toLocaleDateString('uk-UA'),
                    id: p.id
                });
            }
        }
    });
    
    if (records.length === 0) {
        return showToast('⚠️ Всі вибрані вже сповіщені');
    }
    
    showLoader('Збереження...', '');
    
    fetch(ROUTE_API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({
            action: 'addMailingRecord',
            payload: {
                records: records,
                userName: userName.trim()
            }
        })
    })
    .then(r => r.json())
    .then(data => {
        hideLoader();
        if (data.success) {
            // Оновлюємо локальний список mailingIds
            records.forEach(r => mailingIds.push(String(r.id)));
            
            clearSelection();
            renderRoutePassengers();
            showToast(`🔔 Сповіщено: ${data.added}`);
        } else {
            showToast('❌ ' + data.error);
        }
    })
    .catch(err => {
        hideLoader();
        console.error('Mailing error:', err);
        showToast('❌ Помилка збереження');
    });
}

// BULK ACTIONS
let selectedBulkVehicleId = null;

function openBulkVehicleModal() {
    selectedBulkVehicleId = null;
    document.getElementById('bulkVehicleCount').textContent = selectedIds.size;
    document.getElementById('bulkVehicleList').innerHTML = vehicles.map(v => {
        const assigned = packages.filter(p => (p.vehicle === v.id || p.vehicle === v.name) && p.status !== 'archived').length;
        const weightUsed = packages.filter(p => (p.vehicle === v.id || p.vehicle === v.name) && p.status !== 'archived').reduce((s, p) => s + (parseFloat(p.weight) || 0), 0);
        return `<div class="vehicle-select-item" id="vsi_${v.id}" onclick="selectBulkVehicle('${v.id}')" style="transition:all 0.2s;">
            <div style="display:flex;align-items:center;gap:12px;">
                <div style="width:40px;height:40px;background:linear-gradient(135deg,#1a3a5e,#2563eb);border-radius:10px;display:flex;align-items:center;justify-content:center;color:white;font-size:18px;flex-shrink:0;">🚐</div>
                <div>
                    <div style="font-weight:700;font-size:14px;color:var(--text-primary);">${v.name}</div>
                    <div style="font-size:11px;color:var(--text-secondary);margin-top:2px;">📦 ${assigned} посилок · ⚖️ ${weightUsed.toFixed(0)}/${v.maxWeight || 2000} кг</div>
                </div>
            </div>
            <div style="width:22px;height:22px;border:2px solid var(--border);border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0;" id="vsi_check_${v.id}"></div>
        </div>`;
    }).join('');
    const btn = document.getElementById('bulkVehicleConfirmBtn');
    btn.disabled = true;
    btn.style.opacity = '0.5';
    document.getElementById('bulkVehicleModal').classList.add('show');
}

function selectBulkVehicle(vehicleId) {
    selectedBulkVehicleId = vehicleId;
    // Update UI
    vehicles.forEach(v => {
        const item = document.getElementById('vsi_' + v.id);
        const check = document.getElementById('vsi_check_' + v.id);
        if (v.id === vehicleId) {
            item.style.borderColor = 'var(--primary)';
            item.style.background = '#f0f7ff';
            check.innerHTML = '<span style="color:var(--primary);font-size:14px;">✓</span>';
            check.style.borderColor = 'var(--primary)';
            check.style.background = '#e0edff';
        } else {
            item.style.borderColor = 'var(--border)';
            item.style.background = '';
            check.innerHTML = '';
            check.style.borderColor = 'var(--border)';
            check.style.background = '';
        }
    });
    const btn = document.getElementById('bulkVehicleConfirmBtn');
    btn.disabled = false;
    btn.style.opacity = '1';
}

function confirmBulkVehicle() {
    if (!selectedBulkVehicleId) return;
    saveForUndo('vehicle');
    let count = 0;
    selectedIds.forEach(uid => {
        const p = findPackageByUid(uid);
        if (p && p.status !== 'archived') {
            p.vehicle = selectedBulkVehicleId;
            if (p.status === 'new') p.status = 'work';
            updatePackageOnServer(p);
            count++;
        }
    });
    saveSettings();
    closeModal('bulkVehicleModal');
    clearSelection();
    render();
    updateAllCounts();
    showToast(`🚐 Авто призначено: ${count}`);
}

// Keep old function for backward compat
function bulkAssignVehicle(vehicleId) {
    selectedBulkVehicleId = vehicleId;
    confirmBulkVehicle();
}

function bulkMoveToRoute() {
    // Збираємо вибраних пасажирів
    const selected = [...selectedIds].map(uid => findPackageByUid(uid)).filter(Boolean);
    if (!selected.length) return showToast('⚠️ Оберіть пасажирів');
    
    // Перевіряємо чи є авто
    const withVehicle = selected.filter(p => p.vehicle);
    if (!withVehicle.length) return showToast('⚠️ Спочатку призначте авто');
    
    // Групуємо по авто
    const byVehicle = {};
    withVehicle.forEach(p => {
        const veh = vehicles.find(v => v.id === p.vehicle || v.name === p.vehicle);
        const vName = veh ? veh.name : p.vehicle;
        if (!byVehicle[vName]) byVehicle[vName] = [];
        byVehicle[vName].push(p);
    });
    
    // Показуємо завантаження
    showToast('🔍 Перевіряю маршрути...');
    
    // Спочатку перевіряємо чи є записи в маршрутах
    fetch(ROUTE_API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({
            action: 'checkRouteSheets',
            payload: { vehicleNames: Object.keys(byVehicle) }
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success && data.existing && data.existing.length > 0) {
            // Є існуючі записи - показуємо діалог
            showRouteConflictModal(data.existing, byVehicle, withVehicle);
        } else {
            // Немає конфліктів - копіюємо
            executeCopyToRoute(byVehicle, withVehicle, 'add');
        }
    })
    .catch(err => {
        console.error('Check route error:', err);
        // При помилці все одно пробуємо копіювати
        executeCopyToRoute(byVehicle, withVehicle, 'add');
    });
}

// Модалка конфлікту маршрутів
function showRouteConflictModal(existing, byVehicle, withVehicle) {
    const list = existing.map(e => `<div style="padding:8px;background:var(--bg-main);border-radius:6px;margin-bottom:6px;">
        <strong>🚐 ${e.vehicle}</strong>: ${e.count} записів
    </div>`).join('');
    
    const modal = document.createElement('div');
    modal.className = 'modal-overlay show';
    modal.id = 'routeConflictModal';
    modal.innerHTML = `
        <div class="modal" style="max-width:380px">
            <div class="modal-header" style="background:var(--warning)">
                <span class="modal-title">⚠️ В маршрутах вже є записи</span>
                <button class="modal-close" onclick="closeModal('routeConflictModal')">×</button>
            </div>
            <div class="modal-body">
                <p style="font-size:12px;color:var(--text-secondary);margin-bottom:12px;">
                    Знайдено існуючі записи в маршрутах:
                </p>
                ${list}
                <p style="font-size:12px;color:var(--text-secondary);margin-top:12px;">
                    Що зробити зі старими записами?
                </p>
            </div>
            <div class="modal-footer" style="flex-wrap:wrap;gap:6px;">
                <button class="btn-cancel" onclick="closeModal('routeConflictModal')" style="flex:1 1 45%;">❌ Скасувати</button>
                <button class="btn-save" onclick="handleRouteConflict('add')" style="flex:1 1 45%;background:var(--info);">➕ Додати</button>
                <button class="btn-save" onclick="handleRouteConflict('archive')" style="flex:1 1 45%;background:var(--warning);">📦 Архівувати</button>
                <button class="btn-save" onclick="handleRouteConflict('clear')" style="flex:1 1 45%;background:var(--danger);">🗑️ Очистити</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    
    // Зберігаємо дані для використання
    window._routeConflictData = { byVehicle, withVehicle };
}

function handleRouteConflict(action) {
    const { byVehicle, withVehicle } = window._routeConflictData;
    closeModal('routeConflictModal');
    executeCopyToRoute(byVehicle, withVehicle, action);
}

function executeCopyToRoute(byVehicle, withVehicle, conflictAction) {
    showToast('📤 Записую в маршрут...');
    
    const payload = {
        action: 'copyToRoute',
        payload: {
            packagesByVehicle: byVehicle,
            conflictAction: conflictAction // 'add', 'archive', 'clear'
        }
    };
    
    fetch(ROUTE_API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify(payload)
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            // Оновлюємо статус локально
            withVehicle.forEach(p => {
                p.status = 'route';
                p.mark = 'Маршрут';
            });
            saveSettings();
            clearSelection();
            render();
            updateAllCounts();
            
            let msg = `🚀 ${data.copied} записано в маршрут`;
            if (data.archived) msg += `, 📦 ${data.archived} архівовано`;
            if (data.cleared) msg += `, 🗑️ ${data.cleared} видалено`;
            showToast(msg);
        } else {
            showToast('❌ ' + data.error);
        }
    })
    .catch(err => {
        console.error('Route error:', err);
        showToast('❌ Помилка запису');
    });
}

function bulkArchive() {
    if (selectedIds.size === 0) return showToast('⚠️ Оберіть заявки');
    
    // Збираємо дані для API
    const packagesToArchive = [];
    selectedIds.forEach(uid => {
        const p = findPackageByUid(uid);
        if (p && p._sheet && p._rowNum) {
            packagesToArchive.push({
                sheet: p._sheet,
                rowNum: p._rowNum
            });
        }
    });
    
    if (packagesToArchive.length === 0) {
        return showToast('⚠️ Немає заявок для архівації');
    }
    
    showLoader('Архівую...', '');
    
    // Викликаємо API
    fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({
            action: 'bulkUpdateStatus',
            items: packagesToArchive,
            status: 'archived'
        })
    })
    .then(r => r.json())
    .then(data => {
        hideLoader();
        if (data.success) {
            // Оновлюємо локально
            selectedIds.forEach(uid => {
                const p = findPackageByUid(uid);
                if (p) {
                    p.status = 'archived';
                    p.statusDate = new Date().toISOString().split('T')[0];
                }
            });
            clearSelection();
            render();
            updateAllCounts();
            renderCalendars();
            showToast(`📦 Архівовано: ${data.archived}`);
        } else {
            showToast('❌ ' + data.error);
        }
    })
    .catch(err => {
        hideLoader();
        console.error('Archive error:', err);
        showToast('❌ Помилка архівації');
    });
}

// ВІДМОВА - з вибором причини
function bulkRefuse() {
    if (selectedIds.size === 0) return showToast('⚠️ Оберіть заявки');
    showRefuseModal();
}

function showRefuseModal() {
    document.getElementById('refuseModal')?.remove();
    
    const reasons = [
        'Ціна доставки завелика',
        'Дата відправки не підходить',
        'Знайшов іншу доставку',
        'Передумав відправляти',
        'Посилка не готова',
        'Габарити не підходять',
        'Інше'
    ];
    
    const modal = document.createElement('div');
    modal.className = 'modal-overlay show';
    modal.id = 'refuseModal';
    modal.innerHTML = `
        <div class="modal" style="max-width:400px;">
            <div class="modal-header" style="background:#fee2e2;">
                <span class="modal-title" style="color:#dc2626;">❌ Причина відмови</span>
                <button class="modal-close" onclick="document.getElementById('refuseModal').remove()">✕</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom:12px;font-size:13px;color:var(--text-secondary);">Вибрано: <strong>${selectedIds.size}</strong> заявок</div>
                <div style="display:flex;flex-direction:column;gap:8px;">
                    ${reasons.map(r => `
                        <label style="display:flex;align-items:center;gap:10px;padding:10px;border:2px solid var(--border);border-radius:8px;cursor:pointer;">
                            <input type="radio" name="refuseReason" value="${r}" style="width:18px;height:18px;">
                            <span style="font-size:13px;">${r}</span>
                        </label>
                    `).join('')}
                </div>
                <div id="refuseOtherWrap" style="display:none;margin-top:10px;">
                    <input type="text" id="refuseOtherText" placeholder="Вкажіть причину..." style="width:100%;padding:10px;border:2px solid var(--border);border-radius:8px;font-family:inherit;">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="document.getElementById('refuseModal').remove()">Скасувати</button>
                <button class="btn-save" style="background:#dc2626;" onclick="confirmRefuse()">❌ Відмовити</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    
    // Показати поле "Інше" при виборі
    modal.querySelectorAll('input[name="refuseReason"]').forEach(input => {
        input.addEventListener('change', () => {
            document.getElementById('refuseOtherWrap').style.display = 
                input.value === 'Інше' ? 'block' : 'none';
        });
    });
}

function confirmRefuse() {
    const selected = document.querySelector('input[name="refuseReason"]:checked');
    if (!selected) return showToast('⚠️ Оберіть причину');
    
    let reason = selected.value;
    if (reason === 'Інше') {
        reason = document.getElementById('refuseOtherText')?.value || 'Інше';
    }
    
    document.getElementById('refuseModal').remove();
    applyStatusToSelected('refused', `Відмова: ${reason}`);
}

// ПЕРЕСАДКА - з вказанням кому
function bulkTransfer() {
    if (selectedIds.size === 0) return showToast('⚠️ Оберіть заявки');
    showTransferModal();
}

function showTransferModal() {
    document.getElementById('transferModal')?.remove();

    // Default to tomorrow
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    const defaultDate = tomorrow.toISOString().split('T')[0];

    const modal = document.createElement('div');
    modal.className = 'modal-overlay show';
    modal.id = 'transferModal';
    modal.innerHTML = `
        <div class="modal" style="max-width:420px;">
            <div class="modal-header" style="background:#ccfbf1;">
                <span class="modal-title" style="color:#0d9488;">📆 Перенос дати відправки</span>
                <button class="modal-close" onclick="document.getElementById('transferModal').remove()">✕</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom:16px;font-size:13px;color:var(--text-secondary);">Вибрано: <strong>${selectedIds.size}</strong> посилок</div>

                <label style="font-size:13px;font-weight:600;color:var(--text-primary);margin-bottom:8px;display:block;">📅 Нова дата відправки:</label>
                <input type="date" id="transferNewDate" value="${defaultDate}" style="width:100%;padding:12px;border:2px solid var(--border);border-radius:8px;font-family:inherit;font-size:14px;margin-bottom:16px;">

                <label style="font-size:13px;font-weight:600;color:var(--text-primary);margin-bottom:8px;display:block;">💬 Коментар (необов'язково):</label>
                <input type="text" id="transferComment" placeholder="Причина переносу..." style="width:100%;padding:12px;border:2px solid var(--border);border-radius:8px;font-family:inherit;font-size:14px;">
                <div style="margin-top:6px;font-size:11px;color:var(--text-secondary);">Наприклад: Клієнт попросив, Посилка не готова</div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="document.getElementById('transferModal').remove()">Скасувати</button>
                <button class="btn-save" style="background:#14b8a6;" onclick="confirmTransfer()">📆 Перенести дату</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    document.getElementById('transferNewDate')?.focus();
}

function confirmTransfer() {
    const newDate = document.getElementById('transferNewDate')?.value;
    if (!newDate) return showToast('⚠️ Оберіть нову дату відправки');

    const comment = document.getElementById('transferComment')?.value?.trim();
    const formattedDate = new Date(newDate).toLocaleDateString('uk-UA');
    const reason = comment ? `Перенос на ${formattedDate}: ${comment}` : `Перенос на ${formattedDate}`;

    // Update dateReceive for selected packages
    selectedIds.forEach(uid => {
        const p = findPackageByUid(uid);
        if (p) {
            p.dateReceive = newDate;
        }
    });

    document.getElementById('transferModal').remove();
    applyStatusToSelected('transferred', reason);
}

// ВИДАЛЕННЯ - з причиною
function bulkDelete() {
    if (selectedIds.size === 0) return showToast('⚠️ Оберіть заявки');
    showDeleteModal();
}

function showDeleteModal() {
    document.getElementById('deleteModal')?.remove();
    
    const modal = document.createElement('div');
    modal.className = 'modal-overlay show';
    modal.id = 'deleteModal';
    modal.innerHTML = `
        <div class="modal" style="max-width:400px;">
            <div class="modal-header" style="background:#f3f4f6;">
                <span class="modal-title" style="color:#6b7280;">🗑️ Видалення</span>
                <button class="modal-close" onclick="document.getElementById('deleteModal').remove()">✕</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom:12px;font-size:13px;color:var(--text-secondary);">Вибрано: <strong>${selectedIds.size}</strong> заявок</div>
                <label style="font-size:12px;font-weight:600;color:var(--text-secondary);margin-bottom:6px;display:block;">Причина видалення</label>
                <input type="text" id="deleteReasonText" placeholder="Дубль, тест, помилка..." style="width:100%;padding:12px;border:2px solid var(--border);border-radius:8px;font-family:inherit;font-size:14px;">
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="document.getElementById('deleteModal').remove()">Скасувати</button>
                <button class="btn-save" style="background:#6b7280;" onclick="confirmDelete()">🗑️ Видалити</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    document.getElementById('deleteReasonText')?.focus();
}

function confirmDelete() {
    const reason = document.getElementById('deleteReasonText')?.value?.trim() || 'Без причини';
    document.getElementById('deleteModal').remove();
    applyStatusToSelected('deleted', `Видалено: ${reason}`);
}

// ВИДАЛИТИ НАЗАВЖДИ
function bulkDeleteForever() {
    if (selectedIds.size === 0) return showToast('⚠️ Оберіть заявки');
    
    if (!confirm(`💀 УВАГА!\n\nВи точно хочете НАЗАВЖДИ видалити ${selectedIds.size} заявок?\n\nЦю дію НЕ МОЖНА скасувати!`)) {
        return;
    }
    
    showLoader('Видаляю назавжди...', '');
    
    // TODO: API для повного видалення
    // Поки що просто ховаємо локально
    selectedIds.forEach(uid => {
        const idx = packages.findIndex(p => {
            const pUid = (p._sheet && p._rowNum) ? `${p._sheet}_${p._rowNum}` : `local_${packages.indexOf(p)}`;
            return pUid === uid;
        });
        if (idx !== -1) {
            packages.splice(idx, 1);
        }
    });
    
    hideLoader();
    clearSelection();
    saveSettings();
    render();
    updateAllCounts();
    showToast(`💀 Видалено назавжди: ${selectedIds.size}`);
}

// Універсальна функція застосування статусу
function applyStatusToSelected(status, note) {
    showLoader('Обробка...', '');
    
    const today = new Date().toISOString().split('T')[0];
    let count = 0;
    
    selectedIds.forEach(uid => {
        const p = findPackageByUid(uid);
        if (p) {
            p.status = status;
            p.statusDate = today;
            p.note = note + (p.note ? ` | ${p.note}` : '');
            p.isNew = false;
            count++;
            
            // Оновлюємо на сервері якщо є дані
            if (p._sheet && p._rowNum) {
                updatePackageOnServer(p);
            }
        }
    });
    
    hideLoader();
    clearSelection();
    saveSettings();
    render();
    updateAllCounts();
    renderCalendars();
    
    const statusNames = {
        'refused': '❌ Відмова',
        'transferred': '📆 Перенос', 
        'deleted': '🗑️ Видалено',
        'archived': '📦 Архів'
    };
    showToast(`${statusNames[status] || status}: ${count}`);
}

// Показати фільтр по статусу
function showStatusFilter(status) {
    filters.showArchive = false;
    filters.statusFilter = '';
    filters.routeVehicle = '';
    filters.specialStatus = status; // Новий фільтр
    
    routePassengers = [];
    currentRouteVehicle = null;
    
    render();
    updateAllCounts();
    updateFilterButtons();
    showToast(`📋 ${getStatusName(status)}`);
}

function getStatusName(status) {
    const names = {
        'archived': '📦 Архів',
        'refused': '❌ Відмови',
        'transferred': '📆 Перенос',
        'deleted': '🗑️ Видалені'
    };
    return names[status] || status;
}

// SELECT ALL VISIBLE
function selectAllVisible() {
    const data = getFilteredData();
    const visibleUids = data.map((p, idx) => 
        (p._sheet && p._rowNum) ? `${p._sheet}_${p._rowNum}` : `local_${idx}`
    );
    
    // Перевіряємо чи всі вже вибрані
    const allSelected = visibleUids.every(uid => selectedIds.has(uid));
    
    if (allSelected) {
        // Знімаємо всі галочки (але НЕ ховаємо sidebar)
        visibleUids.forEach(uid => selectedIds.delete(uid));
        render();
        // Оновлюємо тільки лічильники, НЕ ховаємо панель
        document.getElementById('bulkCount').textContent = selectedIds.size;
        const sidebarCount = document.getElementById('bulkCountSidebar');
        if (sidebarCount) sidebarCount.textContent = selectedIds.size;
        showToast(`☐ Знято ${visibleUids.length}`);
    } else {
        // Ставимо всі галочки
        visibleUids.forEach(uid => selectedIds.add(uid));
        render();
        updateBulkBar();
        showToast(`☑️ Вибрано ${visibleUids.length}`);
    }
}

// ============================================
// ОПТИМІЗАЦІЯ МАРШРУТУ
// ============================================
let optimizeBy = 'from';
let optimizePackagesList = [];

function runOptimization() {
    // Беремо пасажирів по поточних фільтрах (дата + авто)
    const data = getFilteredData().filter(p => p.status !== 'archived');
    if (!data.length) return showToast('⚠️ Немає заявок для оптимізації');
    openOptimizeModal(data);
}

function bulkOptimize() {
    // Беремо вибраних пасажирів
    const selected = [...selectedIds].map(uid => findPackageByUid(uid)).filter(Boolean);
    if (!selected.length) return showToast('⚠️ Оберіть пасажирів');
    openOptimizeModal(selected);
}

function openOptimizeModal(passengersList) {
    optimizePackagesList = passengersList;
    optimizeBy = 'from';
    
    // Оновлюємо UI
    document.getElementById('optimizeCount').textContent = passengersList.length;
    document.getElementById('optimizeStart').value = '';
    document.getElementById('optimizeEnd').value = '';
    document.getElementById('optFrom').classList.add('selected');
    document.getElementById('optTo').classList.remove('selected');
    
    // Показуємо форму, ховаємо результат
    document.getElementById('optimizeFormBody').style.display = 'block';
    document.getElementById('optimizeResultBody').style.display = 'none';
    document.getElementById('optimizeLoadingBody').style.display = 'none';
    document.getElementById('optimizeFormFooter').style.display = 'flex';
    document.getElementById('optimizeResultFooter').style.display = 'none';
    
    document.getElementById('optimizeModal').classList.add('show');
}

function selectOptimizeBy(by) {
    optimizeBy = by;
    document.getElementById('optFrom').classList.toggle('selected', by === 'from');
    document.getElementById('optTo').classList.toggle('selected', by === 'to');
}

// Google Maps API key (same as Apps Script)
const GMAPS_API_KEY = 'AIzaSyCthPzhD6zDM9zR-re0R2ceohyhCRdawNc';
const DEFAULT_START = { lat: 48.6209, lng: 22.2879, name: 'Ужгород' };
const MAX_POINTS_PER_MAP = 25;

async function geocodeAddressClient(address) {
    try {
        const url = `https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(address)}&key=${GMAPS_API_KEY}&language=uk`;
        const resp = await fetch(url);
        const json = await resp.json();
        if (json.status === 'OK' && json.results && json.results.length > 0) {
            const loc = json.results[0].geometry.location;
            return { lat: loc.lat, lng: loc.lng };
        }
        return null;
    } catch(e) { return null; }
}

function haversineDistance(c1, c2) {
    const R = 6371;
    const dLat = (c2.lat - c1.lat) * Math.PI / 180;
    const dLng = (c2.lng - c1.lng) * Math.PI / 180;
    const a = Math.sin(dLat/2)**2 + Math.cos(c1.lat*Math.PI/180)*Math.cos(c2.lat*Math.PI/180)*Math.sin(dLng/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function nearestNeighborOrder(items, startCoords) {
    const n = items.length;
    if (n <= 1) return items.map((_, i) => i);

    const visited = new Array(n).fill(false);
    let currentIdx = 0;
    let minDist = Infinity;
    for (let i = 0; i < n; i++) {
        const d = haversineDistance(startCoords, items[i].coords);
        if (d < minDist) { minDist = d; currentIdx = i; }
    }

    const tour = [currentIdx];
    visited[currentIdx] = true;

    for (let step = 1; step < n; step++) {
        let nearest = -1, nearestDist = Infinity;
        for (let j = 0; j < n; j++) {
            if (!visited[j]) {
                const d = haversineDistance(items[currentIdx].coords, items[j].coords);
                if (d < nearestDist) { nearestDist = d; nearest = j; }
            }
        }
        if (nearest === -1) break;
        tour.push(nearest);
        visited[nearest] = true;
        currentIdx = nearest;
    }
    return tour;
}

function generateMapLinksClient(orderedItems, startCoords, endCoords) {
    const links = [];
    const total = orderedItems.length;
    if (!total) return links;

    const ppChunk = MAX_POINTS_PER_MAP - 1;
    let chunkStart = 0;

    while (chunkStart < total) {
        const chunkEnd = Math.min(chunkStart + ppChunk, total);
        const chunk = orderedItems.slice(chunkStart, chunkEnd);

        const origin = chunkStart === 0 ? startCoords.name : orderedItems[chunkStart - 1].address;
        let destination, waypointItems;

        if (chunkEnd >= total && endCoords) {
            destination = endCoords.name;
            waypointItems = chunk;
        } else {
            destination = chunk[chunk.length - 1].address;
            waypointItems = chunk.slice(0, -1);
        }

        let url = 'https://www.google.com/maps/dir/' + encodeURIComponent(origin);
        waypointItems.forEach(item => { url += '/' + encodeURIComponent(item.address); });
        url += '/' + encodeURIComponent(destination);

        links.push({ url, from: chunkStart + 1, to: chunkEnd, total });
        chunkStart = chunkEnd;
    }
    return links;
}

async function startOptimization() {
    if (!optimizePackagesList.length) return;

    document.getElementById('optimizeFormBody').style.display = 'none';
    document.getElementById('optimizeLoadingBody').style.display = 'block';
    document.getElementById('optimizeFormFooter').style.display = 'none';

    const startAddress = document.getElementById('optimizeStart').value.trim();
    const endAddress = document.getElementById('optimizeEnd').value.trim();

    try {
        // Resolve start coords
        let startCoords = { ...DEFAULT_START };
        if (startAddress) {
            const sc = await geocodeAddressClient(startAddress);
            if (sc) startCoords = { lat: sc.lat, lng: sc.lng, name: startAddress };
        }

        // Resolve end coords
        let endCoords = null;
        if (endAddress) {
            const ec = await geocodeAddressClient(endAddress);
            if (ec) endCoords = { lat: ec.lat, lng: ec.lng, name: endAddress };
        }

        // Geocode all packages
        const items = [];
        const notGeocoded = [];

        for (const p of optimizePackagesList) {
            const addr = optimizeBy === 'to' ? (p.address || '') : (p.address || '');
            if (!addr.trim()) {
                notGeocoded.push({ id: p.id, name: p.name, address: '(порожня адреса)', uid: (p._sheet && p._rowNum) ? `${p._sheet}_${p._rowNum}` : null });
                continue;
            }
            const coords = await geocodeAddressClient(addr);
            if (coords) {
                items.push({ ...p, coords, address: addr, _uid: (p._sheet && p._rowNum) ? `${p._sheet}_${p._rowNum}` : null });
            } else {
                notGeocoded.push({ id: p.id, name: p.name, address: addr, uid: (p._sheet && p._rowNum) ? `${p._sheet}_${p._rowNum}` : null });
            }
            await new Promise(r => setTimeout(r, 100)); // Delay for API rate
        }

        if (!items.length) {
            document.getElementById('optimizeFormBody').style.display = 'block';
            document.getElementById('optimizeLoadingBody').style.display = 'none';
            document.getElementById('optimizeFormFooter').style.display = 'flex';
            return showToast('❌ Жодну адресу не вдалось знайти');
        }

        // Nearest Neighbor
        const order = nearestNeighborOrder(items, startCoords);
        const orderedItems = order.map(i => items[i]);

        // Generate map links
        const mapLinks = generateMapLinksClient(orderedItems, startCoords, endCoords);

        // Calculate total distance
        let totalDist = haversineDistance(startCoords, orderedItems[0].coords);
        for (let i = 1; i < orderedItems.length; i++) {
            totalDist += haversineDistance(orderedItems[i-1].coords, orderedItems[i].coords);
        }

        const result = {
            success: true,
            optimizeBy: optimizeBy === 'from' ? 'Адреса відправника' : 'Адреса отримувача',
            start: startCoords.name,
            end: endCoords ? endCoords.name : orderedItems[orderedItems.length - 1].address,
            stats: {
                total: optimizePackagesList.length,
                geocoded: items.length,
                optimized: orderedItems.length
            },
            method: `Nearest Neighbor (~${totalDist.toFixed(0)} км)`,
            mapLinks: mapLinks,
            notGeocodedList: notGeocoded,
            orderedPassengers: orderedItems
        };

        showOptimizationResult(result);
    } catch(err) {
        console.error('Optimize error:', err);
        document.getElementById('optimizeFormBody').style.display = 'block';
        document.getElementById('optimizeLoadingBody').style.display = 'none';
        document.getElementById('optimizeFormFooter').style.display = 'flex';
        showToast('❌ Помилка: ' + err.message);
    }
}

function showOptimizationResult(data) {
    // Показуємо результат
    document.getElementById('optimizeLoadingBody').style.display = 'none';
    document.getElementById('optimizeResultBody').style.display = 'block';
    document.getElementById('optimizeResultFooter').style.display = 'flex';
    
    // Статистика
    const statsHtml = `
        <div class="optimize-stat-row">
            <span class="optimize-stat-label">📋 Оптимізація по:</span>
            <span class="optimize-stat-value">${data.optimizeBy}</span>
        </div>
        <div class="optimize-stat-row">
            <span class="optimize-stat-label">📍 Старт:</span>
            <span class="optimize-stat-value">${data.start}</span>
        </div>
        <div class="optimize-stat-row">
            <span class="optimize-stat-label">🏁 Фініш:</span>
            <span class="optimize-stat-value">${data.end}</span>
        </div>
        <div class="optimize-stat-row">
            <span class="optimize-stat-label">👥 Посилок:</span>
            <span class="optimize-stat-value">${data.stats.total}</span>
        </div>
        <div class="optimize-stat-row">
            <span class="optimize-stat-label">✅ Геокодовано:</span>
            <span class="optimize-stat-value">${data.stats.geocoded}</span>
        </div>
        <div class="optimize-stat-row">
            <span class="optimize-stat-label">✅ Оптимізовано:</span>
            <span class="optimize-stat-value">${data.stats.optimized}</span>
        </div>
        <div class="optimize-stat-row">
            <span class="optimize-stat-label">🗺️ Метод:</span>
            <span class="optimize-stat-value">${data.method}</span>
        </div>
        <div class="optimize-stat-row">
            <span class="optimize-stat-label">🔗 Карта:</span>
            <span class="optimize-stat-value">${data.mapLinks.length} посилань</span>
        </div>
    `;
    document.getElementById('optimizeStats').innerHTML = statsHtml;
    
    // Не геокодовані адреси
    if (data.notGeocodedList && data.notGeocodedList.length > 0) {
        document.getElementById('optimizeNotGeocoded').style.display = 'block';
        const listHtml = data.notGeocodedList.map(item => 
            `<div class="optimize-not-geocoded-item">
                <strong>${item.id}</strong> ${item.name ? '(' + item.name + ')' : ''}<br>
                <small>${item.address}</small>
            </div>`
        ).join('');
        document.getElementById('optimizeNotGeocodedList').innerHTML = listHtml;
    } else {
        document.getElementById('optimizeNotGeocoded').style.display = 'none';
    }
    
    // Посилання на карту
    let mapHtml = '';
    if (data.mapLinks.length === 1) {
        mapHtml = `<a href="${data.mapLinks[0].url}" target="_blank" class="optimize-map-btn">🗺️ Відкрити маршрут на карті</a>`;
    } else {
        mapHtml = data.mapLinks.map((link, i) => 
            `<a href="${link.url}" target="_blank" class="optimize-map-btn">🗺️ Частина ${i + 1} з ${data.mapLinks.length} (точки ${link.from} - ${link.to})</a>`
        ).join('');
    }
    document.getElementById('optimizeMapLinks').innerHTML = mapHtml;
    
    // Оновлюємо порядок пасажирів в CRM
    applyOptimizedOrder(data.orderedPassengers, data.notGeocodedList);
}

function applyOptimizedOrder(orderedPassengers, notGeocodedList) {
    // Створюємо Set з uid не геокодованих
    const notGeocodedUids = new Set();
    if (notGeocodedList) {
        notGeocodedList.forEach(item => {
            if (item.uid) notGeocodedUids.add(item.uid);
        });
    }
    
    // Оновлюємо порядок в масиві packages
    orderedPassengers.forEach((op, idx) => {
        const uid = op._uid || (op._sheet && op._rowNum ? `${op._sheet}_${op._rowNum}` : null);
        if (!uid) return;
        
        const p = findPackageByUid(uid);
        if (p) {
            p.order = idx;
            p.status = 'optimize';
            p._notGeocoded = notGeocodedUids.has(uid);
        }
    });
    
    saveSettings();
    clearSelection();
    render();
    updateAllCounts();
}

// UNDO SYSTEM
function saveForUndo(action) {
    // Зберігаємо копію стану вибраних пасажирів
    const snapshot = [...selectedIds].map(id => {
        const p = packages.find(x => x.id === id);
        return p ? { ...p } : null;
    }).filter(Boolean);
    
    undoHistory.push({ action, snapshot, timestamp: Date.now() });
    
    // Максимум 10 дій в історії
    if (undoHistory.length > 10) undoHistory.shift();
    
    // Показуємо кнопку undo
    document.getElementById('btnUndo').style.display = 'flex';
}

function undoLastAction() {
    if (!undoHistory.length) return showToast('↩️ Немає дій для відміни');
    
    const last = undoHistory.pop();
    
    // Відновлюємо стан посилок
    last.snapshot.forEach(snap => {
        const idx = packages.findIndex(p => p.id === snap.id);
        if (idx !== -1) {
            packages[idx] = { ...snap };
        }
    });
    
    saveSettings();
    render();
    updateAllCounts();
    renderCalendars();
    
    // Ховаємо кнопку якщо історія пуста
    if (!undoHistory.length) {
        document.getElementById('btnUndo').style.display = 'none';
    }
    
    showToast(`↩️ Відмінено: ${last.action}`);
}

// VEHICLES
function updateVehiclesList() {
    document.getElementById('vehiclesList').innerHTML = vehicles.map(v => {
        // Базовий фільтр: авто + не архів
        let filtered = packages.filter(p => (p.vehicle === v.id || p.vehicle === v.name) && p.status !== 'archived');
        
        // Фільтр по напрямку
        if (filters.direction && filters.direction !== 'all') {
            filtered = filtered.filter(p => p.direction === filters.direction);
        }
        
        // Фільтр по даті
        if (filters.date) {
            filtered = filtered.filter(p => (p.dateReceive || p.dateReg) === filters.date);
        }

        const count = filtered.length;
        return `<div class="dropdown-item" onclick="setVehicleFilter('${v.id}')">${v.name} <span class="badge">${count}</span></div>`;
    }).join('');
    document.getElementById('fVehicle').innerHTML = '<option value="">—</option>' + vehicles.map(v => `<option value="${v.name}">${v.name}</option>`).join('');

    // Оновлюємо "Без авто" теж з фільтрами
    let noVehicle = packages.filter(p => !p.vehicle && p.status !== 'archived');
    if (filters.direction && filters.direction !== 'all') {
        noVehicle = noVehicle.filter(p => p.direction === filters.direction);
    }
    if (filters.date) {
        noVehicle = noVehicle.filter(p => (p.dateReceive || p.dateReg) === filters.date);
    }
    document.getElementById('countNoVehicle').textContent = noVehicle.length;
}

function openAddVehicleModal() {
    document.getElementById('vehicleDropdown')?.classList.remove('show');
    document.getElementById('vName').value = '';
    document.getElementById('vWeight').value = 2000;
    document.getElementById('vPoints').value = 60;
    document.getElementById('vehicleModal').classList.add('show');
}

function saveVehicle() {
    const name = document.getElementById('vName').value.trim();
    const maxWeight = parseInt(document.getElementById('vWeight').value) || 2000;
    const maxPoints = parseInt(document.getElementById('vPoints').value) || 60;

    if (!name) return showToast('Введіть назву авто');

    if (vehicles.find(v => v.name.toLowerCase() === name.toLowerCase())) {
        return showToast('Авто з такою назвою вже існує');
    }

    const newVehicle = {
        id: 'v' + Date.now(),
        name: name,
        maxWeight: maxWeight,
        maxPoints: maxPoints
    };
    vehicles.push(newVehicle);
    saveSettings();
    updateVehiclesList();
    updateMobileVehicles();
    updateRoutesList();
    updatePcVehiclesList();
    updateAllCounts();
    closeModal('vehicleModal');
    showToast(`${name} створено`);
}

// Видалення авто
function deleteVehicle(vehicleId) {
    const v = vehicles.find(x => x.id === vehicleId);
    if (!v) return showToast('❌ Авто не знайдено');
    
    if (!confirm(`Видалити авто "${v.name}" та його аркуш маршруту?`)) {
        return;
    }
    
    showToast('🗑️ Видаляю...');
    
    // Видаляємо аркуш на сервері
    fetch(ROUTE_API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({
            action: 'deleteRouteSheet',
            payload: { vehicleName: v.name, force: true }
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            // Видаляємо локально
            vehicles = vehicles.filter(x => x.id !== vehicleId);
            saveSettings();
            updateVehiclesList();
            updateMobileVehicles();
            updateRoutesList();
            updatePcVehiclesList();
            updateAllCounts();
            showToast(`🗑️ ${v.name} видалено`);
        } else {
            showToast('❌ ' + data.error);
        }
    })
    .catch(err => {
        console.error('Delete vehicle error:', err);
        showToast('❌ Помилка видалення');
    });
}

// PACKAGES
function openAddModal() {
    editingId = null;
    document.getElementById('packageModalTitle').textContent = 'Додати посилку';
    document.getElementById('fDirection').value = filters.direction !== 'all' ? filters.direction : 'ua-eu';
    ['fName','fPhone','fPhoneReg','fAddress','fTtn','fWeight','fAmount','fTiming','fNote','fSmsNote'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
    });
    const payStatus = document.getElementById('fPayStatus');
    if (payStatus) payStatus.value = '';
    const payment = document.getElementById('fPayment');
    if (payment) payment.value = '';
    const vo = document.getElementById('fVo');
    if (vo) vo.value = '';
    const parcelStatus = document.getElementById('fParcelStatus');
    if (parcelStatus) parcelStatus.value = '';
    document.getElementById('fVehicle').value = filters.vehicle || '';
    document.getElementById('fDateReg').value = new Date().toISOString().split('T')[0];
    document.getElementById('packageModal').classList.add('show');
}

function editPackage(uid) {
    const p = findPackageByUid(uid);
    if (!p) return;
    editingId = uid;
    updateVehiclesList();
    document.getElementById('packageModalTitle').textContent = 'Редагувати посилку';
    document.getElementById('fDirection').value = p.direction || 'ua-eu';
    document.getElementById('fName').value = p.name || '';
    document.getElementById('fPhone').value = p.phone || '';
    document.getElementById('fPhoneReg').value = p.phoneReg || '';
    document.getElementById('fAddress').value = p.address || '';
    document.getElementById('fTtn').value = p.ttn || '';
    document.getElementById('fWeight').value = p.weight || '';
    document.getElementById('fAmount').value = p.amount || '';
    const payStatus = document.getElementById('fPayStatus');
    if (payStatus) payStatus.value = p.payStatus || '';
    const payment = document.getElementById('fPayment');
    if (payment) payment.value = p.payment || '';
    const vo = document.getElementById('fVo');
    if (vo) vo.value = p.vo || '';
    const parcelStatus = document.getElementById('fParcelStatus');
    if (parcelStatus) parcelStatus.value = p.parcelStatus || '';
    document.getElementById('fVehicle').value = p.vehicle || '';
    document.getElementById('fTiming').value = p.timing || '';
    document.getElementById('fDateReg').value = p.dateReg || '';
    document.getElementById('fNote').value = p.note || '';
    const smsNote = document.getElementById('fSmsNote');
    if (smsNote) smsNote.value = p.smsNote || '';
    openActionsId = null;
    document.querySelectorAll('.card-actions').forEach(el => el.classList.remove('show'));
    document.querySelectorAll('.card-actions-toggle').forEach(el => el.classList.remove('open'));
    document.getElementById('packageModal').classList.add('show');
}

// Видалення ліда (в архів з підтвердженням)
function deletePackage(uid) {
    const p = findPackageByUid(uid);
    if (!p) return;
    
    // Показуємо модалку підтвердження
    const name = p.name || 'Без імені';
    const phone = p.phone || '—';
    const id = p.id || '—';
    
    showDeleteConfirmModal(uid, `${name} (${phone})`, id);
}

function showDeleteConfirmModal(uid, displayName, passengerId) {
    document.getElementById('deleteConfirmModal')?.remove();
    
    const modal = document.createElement('div');
    modal.className = 'modal-overlay show';
    modal.id = 'deleteConfirmModal';
    modal.innerHTML = `
        <div class="modal" style="max-width:400px;">
            <div class="modal-header" style="background:#fee2e2;border-bottom:1px solid #fecaca;">
                <span class="modal-title" style="color:#dc2626;">🗑️ Видалити ліда?</span>
                <button class="modal-close" onclick="document.getElementById('deleteConfirmModal').remove()">✕</button>
            </div>
            <div class="modal-body" style="text-align:center;padding:24px;">
                <div style="font-size:48px;margin-bottom:16px;">⚠️</div>
                <div style="font-size:14px;margin-bottom:8px;">Ви впевнені що хочете видалити:</div>
                <div style="font-size:16px;font-weight:700;color:var(--primary);margin-bottom:4px;">${displayName}</div>
                <div style="font-size:12px;color:var(--text-secondary);margin-bottom:16px;">ID: ${passengerId}</div>
                <div style="background:#fef3c7;padding:12px;border-radius:8px;font-size:12px;color:#92400e;">
                    Лід буде переміщений в <strong>Архів</strong>.<br>
                    Ви зможете відновити його пізніше.
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="document.getElementById('deleteConfirmModal').remove()">Скасувати</button>
                <button class="btn-save" style="background:#dc2626;" onclick="confirmDeletePassenger('${uid}')">🗑️ Видалити</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function confirmDeletePassenger(uid) {
    document.getElementById('deleteConfirmModal')?.remove();
    
    const p = findPackageByUid(uid);
    if (!p) return;
    
    // Встановлюємо статус archived та дату
    p.status = 'archived';
    p.archiveDate = new Date().toISOString().split('T')[0];
    p.isNew = false;
    
    // Закриваємо дії картки
    openActionsId = null;
    
    // Якщо є серверні дані - архівуємо на сервері
    if (p._sheet && p._rowNum) {
        showLoader('Видалення...', '');
        
        fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain' },
            body: JSON.stringify({
                action: 'updateStatus',
                sheet: p._sheet,
                rowNum: p._rowNum,
                status: 'archived'
            })
        })
        .then(r => r.json())
        .then(data => {
            hideLoader();
            if (data.success) {
                saveSettings();
                render();
                updateAllCounts();
                showToast('🗑️ Переміщено в архів');
            } else {
                showToast('❌ ' + (data.error || 'Помилка'));
            }
        })
        .catch(err => {
            hideLoader();
            console.error('Delete error:', err);
            // Все одно зберігаємо локально
            saveSettings();
            render();
            updateAllCounts();
            showToast('🗑️ Видалено локально');
        });
    } else {
        // Локальний лід - просто оновлюємо
        saveSettings();
        render();
        updateAllCounts();
        showToast('🗑️ Переміщено в архів');
    }
}

function savePackage() {
    const isEditing = !!editingId;
    const existingP = isEditing ? findPackageByUid(editingId) : null;

    const d = {
        id: existingP?.id || 'pkg_' + Date.now(),
        direction: document.getElementById('fDirection').value,
        name: document.getElementById('fName').value || '',
        phone: document.getElementById('fPhone').value,
        phoneReg: document.getElementById('fPhoneReg').value,
        address: document.getElementById('fAddress').value,
        ttn: document.getElementById('fTtn').value,
        weight: document.getElementById('fWeight').value,
        amount: document.getElementById('fAmount').value,
        payStatus: document.getElementById('fPayStatus')?.value || '',
        payment: document.getElementById('fPayment')?.value || '',
        vo: document.getElementById('fVo')?.value || '',
        parcelStatus: document.getElementById('fParcelStatus')?.value || '',
        vehicle: document.getElementById('fVehicle').value,
        timing: document.getElementById('fTiming').value,
        dateReg: document.getElementById('fDateReg').value,
        note: document.getElementById('fNote').value,
        smsNote: document.getElementById('fSmsNote')?.value || '',
        status: existingP?.status || '',
        isNew: !editingId,
        order: packages.length * 10
    }; 
    
    if (isEditing && existingP) {
        // Знаходимо індекс в масиві
        const i = packages.findIndex(p => p._sheet === existingP._sheet && p._rowNum === existingP._rowNum);
        if (i !== -1) {
            d._sheet = packages[i]._sheet;
            d._rowNum = packages[i]._rowNum;
            packages[i] = {...packages[i], ...d};
            // Оновлюємо на сервері
            updatePackageOnServer(packages[i]);
        }
    } else {
        packages.unshift(d);
        // Додаємо на сервер
        savePackageToServer(d);
    }
    
    editingId = null;
    saveSettings(); 
    closeModal('packageModal'); 
    render(); 
    updateVehiclesList(); 
    updateAllCounts(); 
    renderCalendars(); 
}

// COLUMNS
function openColumnsModal() { renderColumnsList(); document.getElementById('columnsModal').classList.add('show'); }
function renderColumnsList() {
    const keys = Object.keys(ALL_COLUMNS);
    document.getElementById('headerColList').innerHTML = keys.map(k =>
        `<div class="column-item" style="display:flex;align-items:center;gap:8px;">
            <input type="checkbox" ${colSettings.header.includes(k)?'checked':''} onclick="event.stopPropagation();toggleHeaderCol('${k}')">
            <input type="text" value="${ALL_COLUMNS[k].label}"
                onclick="event.stopPropagation();"
                onchange="renameColumnLabel('${k}', this.value)"
                style="flex:1;border:1px solid transparent;border-radius:4px;padding:2px 6px;font-size:12px;font-family:inherit;background:transparent;cursor:text;"
                onfocus="this.style.borderColor='var(--primary)';this.style.background='white';"
                onblur="this.style.borderColor='transparent';this.style.background='transparent';">
        </div>`
    ).join('');
    document.getElementById('detailsColList').innerHTML = keys.map(k => {
        const inH = colSettings.header.includes(k);
        return `<div class="column-item ${inH?'disabled':''}" style="display:flex;align-items:center;gap:8px;">
            <input type="checkbox" ${colSettings.details.includes(k)&&!inH?'checked':''} ${inH?'disabled':''} onclick="event.stopPropagation();${inH?'':`toggleDetailsCol('${k}')`}">
            <input type="text" value="${ALL_COLUMNS[k].label}${inH?' (заг)':''}"
                onclick="event.stopPropagation();"
                ${inH ? 'disabled' : `onchange="renameColumnLabel('${k}', this.value)"`}
                style="flex:1;border:1px solid transparent;border-radius:4px;padding:2px 6px;font-size:12px;font-family:inherit;background:transparent;cursor:text;${inH?'opacity:0.5;cursor:default;':''}">
        </div>`;
    }).join('');
}

function renameColumnLabel(key, newLabel) {
    if (newLabel && newLabel.trim() && ALL_COLUMNS[key]) {
        ALL_COLUMNS[key].label = newLabel.trim().replace(' (заг)', '');
        saveSettings();
    }
}
function toggleHeaderCol(k) { 
    const i = colSettings.header.indexOf(k); 
    i !== -1 ? colSettings.header.splice(i,1) : colSettings.header.push(k); 
    renderColumnsList(); 
}
function toggleDetailsCol(k) { 
    if(colSettings.header.includes(k)) return; 
    const i = colSettings.details.indexOf(k); 
    i === -1 ? colSettings.details.push(k) : colSettings.details.splice(i,1); 
    renderColumnsList(); 
}
function resetColumnsSettings() {
    colSettings = {
        header: ['name','phone','seats','from','to','date','payment'],
        details: ['percent','note','mark','dispatcher','phoneReg','timing','dateReg','weight']
    };
    renderColumnsList();
    showToast('🔄 Скинуто');
}
function saveColumnsSettings() { 
    saveSettings(); 
    closeModal('columnsModal'); 
    render(); 
    showToast('✅ Колонки збережено'); 
}

// === INLINE SAVE — швидке редагування полів прямо на картці ===
function inlineSave(uid, field, value) {
    const p = findPackageByUid(uid);
    if (!p) return;

    // Оновлюємо локально
    p[field] = value;
    saveSettings();

    // Показуємо індикатор збереження
    const indId = 'saveInd_' + uid.replace(/[^a-zA-Z0-9]/g, '_');
    const ind = document.getElementById(indId);
    if (ind) { ind.classList.add('show'); setTimeout(() => ind.classList.remove('show'), 1500); }

    // Анімація поля
    const card = document.querySelector(`[data-uid="${uid}"]`);
    if (card) {
        const activeEl = document.activeElement;
        if (activeEl && activeEl.closest && activeEl.closest('.inline-edit-field')) {
            activeEl.closest('.inline-edit-field').classList.add('saved');
            setTimeout(() => activeEl.closest('.inline-edit-field')?.classList.remove('saved'), 600);
        }
    }

    // Зберігаємо на сервері
    if (p._sheet && p._rowNum) {
        fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain' },
            body: JSON.stringify({
                action: 'updateField',
                sheet: p._sheet,
                rowNum: p._rowNum,
                field: field,
                value: value
            })
        })
        .then(r => r.json())
        .then(data => {
            if (!data.success) console.warn('Inline save error:', data.error);
        })
        .catch(err => console.error('Inline save error:', err));
    }

    // Оновлюємо заголовок картки без повного ре-рендеру (для key fields)
    if (['weight','amount','number','vehicle','name','phone','address','ttn'].includes(field)) {
        // re-render for header fields
        render();
    }

    updateAllCounts();
}

// === TTN MULTI-VALUE FUNCTIONS ===
function updateTtnList(uid) {
    const p = findPackageByUid(uid);
    if (!p) return;
    const safeId = uid.replace(/[^a-zA-Z0-9]/g, '_');
    const container = document.getElementById('ttnList_' + safeId);
    if (!container) return;
    const inputs = container.querySelectorAll('.inline-edit-input');
    const vals = [];
    inputs.forEach(inp => { if (inp.value.trim()) vals.push(inp.value.trim()); });
    const newTtn = vals.join(', ');
    inlineSave(uid, 'ttn', newTtn);
}

function addTtnItem(uid) {
    const safeId = uid.replace(/[^a-zA-Z0-9]/g, '_');
    const container = document.getElementById('ttnList_' + safeId);
    if (!container) return;
    const div = document.createElement('div');
    div.style.cssText = 'display:flex;gap:4px;align-items:center;';
    div.innerHTML = `<input class="inline-edit-input" style="flex:1;" value="" placeholder="ТТН..." onchange="updateTtnList('${uid}')" onclick="event.stopPropagation()">
        <button class="copy-btn-mini" onclick="event.stopPropagation();this.parentElement.remove();updateTtnList('${uid}')" title="Видалити" style="opacity:0.7;color:var(--danger);">✕</button>`;
    container.appendChild(div);
    div.querySelector('input').focus();
}

function removeTtnItem(uid, index) {
    const safeId = uid.replace(/[^a-zA-Z0-9]/g, '_');
    const container = document.getElementById('ttnList_' + safeId);
    if (!container) return;
    const items = container.children;
    if (items[index]) items[index].remove();
    updateTtnList(uid);
}

// === RESTORE PACKAGE TO ORIGINAL STATE ===
function restorePackageToOriginal(uid) {
    const p = findPackageByUid(uid);
    if (!p) return;

    if (!confirm('Відновити лід до початкового стану?\nВсі внесені зміни будуть скинуті.')) return;

    // Зберігаємо тільки основні ідентифікатори
    const keepFields = ['id', '_sheet', '_rowNum', 'direction', 'isNew', 'isNew24h', 'dateReg'];

    // Скидаємо статус до new
    p.status = 'new';
    p.statusDate = '';

    // Очищаємо поля що міг змінити менеджер
    const clearFields = ['vehicle', 'vo', 'number', 'note', 'smsNote', 'timing', 'dateReceive', 'photo', 'order'];
    clearFields.forEach(f => { p[f] = ''; });

    // Якщо є серверні дані — оновлюємо на сервері
    if (p._sheet && p._rowNum) {
        showLoader('Відновлення...', '');
        fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain' },
            body: JSON.stringify({
                action: 'bulkUpdateStatus',
                items: [{ sheet: p._sheet, rowNum: p._rowNum }],
                status: 'new'
            })
        })
        .then(r => r.json())
        .then(data => {
            hideLoader();
            if (!data.success) console.warn('Restore error:', data.error);
        })
        .catch(err => { hideLoader(); console.error('Restore error:', err); });
    }

    openActionsId = null;
    saveSettings();
    render();
    updateAllCounts();
    showToast('↩️ Лід відновлено до початкового стану');
}

// Копіювання в буфер обміну
function copyToClip(text, btn) {
    if (!text || text === '—') return;
    navigator.clipboard.writeText(text).then(() => {
        if (btn) { btn.classList.add('copied'); btn.textContent = '✓'; setTimeout(() => { btn.classList.remove('copied'); btn.textContent = '📋'; }, 1200); }
        showToast('📋 Скопійовано: ' + text);
    }).catch(() => {
        // Fallback
        const ta = document.createElement('textarea');
        ta.value = text; ta.style.position = 'fixed'; ta.style.opacity = '0';
        document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
        if (btn) { btn.classList.add('copied'); btn.textContent = '✓'; setTimeout(() => { btn.classList.remove('copied'); btn.textContent = '📋'; }, 1200); }
        showToast('📋 Скопійовано: ' + text);
    });
}

// Оновлення заголовка картки без повного ре-рендеру
function updateCardHeader(uid, p) {
    const card = document.querySelector(`[data-uid="${uid}"]`);
    if (!card) return;
    const priceEl = card.querySelector('.card-price');
    if (priceEl) priceEl.textContent = p.amount ? '€' + p.amount : '';
    const seatsEl = card.querySelector('.card-seats');
    if (seatsEl) seatsEl.textContent = p.weight ? p.weight + ' кг' : '';
}

// ============================================
// SCANNER — Камера + Штрих-код + OCR
// ============================================

let scannerStream = null;
let currentFacingMode = 'environment'; // задня камера
let capturedImageData = null;
let tesseractReady = false;
let tesseractWorker = null;

// --- Add Popup ---
function toggleAddPopup() {
    const popup = document.getElementById('addPopup');
    popup.classList.toggle('show');
    // Закрити по кліку зовні
    if (popup.classList.contains('show')) {
        setTimeout(() => document.addEventListener('click', closeAddPopupOutside), 10);
    }
}
function closeAddPopup() {
    document.getElementById('addPopup').classList.remove('show');
    document.removeEventListener('click', closeAddPopupOutside);
}
function closeAddPopupOutside(e) {
    if (!e.target.closest('.add-popup') && !e.target.closest('.nav-item')) closeAddPopup();
}

// --- Scanner Open/Close ---
function openScanner() {
    document.getElementById('scannerOverlay').classList.add('show');
    document.getElementById('scannerPreview').classList.remove('show');
    startCamera();
    // Підвантажуємо Tesseract.js якщо ще не завантажений
    if (!tesseractReady) loadTesseract();
}

function closeScanner() {
    document.getElementById('scannerOverlay').classList.remove('show');
    stopCamera();
}

// --- Camera ---
let cameraReady = false;

async function startCamera() {
    cameraReady = false;
    updateCameraStatus('loading');

    try {
        // Check secure context
        if (!window.isSecureContext) {
            updateCameraStatus('error', 'Камера потребує HTTPS. Відкрийте сайт через https://');
            return;
        }

        // Check if API available
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            updateCameraStatus('error', 'Ваш браузер не підтримує камеру');
            return;
        }

        // Check permission state
        try {
            const permResult = await navigator.permissions.query({ name: 'camera' });
            if (permResult.state === 'denied') {
                updateCameraStatus('error', 'Камера заблокована. Дозвольте камеру в налаштуваннях браузера (іконка 🔒 зліва від адреси)');
                return;
            }
        } catch(e) { /* permissions API not supported, proceed anyway */ }

        if (scannerStream) stopCamera();

        scannerStream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: currentFacingMode, width: { ideal: 1920 }, height: { ideal: 1080 } },
            audio: false
        });

        const video = document.getElementById('scannerVideo');
        video.srcObject = scannerStream;

        // Wait for video to be ready
        await new Promise((resolve, reject) => {
            video.onloadedmetadata = () => {
                video.play().then(resolve).catch(reject);
            };
            video.onerror = reject;
            setTimeout(() => reject(new Error('Таймаут камери')), 10000);
        });

        // Wait one more frame for dimensions
        await new Promise(r => requestAnimationFrame(r));

        cameraReady = true;
        updateCameraStatus('ready');

    } catch(err) {
        console.error('Camera error:', err);
        let msg = 'Не вдалось відкрити камеру';
        if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
            msg = 'Ви відхилили доступ до камери. Натисніть 🔒 біля адресного рядка → Дозволити камеру → Оновити сторінку';
        } else if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') {
            msg = 'Камеру не знайдено на цьому пристрої';
        } else if (err.name === 'NotReadableError' || err.name === 'TrackStartError') {
            msg = 'Камера зайнята іншим додатком. Закрийте інші програми з камерою';
        } else if (err.name === 'OverconstrainedError') {
            msg = 'Не вдалось знайти камеру з такими параметрами. Спробуйте перемкнути камеру';
        }
        updateCameraStatus('error', msg);
    }
}

function updateCameraStatus(state, message) {
    let overlay = document.getElementById('cameraStatusOverlay');
    if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'cameraStatusOverlay';
        overlay.style.cssText = 'position:absolute;top:0;left:0;right:0;bottom:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,0.85);z-index:3;color:white;text-align:center;padding:20px;gap:12px;';
        document.querySelector('.scanner-video-wrap').appendChild(overlay);
    }

    if (state === 'ready') {
        overlay.style.display = 'none';
        return;
    }

    overlay.style.display = 'flex';

    if (state === 'loading') {
        overlay.innerHTML = '<div style="font-size:40px;animation:spin 1s linear infinite;">⏳</div><div style="font-size:14px;font-weight:600;">Камера завантажується...</div><div style="font-size:11px;opacity:0.7;">Дозвольте доступ до камери у спливаючому вікні</div>';
    } else if (state === 'error') {
        overlay.innerHTML = `<div style="font-size:40px;">📷</div><div style="font-size:14px;font-weight:600;max-width:280px;">${message}</div><button onclick="startCamera()" style="margin-top:8px;padding:10px 24px;border:none;border-radius:8px;background:var(--info);color:white;font-size:13px;font-weight:700;cursor:pointer;font-family:inherit;">🔄 Спробувати знову</button>`;
    }
}

function stopCamera() {
    cameraReady = false;
    if (scannerStream) {
        scannerStream.getTracks().forEach(t => t.stop());
        scannerStream = null;
    }
    const video = document.getElementById('scannerVideo');
    if (video) { video.srcObject = null; video.onloadedmetadata = null; video.onerror = null; }
    const overlay = document.getElementById('cameraStatusOverlay');
    if (overlay) overlay.style.display = 'none';
}

function switchCamera() {
    currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';
    startCamera();
    showToast(currentFacingMode === 'environment' ? '📷 Задня камера' : '🤳 Передня камера');
}

// --- Capture Photo ---
function capturePhoto() {
    const video = document.getElementById('scannerVideo');
    const canvas = document.getElementById('scannerCanvas');
    if (!cameraReady || !video || !video.videoWidth) return showToast('⚠️ Камера ще завантажується...');

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0);

    capturedImageData = canvas.toDataURL('image/jpeg', 0.9);

    // Показуємо превʼю
    document.getElementById('scannerPreviewImg').src = capturedImageData;
    document.getElementById('scannerPreview').classList.add('show');

    showToast('📸 Фото зроблено!');
}

function retakePhoto() {
    capturedImageData = null;
    document.getElementById('scannerPreview').classList.remove('show');
}

function usePhoto() {
    // Закриваємо сканер
    closeScanner();

    // Запускаємо повне розпізнавання
    showLoader('Розпізнавання...', 'Штрих-код + текст');
    runFullRecognition(capturedImageData);
}

// --- Barcode Detection (live, without photo) ---
async function scanBarcode() {
    const video = document.getElementById('scannerVideo');
    if (!cameraReady || !video || !video.videoWidth) return showToast('⚠️ Камера ще завантажується...');

    // Спробуємо вбудований Barcode Detection API (Chrome/Android)
    if ('BarcodeDetector' in window) {
        try {
            const detector = new BarcodeDetector({ formats: ['code_128', 'code_39', 'ean_13', 'ean_8', 'qr_code', 'itf', 'codabar'] });
            const barcodes = await detector.detect(video);
            if (barcodes.length > 0) {
                const val = barcodes[0].rawValue;
                showToast('✅ Штрих-код: ' + val);
                closeScanner();
                prefillFormFromScan({ ttn: val });
                return;
            }
        } catch(e) {
            console.warn('BarcodeDetector error:', e);
        }
    }

    // Fallback: зробити фото і шукати через canvas
    const canvas = document.getElementById('scannerCanvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video, 0, 0);

    if ('BarcodeDetector' in window) {
        try {
            const detector = new BarcodeDetector();
            const barcodes = await detector.detect(canvas);
            if (barcodes.length > 0) {
                const val = barcodes[0].rawValue;
                showToast('✅ Штрих-код: ' + val);
                closeScanner();
                prefillFormFromScan({ ttn: val });
                return;
            }
        } catch(e) {}
    }

    showToast('📊 Штрих-код не знайдено. Спробуйте ближче навести камеру.');
}

// --- Tesseract.js OCR ---
function loadTesseract() {
    if (tesseractReady) return;
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js';
    script.onload = async () => {
        tesseractReady = true;
        console.log('Tesseract.js loaded');
    };
    document.head.appendChild(script);
}

async function runOCR(imageData) {
    if (!tesseractReady || !window.Tesseract) {
        throw new Error('Tesseract not loaded');
    }

    const result = await Tesseract.recognize(imageData, 'ukr+eng', {
        logger: m => {
            if (m.status === 'recognizing text') {
                const pct = Math.round((m.progress || 0) * 100);
                const loader = document.getElementById('loaderProgress');
                if (loader) loader.textContent = `OCR: ${pct}%`;
            }
        }
    });

    return result.data.text;
}

// --- Full Recognition: Barcode + OCR + Parse ---
async function runFullRecognition(imageData) {
    const parsed = {};

    // 1. Штрих-код
    if ('BarcodeDetector' in window) {
        try {
            const img = new Image();
            img.src = imageData;
            await new Promise(r => img.onload = r);
            const detector = new BarcodeDetector();
            const barcodes = await detector.detect(img);
            if (barcodes.length > 0) {
                parsed.ttn = barcodes[0].rawValue;
            }
        } catch(e) {
            console.warn('Barcode from image failed:', e);
        }
    }

    // 2. OCR
    try {
        const text = await runOCR(imageData);
        console.log('OCR result:', text);

        // Парсимо текст
        const ocrParsed = parseOCRText(text);
        Object.assign(parsed, ocrParsed);
    } catch(e) {
        console.error('OCR error:', e);
    }

    // 3. Фото URL (base64)
    parsed.photo = imageData;

    hideLoader();

    if (Object.keys(parsed).length <= 1) {
        showToast('⚠️ Не вдалось розпізнати дані. Заповніть вручну.');
    } else {
        const fields = [];
        if (parsed.ttn) fields.push('ТТН');
        if (parsed.phone) fields.push('Тел');
        if (parsed.name) fields.push('ПіБ');
        if (parsed.address) fields.push('Адреса');
        showToast('✅ Знайдено: ' + fields.join(', '));
    }

    prefillFormFromScan(parsed);
}

// --- Parse OCR Text ---
function parseOCRText(text) {
    const result = {};
    if (!text) return result;

    const lines = text.split('\n').map(l => l.trim()).filter(Boolean);

    // Телефон: шукаємо послідовність 10-13 цифр з можливим +
    const phoneRegex = /(?:\+?\d[\d\s\-()]{8,14}\d)/g;
    const phones = text.match(phoneRegex);
    if (phones && phones.length) {
        // Перший — отримувач, другий — реєстратор
        result.phone = phones[0].replace(/[\s\-()]/g, '');
        if (phones.length > 1) {
            result.phoneReg = phones[1].replace(/[\s\-()]/g, '');
        }
    }

    // ТТН: послідовність 10+ цифр (якщо ще не знайдений через barcode)
    if (!result.ttn) {
        const ttnRegex = /\b(\d{10,20})\b/g;
        const ttns = text.match(ttnRegex);
        if (ttns) {
            // ТТН зазвичай довший за телефон або відрізняється
            for (const t of ttns) {
                if (t !== result.phone && t !== result.phoneReg && t.length >= 10) {
                    result.ttn = t;
                    break;
                }
            }
        }
    }

    // Вага: шукаємо "X кг" або "X kg" або "вага: X"
    const weightRegex = /(\d+[.,]?\d*)\s*(?:кг|kg|КГ)/i;
    const weightMatch = text.match(weightRegex);
    if (weightMatch) result.weight = weightMatch[1].replace(',', '.');

    // Сума: шукаємо "X €" або "X грн" або "сума: X"
    const amountRegex = /(\d+[.,]?\d*)\s*(?:€|EUR|євро|грн|UAH)/i;
    const amountMatch = text.match(amountRegex);
    if (amountMatch) result.amount = amountMatch[1].replace(',', '.');

    // Адреса: шукаємо рядки з "вул", "м.", "обл", "район", або просто довгий рядок з цифрами (номер будинку)
    const addressKeywords = /(?:вул|пр|просп|бульв|м\.|обл|район|село|смт|буд|кв\.|пров)/i;
    for (const line of lines) {
        if (addressKeywords.test(line) && line.length > 10) {
            result.address = line;
            break;
        }
    }

    // ПіБ: шукаємо рядки з 2-3 словами з великої літери (кирилиця)
    const nameRegex = /^[А-ЯІЇЄҐ][а-яіїєґ']+\s+[А-ЯІЇЄҐ][а-яіїєґ']+(?:\s+[А-ЯІЇЄҐ][а-яіїєґ']+)?$/;
    for (const line of lines) {
        if (nameRegex.test(line.trim()) && line.length < 60) {
            result.name = line.trim();
            break;
        }
    }

    return result;
}

// --- Prefill Add Form ---
function prefillFormFromScan(data) {
    openAddModal();

    if (data.ttn) document.getElementById('fTtn').value = data.ttn;
    if (data.phone) document.getElementById('fPhone').value = data.phone;
    if (data.phoneReg) document.getElementById('fPhoneReg').value = data.phoneReg;
    if (data.name) document.getElementById('fName').value = data.name;
    if (data.address) document.getElementById('fAddress').value = data.address;
    if (data.weight) document.getElementById('fWeight').value = data.weight;
    if (data.amount) document.getElementById('fAmount').value = data.amount;

    // Підсвічуємо заповнені поля
    ['fTtn','fPhone','fPhoneReg','fName','fAddress','fWeight','fAmount'].forEach(id => {
        const el = document.getElementById(id);
        if (el && el.value) {
            el.style.background = '#d1fae5';
            el.style.borderColor = '#10b981';
            setTimeout(() => { el.style.background = ''; el.style.borderColor = ''; }, 3000);
        }
    });
}

// === МАСОВЕ ПРИЗНАЧЕННЯ СТАТУСУ ПОСИЛКИ ===
function bulkSetParcelStatus() {
    if (selectedIds.size === 0) return showToast('⚠️ Оберіть заявки');
    showBulkParcelStatusModal();
}

function showBulkParcelStatusModal() {
    document.getElementById('bulkParcelStatusModal')?.remove();

    const modal = document.createElement('div');
    modal.className = 'modal-overlay show';
    modal.id = 'bulkParcelStatusModal';
    modal.onclick = function(e) { if (e.target === this) this.remove(); };
    modal.innerHTML = `
        <div class="modal" style="max-width:400px;">
            <div class="modal-header" style="background:linear-gradient(135deg,var(--info),var(--primary));">
                <span class="modal-title" style="color:white;">📦 Статус посилки (${selectedIds.size})</span>
                <button class="modal-close" onclick="document.getElementById('bulkParcelStatusModal').remove()" style="color:white;">✕</button>
            </div>
            <div class="modal-body" style="padding:16px;">
                <div style="display:flex;flex-direction:column;gap:8px;">
                    <button class="btn-save" style="background:#6b7280;" onclick="applyBulkParcelStatus('Невідомий')">Невідомий</button>
                    <button class="btn-save" style="background:var(--info);" onclick="applyBulkParcelStatus('Зареєстровано')">Зареєстровано</button>
                    <button class="btn-save" style="background:var(--warning);" onclick="applyBulkParcelStatus('Оформлено')">Оформлено</button>
                    <button class="btn-save" style="background:var(--purple);" onclick="applyBulkParcelStatus('Кордон')">Кордон</button>
                    <button class="btn-save" style="background:var(--success);" onclick="applyBulkParcelStatus('Доставка')">Доставка</button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function applyBulkParcelStatus(status) {
    document.getElementById('bulkParcelStatusModal')?.remove();

    const items = [];
    selectedIds.forEach(uid => {
        const p = findPackageByUid(uid);
        if (p) {
            p.parcelStatus = status;
            if (p._sheet && p._rowNum) {
                items.push({ sheet: p._sheet, rowNum: p._rowNum });
            }
        }
    });

    saveSettings();

    // Зберігаємо на сервері масово
    if (items.length > 0) {
        showLoader('Оновлюю статус...', '');
        // Update each item individually since API doesn't have bulk field update
        let completed = 0;
        items.forEach(item => {
            fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({
                    action: 'updateField',
                    sheet: item.sheet,
                    rowNum: item.rowNum,
                    field: 'parcelStatus',
                    value: status
                })
            })
            .then(r => r.json())
            .then(() => {
                completed++;
                if (completed >= items.length) hideLoader();
            })
            .catch(() => {
                completed++;
                if (completed >= items.length) hideLoader();
            });
        });
    }

    clearSelection();
    render();
    updateAllCounts();
    showToast(`📦 Статус "${status}" → ${selectedIds.size || items.length} посилок`);
}

// === МАСОВЕ ПРИЗНАЧЕННЯ ПРИМІТКИ СМС ===
function bulkSetSmsNote() {
    if (selectedIds.size === 0) return showToast('⚠️ Оберіть заявки');
    document.getElementById('bulkSmsNoteModal')?.remove();
    const modal = document.createElement('div');
    modal.className = 'modal-overlay show';
    modal.id = 'bulkSmsNoteModal';
    modal.onclick = function(e) { if (e.target === this) this.remove(); };
    modal.innerHTML = `
        <div class="modal" style="max-width:420px;">
            <div class="modal-header" style="background:linear-gradient(135deg,#7c3aed,var(--primary));">
                <span class="modal-title" style="color:white;">💬 Примітка СМС (${selectedIds.size})</span>
                <button class="modal-close" onclick="document.getElementById('bulkSmsNoteModal').remove()" style="color:white;">✕</button>
            </div>
            <div class="modal-body" style="padding:16px;">
                <div class="form-group"><label style="font-weight:600;font-size:12px;">Текст примітки СМС</label>
                <textarea id="bulkSmsNoteText" rows="3" style="width:100%;border:1px solid var(--border);border-radius:8px;padding:10px;font-family:inherit;font-size:13px;resize:vertical;" placeholder="Введіть текст примітки СМС..."></textarea></div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="document.getElementById('bulkSmsNoteModal').remove()">Скасувати</button>
                <button class="btn-save" onclick="applyBulkSmsNote()">💬 Застосувати</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    setTimeout(() => document.getElementById('bulkSmsNoteText')?.focus(), 100);
}

function applyBulkSmsNote() {
    const text = document.getElementById('bulkSmsNoteText')?.value || '';
    document.getElementById('bulkSmsNoteModal')?.remove();
    const items = [];
    selectedIds.forEach(uid => {
        const p = findPackageByUid(uid);
        if (p) {
            p.smsNote = text;
            if (p._sheet && p._rowNum) items.push({ sheet: p._sheet, rowNum: p._rowNum });
        }
    });
    saveSettings();
    if (items.length > 0) {
        showLoader('Оновлюю...', '');
        let done = 0;
        items.forEach(item => {
            fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({ action: 'updateField', sheet: item.sheet, rowNum: item.rowNum, field: 'smsNote', value: text })
            }).then(r => r.json()).then(() => { done++; if (done >= items.length) hideLoader(); }).catch(() => { done++; if (done >= items.length) hideLoader(); });
        });
    }
    const cnt = selectedIds.size;
    clearSelection(); render(); updateAllCounts();
    showToast(`💬 Примітка СМС → ${cnt} посилок`);
}

// === МАСОВЕ ПРИЗНАЧЕННЯ ДАТИ ОТРИМАННЯ ===
function bulkSetDateReceive() {
    if (selectedIds.size === 0) return showToast('⚠️ Оберіть заявки');
    document.getElementById('bulkDateReceiveModal')?.remove();
    const today = new Date().toISOString().split('T')[0];
    const modal = document.createElement('div');
    modal.className = 'modal-overlay show';
    modal.id = 'bulkDateReceiveModal';
    modal.onclick = function(e) { if (e.target === this) this.remove(); };
    modal.innerHTML = `
        <div class="modal" style="max-width:380px;">
            <div class="modal-header" style="background:linear-gradient(135deg,var(--success),var(--primary));">
                <span class="modal-title" style="color:white;">📅 Дата отримання (${selectedIds.size})</span>
                <button class="modal-close" onclick="document.getElementById('bulkDateReceiveModal').remove()" style="color:white;">✕</button>
            </div>
            <div class="modal-body" style="padding:16px;">
                <div class="form-group"><label style="font-weight:600;font-size:12px;">Дата отримання</label>
                <input type="date" id="bulkDateReceiveVal" value="${today}" style="width:100%;border:1px solid var(--border);border-radius:8px;padding:10px;font-family:inherit;font-size:14px;font-weight:600;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="document.getElementById('bulkDateReceiveModal').remove()">Скасувати</button>
                <button class="btn-save" onclick="applyBulkDateReceive()">📅 Застосувати</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function applyBulkDateReceive() {
    const dateVal = document.getElementById('bulkDateReceiveVal')?.value || '';
    document.getElementById('bulkDateReceiveModal')?.remove();
    if (!dateVal) return showToast('⚠️ Оберіть дату');
    const items = [];
    selectedIds.forEach(uid => {
        const p = findPackageByUid(uid);
        if (p) {
            p.dateReceive = dateVal;
            if (p._sheet && p._rowNum) items.push({ sheet: p._sheet, rowNum: p._rowNum });
        }
    });
    saveSettings();
    if (items.length > 0) {
        showLoader('Оновлюю...', '');
        let done = 0;
        items.forEach(item => {
            fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({ action: 'updateField', sheet: item.sheet, rowNum: item.rowNum, field: 'dateReceive', value: dateVal })
            }).then(r => r.json()).then(() => { done++; if (done >= items.length) hideLoader(); }).catch(() => { done++; if (done >= items.length) hideLoader(); });
        });
    }
    const cnt = selectedIds.size;
    clearSelection(); render(); updateAllCounts(); renderCalendars();
    showToast(`📅 Дата отримання → ${cnt} посилок`);
}

function closeModal(id) { document.getElementById(id).classList.remove('show'); }
function showToast(m) { const t = document.getElementById('toast'); t.textContent = m; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2000); }

// DIRECTION FILTER
function toggleDirectionPopup() {
    document.getElementById('directionPopup').classList.toggle('show');
}

function setDirection(dir) {
    filters.direction = dir;
    filters.showNewOnly = false; // Вимикаємо фільтр "Нові"
    
    // Виходимо з режиму маршруту та спеціальних статусів
    filters.statusFilter = '';
    filters.routeVehicle = '';
    filters.specialStatus = '';
    filters.showArchive = false;
    routePassengers = [];
    routeStats = { total: 0, pending: 0, inProgress: 0, completed: 0, cancelled: 0, archived: 0 };
    currentRouteVehicle = null;
    routeStatusFilter = 'all';
    
    document.getElementById('directionPopup')?.classList.remove('show');
    
    // Оновлюємо активні стани
    document.querySelectorAll('.direction-option').forEach(el => {
        el.classList.toggle('active', el.dataset.dir === dir);
    });
    
    // Оновлюємо мобільні
    document.getElementById('mobileDirectionAll')?.classList.toggle('active', dir === 'all');
    document.getElementById('mobileDirectionUaEu')?.classList.toggle('active', dir === 'ua-eu');
    document.getElementById('mobileDirectionEuUa')?.classList.toggle('active', dir === 'eu-ua');
    document.getElementById('mobileNewLeads')?.classList.remove('active');
    
    // Оновлюємо PC sidebar
    document.getElementById('pcDirectionAll')?.classList.toggle('active', dir === 'all');
    document.getElementById('pcDirectionUaEu')?.classList.toggle('active', dir === 'ua-eu');
    document.getElementById('pcDirectionEuUa')?.classList.toggle('active', dir === 'eu-ua');
    document.getElementById('pcNewLeads')?.classList.remove('active');
    
    // Оновлюємо label
    const labels = {'all': 'Пасажири', 'ua-eu': '🇺🇦→🇪🇺', 'eu-ua': '🇪🇺→🇺🇦'};
    const navLabel = document.getElementById('navPackagesLabel');
    if (navLabel) navLabel.textContent = labels[dir] || 'Пасажири';
    
    render();
    updateVehiclesList();
    updateAllCounts();
}

// Показати тільки нові ліди (за останні 24 години)
function showNewLeads() {
    filters.showNewOnly = true;
    filters.direction = 'all';
    filters.statusFilter = '';
    filters.routeVehicle = '';
    filters.specialStatus = '';
    filters.showArchive = false;
    filters.date = '';
    filters.vehicle = '';
    routePassengers = [];
    
    // Оновлюємо активні стани
    document.getElementById('mobileDirectionAll')?.classList.remove('active');
    document.getElementById('mobileDirectionUaEu')?.classList.remove('active');
    document.getElementById('mobileDirectionEuUa')?.classList.remove('active');
    document.getElementById('mobileNewLeads')?.classList.add('active');
    
    document.getElementById('pcDirectionAll')?.classList.remove('active');
    document.getElementById('pcDirectionUaEu')?.classList.remove('active');
    document.getElementById('pcDirectionEuUa')?.classList.remove('active');
    document.getElementById('pcNewLeads')?.classList.add('active');
    
    const navLabel = document.getElementById('navPackagesLabel');
    if (navLabel) navLabel.textContent = '🆕 Нові';
    
    render();
    updateAllCounts();
    showToast('🆕 Нові заявки за 24 год');
}

// ============================================
// MAP MODAL
// ============================================
let currentMapPassengerId = null;

function openMapModal(uid) {
    const p = findPackageByUid(uid);
    if (!p) return;
    
    currentMapPassengerId = uid;

    document.getElementById('mapFromAddress').textContent = p.address || '—';
    document.getElementById('mapToAddress').textContent = '—';
    document.getElementById('mapRouteAddress').textContent = p.address || '—';

    document.getElementById('mapModal').classList.add('show');
}

function openMapLocation(type) {
    const p = findPackageByUid(currentMapPassengerId);
    if (!p) return;

    let url = '';

    if (type === 'from' && p.address) {
        url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(p.address)}`;
    } else if (type === 'to' && p.address) {
        url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(p.address)}`;
    } else if (type === 'route' && p.address) {
        url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(p.address)}`;
    }
    
    if (url) {
        window.open(url, '_blank');
        closeModal('mapModal');
    } else {
        showToast('❌ Адреса не вказана');
    }
}

// ============================================
// GOOGLE SHEETS API
// ============================================
// 📦 API для посилок — ЗАМІНІТЬ НА СВІЙ URL ПІСЛЯ ДЕПЛОЯ
const API_URL = 'https://script.google.com/macros/s/AKfycby35ZXeqMKfdGJbTZW-TqMslq30tM2ju7It_KWJgSV-aEBti6r_3LD_orYnSy3wGc-yYQ/exec';

// API для маршрутів посилок (підключимо пізніше)
const ROUTE_API_URL = '';

// Нормалізація дати до формату YYYY-MM-DD
function normalizeDate(dateStr) {
    if (!dateStr) return '';
    // Якщо вже в форматі YYYY-MM-DD
    if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) return dateStr;
    // Якщо формат DD.MM.YYYY
    if (/^\d{2}\.\d{2}\.\d{4}$/.test(dateStr)) {
        const [d, m, y] = dateStr.split('.');
        return `${y}-${m}-${d}`;
    }
    // Якщо це Date об'єкт або ISO string
    try {
        const d = new Date(dateStr);
        if (!isNaN(d.getTime())) {
            return d.toISOString().split('T')[0];
        }
    } catch(e) {}
    return '';
}

// SYNC - Отримати всі посилки (POST запит!)
function syncWithSheets() {
    showLoader('Синхронізація посилок...', '');
    
    fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({ action: 'getAll' })
    })
    .then(r => r.json())
    .then(data => {
        hideLoader();
        if (data.success) {
            packages = data.packages.map(p => ({
                id: p.id || 'srv_' + p.rowNum,
                vo: p.vo || '',
                number: p.number || '',
                ttn: p.ttn || '',
                weight: p.weight || '',
                address: p.address || '',
                directionRaw: p.directionRaw || '',
                direction: p.direction || 'ua-eu',
                phone: p.phone || '',
                amount: p.amount || '',
                payStatus: p.payStatus || '',
                payment: p.payment || '',
                phoneReg: p.phoneReg || '',
                note: p.note || '',
                parcelStatus: p.parcelStatus || '',
                name: p.name || '',
                dateReg: p.dateReg || '',
                timing: p.timing || '',
                smsNote: p.smsNote || '',
                dateReceive: p.dateReceive || '',
                photo: p.photo || '',
                status: (p.status || '').toLowerCase().trim(),
                dateArchive: p.dateArchive || '',
                isNew: p.isNew || false,
                vehicle: p.vehicle || '',
                _sheet: p.sheet,
                _rowNum: p.rowNum
            }));
            saveSettings();
            render();
            updateAllCounts();
            renderCalendars();
            showToast(`✅ Завантажено: ${packages.length} посилок`);
        } else {
            showToast('❌ ' + (data.error || 'Помилка'));
        }
    })
    .catch(err => {
        hideLoader();
        console.error('Sync error:', err);
        showToast('❌ Помилка зв\'язку');
    });
}

// SAVE - Додати нового пасажира на сервер
function savePackageToServer(pkg) {
    showLoader('Збереження...', '');

    const payload = {
        action: 'addPackage',
        fields: {
            direction: pkg.direction,
            vo: pkg.vo || '',
            number: pkg.number || '',
            ttn: pkg.ttn || '',
            weight: pkg.weight || '',
            address: pkg.address || '',
            phone: pkg.phone || '',
            amount: pkg.amount || '',
            payStatus: pkg.payStatus || '',
            payment: pkg.payment || '',
            phoneReg: pkg.phoneReg || '',
            note: pkg.note || '',
            parcelStatus: pkg.parcelStatus || '',
            name: pkg.name || '',
            dateReg: pkg.dateReg || '',
            timing: pkg.timing || '',
            smsNote: pkg.smsNote || '',
            dateReceive: pkg.dateReceive || '',
            photo: pkg.photo || '',
            status: pkg.status || ''
        }
    };
    
    fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify(payload)
    })
    .then(r => r.json())
    .then(data => {
        hideLoader();
        if (data.success) {
            // Оновлюємо локальний ID
            const p = packages.find(x => x.id === pkg.id);
            if (p) {
                p.id = data.id;
                p._sheet = data.sheet;
                p._rowNum = data.rowNum;
            }
            saveSettings();
            render();
            showToast('✅ Збережено: ' + data.id);
            
            // Перевіряємо місткість після додавання
            checkAllCapacityWarnings();
        } else {
            showToast('⚠️ Помилка: ' + data.error);
        }
    })
    .catch(err => {
        hideLoader();
        console.error('Save error:', err);
        showToast('⚠️ Збережено локально');
    });
}

// UPDATE - Оновити посилку на сервері
function updatePackageOnServer(pkg) {
    if (!pkg._sheet || !pkg._rowNum) {
        console.warn('Немає _sheet або _rowNum:', pkg);
        showToast('Синхронізуй спочатку');
        return;
    }

    const payload = {
        action: 'updatePackage',
        sheet: pkg._sheet,
        rowNum: pkg._rowNum,
        fields: {
            vo: pkg.vo || '',
            number: pkg.number || '',
            ttn: pkg.ttn || '',
            weight: pkg.weight || '',
            address: pkg.address || '',
            phone: pkg.phone || '',
            amount: pkg.amount || '',
            payStatus: pkg.payStatus || '',
            payment: pkg.payment || '',
            phoneReg: pkg.phoneReg || '',
            note: pkg.note || '',
            parcelStatus: pkg.parcelStatus || '',
            name: pkg.name || '',
            dateReg: pkg.dateReg || '',
            timing: pkg.timing || '',
            smsNote: pkg.smsNote || '',
            dateReceive: pkg.dateReceive || '',
            photo: pkg.photo || '',
            status: pkg.status || ''
        }
    };
    
    fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify(payload)
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showToast('✅ Збережено');
        } else {
            showToast('❌ ' + data.error);
        }
    })
    .catch(err => {
        console.error('❌ Fetch error:', err);
        showToast('❌ Помилка зв\'язку');
    });
}

// Отримати ініціали користувача (поки що заглушка)
function getUserInitials() {
    // TODO: Брати з профілю користувача
    return 'CRM';
}

// Close dropdowns on outside click
document.addEventListener('click', e => { 
    if (!e.target.closest('.dropdown-container')) document.querySelectorAll('.dropdown-menu').forEach(d => d.classList.remove('show')); 
    if (!e.target.closest('.card-vehicle-badge') && !e.target.closest('.vehicle-dropdown')) document.querySelectorAll('.vehicle-dropdown').forEach(d => d.classList.remove('show'));
    if (!e.target.closest('#navPassengers') && !e.target.closest('.direction-popup')) document.getElementById('directionPopup')?.classList.remove('show');
});
</script>
</body>
</html>
